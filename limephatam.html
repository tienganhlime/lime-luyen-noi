<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán Ph√°t √Çm - Trung T√¢m Ti·∫øng Anh LIME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Transformers.js cho Whisper t·ª´ Hugging Face -->
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 50%, #81C784 100%);
        }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .correct-answer { background-color: #C8E6C9 !important; border-color: #4CAF50 !important; }
        .wrong-answer { background-color: #FFCDD2 !important; border-color: #F44336 !important; }
        .reading-text {
            line-height: 1.8;
            font-size: 18px;
        }
        .reading-text p {
            margin-bottom: 1rem;
        }
        label span { font-size: 18px; }
    </style>
</head>
<body class="bg-gray-100">

<!-- Loading Spinner -->
<div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg">
        <div class="animate-spin h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div>
        <p class="mt-4 text-gray-700">ƒêang x·ª≠ l√Ω...</p>
    </div>
</div>

<!-- 1. TRANG ƒêƒÇNG NH·∫¨P -->
<div id="loginScreen" class="screen min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-10 max-w-md w-full">
        <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME Logo" class="w-32 h-32 mx-auto mb-4 object-contain">
        <h1 class="text-4xl font-bold text-center mb-8 text-green-600">üéôÔ∏è Luy·ªán Ph√°t √Çm</h1>
        <div class="space-y-4">
            <button onclick="selectRole('teacher')" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg text-xl font-semibold transition">
                üë®‚Äçüè´ T√¥i l√† Gi√°o vi√™n
            </button>
            <button onclick="selectRole('student')" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg text-xl font-semibold transition">
                üë®‚Äçüéì T√¥i l√† H·ªçc sinh
            </button>
        </div>
    </div>
</div>

<!-- 2. ƒêƒÇNG NH·∫¨P H·ªåC SINH -->
<div id="studentLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
        <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4">‚Üê Quay l·∫°i</button>
        <h2 class="text-3xl font-bold mb-6">ƒêƒÉng nh·∫≠p H·ªçc sinh</h2>
        <input type="text" id="studentCode" placeholder="Nh·∫≠p m√£ h·ªçc sinh (vd: HS001)" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="loginStudent()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
            ƒêƒÉng nh·∫≠p
        </button>
    </div>
</div>

<!-- 3. ƒêƒÇNG NH·∫¨P GI√ÅO VI√äN -->
<div id="teacherLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
        <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4">‚Üê Quay l·∫°i</button>
        <h2 class="text-3xl font-bold mb-6">ƒêƒÉng nh·∫≠p Gi√°o vi√™n</h2>
        <input type="text" id="teacherCode" placeholder="Nh·∫≠p m√£ gi√°o vi√™n (vd: GV001)" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="loginTeacher()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
            ƒêƒÉng nh·∫≠p
        </button>
        <p class="text-sm text-gray-500 mt-4">L·∫ßn ƒë·∫ßu? Nh·∫≠p m√£ b·∫•t k·ª≥ ƒë·ªÉ t·∫°o t√†i kho·∫£n m·ªõi</p>
    </div>
</div>

<!-- 4. DASHBOARD GI√ÅO VI√äN -->
<div id="teacherDashboard" class="screen hidden min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">üë®‚Äçüè´ Dashboard Gi√°o vi√™n</h1>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ƒêƒÉng xu·∫•t</button>
            </div>
            <p class="text-gray-600 mt-2">M√£ GV: <span id="teacherCodeDisplay" class="font-mono font-bold"></span></p>
        </div>
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <button onclick="showCreateClass()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg text-xl font-semibold">
                ‚ûï T·∫°o l·ªõp m·ªõi
            </button>
            <button onclick="showMyClasses()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg text-xl font-semibold">
                üìö Qu·∫£n l√Ω l·ªõp
            </button>
            <button onclick="showAssignments()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg text-xl font-semibold">
                üìù Giao b√†i t·∫≠p
            </button>
        </div>
        <div id="teacherContent" class="bg-white rounded-lg shadow-lg p-6"></div>
    </div>
</div>

<!-- 5. DASHBOARD H·ªåC SINH -->
<div id="studentDashboard" class="screen hidden min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">üë®‚Äçüéì L·ªõp h·ªçc c·ªßa t√¥i</h1>
                    <p class="text-gray-600 mt-2">H·ªçc sinh: <span id="studentNameDisplay" class="font-bold"></span></p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        <div id="studentAssignments" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
</div>

<!-- 6. M√ÄN H√åNH LUY·ªÜN T·∫¨P -->
<div id="practiceScreen" class="screen hidden min-h-screen p-6 bg-gradient-to-br from-indigo-500 to-purple-600">
    <div class="max-w-6xl mx-auto">
        <button onclick="backToStudent()" class="text-white mb-4 text-lg">‚Üê Quay l·∫°i</button>
        <div class="bg-white rounded-lg shadow-2xl p-6 mb-6">
            <h2 id="assignmentTitle" class="text-3xl font-bold mb-2"></h2>
            <div class="flex gap-4 text-sm text-gray-600">
                <span>Ti·∫øn ƒë·ªô: <span id="progressText" class="font-bold">0/0</span></span>
                <span>ƒêi·ªÉm TB: <span id="avgScoreText" class="font-bold">0</span></span>
            </div>
        </div>
        <div id="wordsList" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </div>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, getDoc, setDoc, orderBy, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyB2VOZ0A5im13MC6FNLa4bEupKedm5iiBo",
    authDomain: "lime-phat-am.firebaseapp.com",
    projectId: "lime-phat-am",
    storageBucket: "lime-phat-am.firebasestorage.app",
    messagingSenderId: "434295865710",
    appId: "1:434295865710:web:5f373900f5e8c1d679417f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = null;
let currentAssignment = null;

// ==================== UTILITIES ====================
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
}

// ==================== AUTHENTICATION ====================
window.selectRole = function(role) {
    showScreen(role === 'teacher' ? 'teacherLoginScreen' : 'studentLoginScreen');
}

window.loginTeacher = async function() {
    const code = document.getElementById('teacherCode').value.trim();
    if (!code) return alert('Vui l√≤ng nh·∫≠p m√£ gi√°o vi√™n');
   
    showLoading(true);
    try {
        const teacherRef = doc(db, 'teachers', code);
        const teacherSnap = await getDoc(teacherRef);
       
        if (!teacherSnap.exists()) {
            await setDoc(teacherRef, { code, createdAt: new Date() });
        }
       
        currentUser = { role: 'teacher', code };
        document.getElementById('teacherCodeDisplay').textContent = code;
        showScreen('teacherDashboard');
    } catch (error) {
        alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
    }
    showLoading(false);
}

window.loginStudent = async function() {
    const code = document.getElementById('studentCode').value.trim();
    if (!code) return alert('Vui l√≤ng nh·∫≠p m√£ h·ªçc sinh');
   
    showLoading(true);
    try {
        const studentsRef = collection(db, 'students');
        const q = query(studentsRef, where('code', '==', code));
        const snap = await getDocs(q);
       
        if (snap.empty) {
            showLoading(false);
            return alert('M√£ h·ªçc sinh kh√¥ng t·ªìn t·∫°i. Li√™n h·ªá gi√°o vi√™n!');
        }
       
        const studentData = snap.docs[0].data();
        currentUser = { role: 'student', code, id: snap.docs[0].id, ...studentData };
        document.getElementById('studentNameDisplay').textContent = studentData.name;
        await loadStudentAssignments();
        showScreen('studentDashboard');
    } catch (error) {
        alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
    }
    showLoading(false);
}

window.logout = function() {
    currentUser = null;
    showScreen('loginScreen');
}

// ==================== SYLLABLE ANALYSIS ====================
const syllableDB = {
    'carbohydrate': ['car', 'bo', 'hy', 'drate'],
    'fibre': ['fi', 'bre'],
    'fiber': ['fi', 'ber'],
    'diet': ['di', 'et'],
    'protein': ['pro', 'tein'],
    'vitamin': ['vi', 'ta', 'min'],
    'ship': ['ship'],
    'cat': ['cat'],
    'dog': ['dog'],
    'apple': ['ap', 'ple'],
    'banana': ['ba', 'na', 'na'],
    'orange': ['or', 'ange'],
    'exercise': ['ex', 'er', 'cise'],
    'healthy': ['heal', 'thy'],
    'water': ['wa', 'ter'],
    'something': ['some', 'thing'],
    'weight': ['weight'],
    'stomach': ['stom', 'ach'],
    'upset': ['up', 'set'],
    'casualty': ['cas', 'u', 'al', 'ty'],
    'department': ['de', 'part', 'ment']
};

function splitIntoSyllables(word) {
    const original = word;
    word = word.toLowerCase().trim();
   
    if (syllableDB[word]) return syllableDB[word];
   
    if (word.includes(' ')) {
        const words = word.split(' ').filter(w => w.length > 0);
        let allSyllables = [];
        words.forEach(w => {
            const syls = splitIntoSyllables(w);
            allSyllables = allSyllables.concat(syls);
        });
        return allSyllables;
    }
   
    if (word.length <= 3) return [word];
   
    const vowels = 'aeiouy';
    const syllables = [];
    let start = 0;
   
    for (let i = 1; i < word.length; i++) {
        const prevIsVowel = vowels.includes(word[i - 1]);
        const currIsVowel = vowels.includes(word[i]);
       
        if (prevIsVowel && !currIsVowel && i < word.length - 1) {
            syllables.push(word.substring(start, i + 1));
            start = i + 1;
        }
    }
   
    if (start < word.length) {
        if (syllables.length > 0) {
            const remaining = word.substring(start);
            if (remaining.length <= 2) {
                syllables[syllables.length - 1] += remaining;
            } else {
                syllables.push(remaining);
            }
        } else {
            syllables.push(word.substring(start));
        }
    }
   
    return syllables.length > 0 ? syllables : [word];
}

function similarity(s1, s2) {
    if (!s1 || !s2) return 0;
    let longer = s1.length > s2.length ? s1 : s2;
    let shorter = s1.length > s2.length ? s2 : s1;
    if (longer.length === 0) return 1.0;
    return (longer.length - editDistance(longer, shorter)) / longer.length;
}

function editDistance(s1, s2) {
    s1 = s1.toLowerCase();
    s2 = s2.toLowerCase();
    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i === 0) costs[j] = j;
            else if (j > 0) {
                let newValue = costs[j - 1];
                if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                }
                costs[j - 1] = lastValue;
                lastValue = newValue;
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}

function analyzePronunciation(correctWord, spokenWord) {
    correctWord = correctWord.toLowerCase().trim();
    spokenWord = spokenWord.toLowerCase().trim();
   
    const correctSyllables = splitIntoSyllables(correctWord);
    const spokenSyllables = splitIntoSyllables(spokenWord);
   
    const analysis = { syllables: [], wrongSyllables: [], score: 0 };
   
    correctSyllables.forEach((syllable, index) => {
        const isCorrect = spokenSyllables[index] &&
                         (spokenSyllables[index] === syllable ||
                          similarity(spokenSyllables[index], syllable) > 0.7);
       
        analysis.syllables.push({
            text: syllable,
            correct: isCorrect,
            spoken: spokenSyllables[index] || ''
        });
       
        if (!isCorrect) analysis.wrongSyllables.push(syllable);
    });
   
    const correctCount = analysis.syllables.filter(s => s.correct).length;
    analysis.score = Math.round((correctCount / correctSyllables.length) * 100);
   
    return analysis;
}

function renderSyllableAnalysis(analysis, word) {
    let html = '<div class="mt-4 p-4 bg-gray-50 rounded-lg">';
    html += '<p class="font-bold mb-2">üìä Ph√¢n t√≠ch chi ti·∫øt:</p>';
    html += '<div class="flex flex-wrap gap-2 mb-3">';
   
    analysis.syllables.forEach(syl => {
        const bgColor = syl.correct ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800';
        const icon = syl.correct ? '‚úì' : '‚úó';
        html += `<span class="${bgColor} px-3 py-1 rounded-full font-bold">${icon} ${syl.text}</span>`;
    });
   
    html += '</div>';
   
    if (analysis.wrongSyllables.length > 0) {
        html += `<p class="text-red-600 font-semibold mb-2">‚ùå C·∫ßn luy·ªán l·∫°i: ${analysis.wrongSyllables.join(', ')}</p>`;
        html += `<button onclick="practiceWrongSyllables('${word}', '${JSON.stringify(analysis.wrongSyllables).replace(/'/g, "&apos;")}')"
                        class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 font-semibold mt-2">
                    üéØ Luy·ªán √¢m ti·∫øt sai</button>`;
    } else {
        html += '<p class="text-green-600 font-bold">üéâ T·∫•t c·∫£ √¢m ti·∫øt ƒë·ªÅu ƒë√∫ng!</p>';
    }
   
    html += '</div>';
    return html;
}

// ==================== SPEECH FUNCTIONS ====================
window.speakWord = function(word, rate) {
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = rate;
    utterance.lang = 'en-US';
    utterance.volume = 1;
    utterance.pitch = 1;
    speechSynthesis.speak(utterance);
}

window.speakSyllables = function(word) {
    const syllables = splitIntoSyllables(word);
    let index = 0;
    const speakNext = () => {
        if (index < syllables.length) {
            const syllable = syllables[index];
            const utterance = new SpeechSynthesisUtterance(syllable);
            utterance.rate = 0.5;
            utterance.lang = 'en-US';
            utterance.onend = () => {
                index++;
                setTimeout(speakNext, 1200);
            };
            speechSynthesis.speak(utterance);
        }
    };
    speakNext();
}

window.practiceWrongSyllables = function(word, wrongSyllablesJSON) {
    const wrongSyllables = JSON.parse(wrongSyllablesJSON);
    let index = 0;
    const speakNext = () => {
        if (index < wrongSyllables.length) {
            const syllable = wrongSyllables[index];
            alert(`üéØ H√£y ch√∫ √Ω nghe √¢m ti·∫øt: "${syllable}"`);
            const utterance = new SpeechSynthesisUtterance(syllable);
            utterance.rate = 0.5;
            utterance.lang = 'en-US';
            utterance.onend = () => {
                setTimeout(() => {
                    const utterance2 = new SpeechSynthesisUtterance(syllable);
                    utterance2.rate = 1;
                    utterance2.lang = 'en-US';
                    speechSynthesis.speak(utterance2);
                    index++;
                    setTimeout(speakNext, 2000);
                }, 1000);
            };
            speechSynthesis.speak(utterance);
        } else {
            setTimeout(() => {
                alert(`‚ú® Gi·ªù th·ª≠ n√≥i c·∫£ t·ª´: "${word}"`);
                speakWord(word, 0.7);
            }, 1500);
        }
    };
    speakNext();
}

// ==================== WHISPER SPEECH RECOGNITION WITH HUGGING FACE ====================
let whisperPipeline = null; // Cache model to avoid reloading

window.recordWord = async function(word) {
    const resultDiv = document.getElementById(`result-${word}`);
    
    // Ki·ªÉm tra quy·ªÅn microphone
    try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
        resultDiv.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-600 font-bold">‚ùå Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p microphone</p>
                <p class="text-sm text-red-500 mt-1">Vui l√≤ng cho ph√©p microphone trong tr√¨nh duy·ªát</p>
            </div>
        `;
        return;
    }

    // Load Whisper model n·∫øu ch∆∞a c√≥ (cache sau l·∫ßn ƒë·∫ßu)
    if (!whisperPipeline) {
        resultDiv.innerHTML = `
            <div class="p-6 bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-xl text-center">
                <div class="animate-spin inline-block w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-purple-700 font-bold text-lg">ü§ñ ƒêang t·∫£i Whisper Turbo...</p>
                <p class="text-sm text-purple-600 mt-2">Model: large-v3-turbo (1.5GB - l·∫ßn ƒë·∫ßu)</p>
                <p class="text-xs text-gray-500 mt-3">Sau n√†y s·∫Ω nhanh h∆°n!</p>
            </div>
        `;
        
        try {
            whisperPipeline = await pipeline('automatic-speech-recognition', 'openai/whisper-large-v3-turbo', {
                dtype: 'fp16',  // Nhanh h∆°n tr√™n GPU
                local_files_only: false,  // Load t·ª´ Hugging Face
                progress_callback: (data) => {
                    if (data.status === 'downloading') {
                        console.log(`ƒêang t·∫£i: ${data.file} (${Math.round(data.progress * 100)}%)`);
                    }
                }
            });
            console.log('‚úÖ Whisper Turbo ƒë√£ s·∫µn s√†ng!');
        } catch (error) {
            console.error('L·ªói load Whisper:', error);
            resultDiv.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-red-600 font-bold">‚ùå L·ªói t·∫£i model Whisper</p>
                    <p class="text-sm text-red-500 mt-1">D√πng Chrome/Edge v·ªõi WebGPU. Ho·∫∑c th·ª≠ model nh·ªè h∆°n: whisper-small</p>
                    <button onclick="recordWord('${word}')" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">Th·ª≠ l·∫°i</button>
                </div>
            `;
            return;
        }
    }

    // Ghi √¢m (3 gi√¢y cho t·ª´ ƒë∆°n ƒë·ªÉ tr√°nh hallucination t·ª´ audio d√†i/noisy)
    resultDiv.innerHTML = `
        <div class="p-6 bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl text-center">
            <div class="animate-bounce inline-block w-16 h-16 bg-gradient-to-br from-green-500 to-blue-500 rounded-full mb-4 flex items-center justify-center">
                <span class="text-2xl">üé§</span>
            </div>
            <p class="text-green-700 font-bold text-xl mb-1">üéôÔ∏è ƒêANG NGHE...</p>
            <p class="text-sm text-green-600 mt-1">N√≥i r√µ t·ª´: <strong class="text-lg font-mono">${word}</strong></p>
            <div class="mt-4 flex justify-center space-x-2">
                <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce"></div>
                <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>
    `;

    try {
        // Ghi √¢m v·ªõi sample rate chu·∫©n cho Whisper (16000Hz) ƒë·ªÉ tr√°nh distortion
        const stream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: 16000 } });
        const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        const chunks = [];
        
        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(chunks, { type: 'audio/webm' });
            
            // Chuy·ªÉn sang AudioBuffer
            const arrayBuffer = await audioBlob.arrayBuffer();
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            // Resample n·∫øu c·∫ßn (ƒë·ªÉ tr√°nh hallucination t·ª´ sample rate sai)
            const offlineContext = new OfflineAudioContext(1, audioBuffer.length, 16000);
            const source = offlineContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(offlineContext.destination);
            source.start(0);
            const resampledBuffer = await offlineContext.startRendering();
            
            // L·∫•y channel data (mono channel ƒë·ªÉ Whisper x·ª≠ l√Ω t·ªët h∆°n)
            const channelData = resampledBuffer.getChannelData(0);
            const float32Array = new Float32Array(channelData);
            
            // VAD ƒë∆°n gi·∫£n ƒë·ªÉ lo·∫°i noise (fix hallucination): Ch·ªâ l·∫•y ph·∫ßn c√≥ √¢m thanh > threshold
            const threshold = 0.01; // Ng∆∞·ª°ng √¢m l∆∞·ª£ng ƒë·ªÉ detect voice
            let startIndex = 0;
            let endIndex = float32Array.length - 1;
            
            // T√¨m start voice
            for (let i = 0; i < float32Array.length; i++) {
                if (Math.abs(float32Array[i]) > threshold) {
                    startIndex = Math.max(0, i - 8000); // Buffer 0.5s tr∆∞·ªõc
                    break;
                }
            }
            
            // T√¨m end voice
            for (let i = float32Array.length - 1; i >= 0; i--) {
                if (Math.abs(float32Array[i]) > threshold) {
                    endIndex = Math.min(float32Array.length - 1, i + 8000); // Buffer 0.5s sau
                    break;
                }
            }
            
            const trimmedAudio = float32Array.subarray(startIndex, endIndex + 1);
            if (trimmedAudio.length < 16000) { // N·∫øu audio qu√° ng·∫Øn (<1s), retry
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-600 font-bold">‚ùå Kh√¥ng ph√°t hi·ªán gi·ªçng n√≥i r√µ r√†ng</p>
                        <p class="text-sm text-red-500 mt-1">H√£y n√≥i r√µ r√†ng h∆°n v√† th·ª≠ l·∫°i</p>
                        <button onclick="recordWord('${word}')" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">Th·ª≠ l·∫°i</button>
                    </div>
                `;
                return;
            }
            
            resultDiv.innerHTML = `
                <div class="p-6 bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-xl text-center">
                    <div class="animate-spin inline-block w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-purple-700 font-bold text-lg">ü§ñ Whisper ƒëang ph√¢n t√≠ch...</p>
                    <p class="text-sm text-purple-600 mt-2">AI deep learning - ch√≠nh x√°c cao</p>
                </div>
            `;
            
            // ‚úÖ TRANSCRIBE V·ªöI WHISPER - Th√™m params ƒë·ªÉ fix hallucination
            const transcription = await whisperPipeline(trimmedAudio, {
                language: 'en',  // Gi·ªõi h·∫°n ti·∫øng Anh ƒë·ªÉ tr√°nh hallucinate sang ng√¥n ng·ªØ kh√°c
                task: 'transcribe',
                return_timestamps: true,  // L·∫•y timestamps ƒë·ªÉ ph√¢n t√≠ch chi ti·∫øt v√† lo·∫°i hallucination
                max_new_tokens: 20,  // Gi·ªõi h·∫°n output ng·∫Øn (cho t·ª´ ƒë∆°n)
                repetition_penalty: 1.5,  // Gi·∫£m repetition hallucination
                no_repeat_ngram_size: 3,  // Tr√°nh l·∫∑p n-gram
                temperature: 0.1  // Low temperature ƒë·ªÉ gi·∫£m randomness/hallucination
            });
            
            let transcript = transcription.text.trim().toLowerCase();
            
            // Fix hallucination: N·∫øu transcript d√†i h∆°n 2x t·ª´ g·ªëc, ho·∫∑c c√≥ t·ª´ l·∫°, c·∫Øt b·ªõt
            if (transcript.length > word.length * 2 || transcript.split(' ').length > 2) {
                transcript = transcript.split(' ')[0];  // L·∫•y t·ª´ ƒë·∫ßu ti√™n (th∆∞·ªùng l√† ch√≠nh)
            }
            
            if (!transcript) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-600 font-bold">‚ùå Kh√¥ng ph√°t hi·ªán gi·ªçng n√≥i</p>
                        <button onclick="recordWord('${word}')" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">Th·ª≠ l·∫°i</button>
                    </div>
                `;
                return;
            }
            
            console.log('üé§ Whisper transcript:', transcript);
            
            // Ph√¢n t√≠ch v√† ch·∫•m ƒëi·ªÉm
            const confidence = 95;  // Whisper kh√¥ng c√≥ confidence tr·ª±c ti·∫øp, gi·∫£ ƒë·ªãnh cao v√¨ model t·ªët
            const analysis = analyzePronunciation(word.toLowerCase(), transcript);
            const score = calculateStrictScore(word.toLowerCase(), transcript, confidence);
            
            // L∆∞u v√†o Firestore
            await addDoc(collection(db, 'results'), {
                studentId: currentUser.id,
                assignmentId: currentAssignment.id,
                word,
                score,
                recognizedText: transcript,
                confidence,
                syllableAnalysis: analysis,
                createdAt: new Date()
            });
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            displayResult(resultDiv, word, transcript, score, confidence);
            updateProgress();
        };
        
        mediaRecorder.start();
        setTimeout(() => {
            mediaRecorder.stop();
            stream.getTracks().forEach(track => track.stop());
        }, 3000);  // Gi·ªõi h·∫°n 3 gi√¢y ƒë·ªÉ tr√°nh audio d√†i g√¢y hallucination
        
    } catch (error) {
        console.error('L·ªói ghi √¢m:', error);
        resultDiv.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-600 font-bold">‚ùå L·ªói ghi √¢m</p>
                <p class="text-sm text-red-500 mt-1">${error.message}</p>
                <button onclick="recordWord('${word}')" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">Th·ª≠ l·∫°i</button>
            </div>
        `;
    }
};

// ==================== H√ÄM CH·∫§M ƒêI·ªÇM NGHI√äM NG·∫∂T ====================
function calculateStrictScore(correctWord, spokenWord, confidence) {
    let score = 0;
    
    // Phonetic similarity (50%)
    const phoneticScore = calculatePhoneticSimilarity(correctWord, spokenWord);
    score += Math.round(phoneticScore * 0.5);
    
    // Syllable accuracy (30%)
    const syllableAnalysis = analyzePronunciation(correctWord, spokenWord);
    const syllableScore = (syllableAnalysis.syllables.filter(s => s.correct).length / syllableAnalysis.syllables.length) * 100;
    score += Math.round(syllableScore * 0.3);
    
    // Confidence weighted (15%)
    const weightedConfidence = Math.min(confidence, 85);
    score += Math.round((weightedConfidence / 100) * 15);
    
    // Exact match bonus (5%)
    if (spokenWord === correctWord) score += 5;
    
    // Length penalty
    const lengthDiff = Math.abs(correctWord.length - spokenWord.length);
    if (lengthDiff > 2) score -= Math.min(lengthDiff * 5, 20);
    
    return Math.max(0, Math.min(100, Math.round(score)));
}

function calculatePhoneticSimilarity(word1, word2) {
    const phoneticMap = { 'f': 'ph', 'ph': 'f', 'c': 'k', 'k': 'c', 's': 'sh', 'sh': 's' };
    let w1 = word1.replace(/ph|ch|sh/gi, match => phoneticMap[match.toLowerCase()] || match);
    let w2 = word2.replace(/ph|ch|sh/gi, match => phoneticMap[match.toLowerCase()] || match);
    const distance = editDistance(w1, w2);
    const maxLength = Math.max(w1.length, w2.length);
    return Math.max(0, 100 - (distance / maxLength * 100));
}

// ==================== HI·ªÇN TH·ªä K·∫æT QU·∫¢ ====================
function displayResult(resultDiv, correctWord, spokenWord, score, confidence) {
    const color = score >= 85 ? 'green' : score >= 70 ? 'yellow' : score >= 50 ? 'orange' : 'red';
    const emoji = score >= 85 ? 'üéâ' : score >= 70 ? 'üëç' : score >= 50 ? 'üòê' : 'üí™';
    const message = score >= 85 ? 'Xu·∫•t s·∫Øc!' : score >= 70 ? 'T·ªët!' : score >= 50 ? 'C·∫ßn luy·ªán th√™m!' : 'C·ªë l√™n!';
    
    let html = `
        <div class="p-6 bg-gradient-to-br rounded-2xl shadow-lg text-center">
            <div class="inline-block w-24 h-24 bg-gradient-to-br ${
                score >= 85 ? 'from-green-400 via-green-500 to-green-600' :
                score >= 70 ? 'from-yellow-400 via-yellow-500 to-yellow-600' : 
                score >= 50 ? 'from-orange-400 via-orange-500 to-orange-600' :
                'from-red-400 via-red-500 to-red-600'
            } rounded-full flex items-center justify-center mb-4 mx-auto shadow-xl">
                <span class="text-4xl font-bold text-white">${emoji}</span>
            </div>
            <h3 class="text-4xl font-bold text-gray-800 mb-3">ƒêi·ªÉm: <span class="${color}-600">${score}</span></h3>
            <p class="text-lg font-semibold text-gray-700 mb-4">${message}</p>
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm font-mono text-gray-600 mb-2">üéØ T·ª´ ƒë√∫ng:</p>
                    <p class="text-xl font-bold text-blue-700 bg-blue-50 p-3 rounded-lg">${correctWord}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm font-mono text-gray-600 mb-2">üé§ Whisper nh·∫≠n:</p>
                    <p class="text-xl font-bold text-purple-700 bg-purple-50 p-3 rounded-lg">${spokenWord}</p>
                </div>
            </div>
            <div class="bg-gray-100 rounded-lg p-3 mb-4">
                <p class="text-sm font-semibold text-gray-700">ü§ñ ƒê·ªô ch√≠nh x√°c AI: ${confidence}%</p>
            </div>
            ${renderSyllableAnalysis(analyzePronunciation(correctWord, spokenWord), correctWord)}
            <div class="flex gap-3 mt-6">
                <button onclick="speakWord('${correctWord}', 0.6)" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2">üêå Nghe ch·∫≠m</button>
                <button onclick="recordWord('${correctWord}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2">üé§ Th·ª≠ l·∫°i</button>
            </div>
        </div>
    `;
    resultDiv.innerHTML = html;
}

// ==================== TEACHER FUNCTIONS ====================
window.showCreateClass = function() {
    document.getElementById('teacherContent').innerHTML = `
        <h2 class="text-2xl font-bold mb-4">T·∫°o l·ªõp m·ªõi</h2>
        <input type="text" id="className" placeholder="T√™n l·ªõp (vd: L·ªõp 6A)" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="createClass()" class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold">T·∫°o l·ªõp</button>
    `;
}

window.createClass = async function() {
    const name = document.getElementById('className').value.trim();
    if (!name) return alert('Vui l√≤ng nh·∫≠p t√™n l·ªõp');
   
    showLoading(true);
    try {
        await addDoc(collection(db, 'classes'), {
            name,
            teacherCode: currentUser.code,
            createdAt: new Date(),
            students: []
        });
        alert('T·∫°o l·ªõp th√†nh c√¥ng!');
        showMyClasses();
    } catch (error) {
        alert('L·ªói t·∫°o l·ªõp: ' + error.message);
    }
    showLoading(false);
}

window.showMyClasses = async function() {
    showLoading(true);
    try {
        const classesRef = collection(db, 'classes');
        const q = query(classesRef, where('teacherCode', '==', currentUser.code));
        const snap = await getDocs(q);
       
        let html = '<h2 class="text-2xl font-bold mb-4">Danh s√°ch l·ªõp</h2><div class="space-y-4">';
       
        snap.forEach(doc => {
            const data = doc.data();
            html += `
                <div class="border rounded-lg p-4 hover:shadow-lg transition">
                    <h3 class="text-xl font-bold">${data.name}</h3>
                    <p class="text-gray-600">S·ªë h·ªçc sinh: ${data.students?.length || 0}</p>
                    <div class="mt-3 flex gap-2">
                        <button onclick="manageStudents('${doc.id}', '${data.name}')" class="bg-green-500 text-white px-4 py-2 rounded">Qu·∫£n l√Ω HS</button>
                        <button onclick="viewStats('${doc.id}', '${data.name}')" class="bg-purple-500 text-white px-4 py-2 rounded">Xem th·ªëng k√™</button>
                    </div>
                </div>
            `;
        });
       
        html += '</div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i danh s√°ch l·ªõp: ' + error.message);
    }
    showLoading(false);
}

window.manageStudents = async function(classId, className) {
    showLoading(true);
    try {
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const students = classDoc.data().students || [];
       
        let html = `
            <h2 class="text-2xl font-bold mb-4">Qu·∫£n l√Ω h·ªçc sinh - ${className}</h2>
            <button onclick="showMyClasses()" class="text-green-600 mb-4">‚Üê Quay l·∫°i</button>
           
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h3 class="font-bold mb-2">Th√™m h·ªçc sinh m·ªõi</h3>
                <div class="flex gap-2">
                    <input type="text" id="newStudentName" placeholder="T√™n h·ªçc sinh" class="flex-1 p-2 border rounded">
                    <input type="text" id="newStudentCode" placeholder="M√£ (vd: HS001)" class="w-32 p-2 border rounded">
                    <button onclick="addStudent('${classId}')" class="bg-green-500 text-white px-4 py-2 rounded">Th√™m</button>
                </div>
            </div>
           
            <h3 class="font-bold mb-2">Danh s√°ch h·ªçc sinh (${students.length})</h3>
            <div class="space-y-2">
        `;
       
        for (const stId of students) {
            try {
                const stDoc = await getDoc(doc(db, 'students', stId));
                if (stDoc.exists()) {
                    const st = stDoc.data();
                    html += `
                        <div class="border p-3 rounded flex justify-between items-center">
                            <div>
                                <span class="font-bold">${st.name}</span>
                                <span class="text-gray-600 ml-2">(${st.code})</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('L·ªói t·∫£i h·ªçc sinh:', error);
            }
        }
       
        html += '</div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i danh s√°ch h·ªçc sinh: ' + error.message);
    }
    showLoading(false);
}

window.addStudent = async function(classId) {
    const name = document.getElementById('newStudentName').value.trim();
    const code = document.getElementById('newStudentCode').value.trim();
   
    if (!name || !code) return alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
   
    showLoading(true);
    try {
        const studentRef = await addDoc(collection(db, 'students'), {
            name,
            code,
            classId,
            createdAt: new Date()
        });
       
        const classRef = doc(db, 'classes', classId);
        await updateDoc(classRef, {
            students: arrayUnion(studentRef.id)
        });
       
        alert(`ƒê√£ th√™m h·ªçc sinh ${name} (${code})`);
       
        const classDoc = await getDoc(classRef);
        manageStudents(classId, classDoc.data().name);
    } catch (error) {
        alert('L·ªói th√™m h·ªçc sinh: ' + error.message);
    }
    showLoading(false);
}

window.showAssignments = async function() {
    showLoading(true);
    try {
        const classesRef = collection(db, 'classes');
        const q = query(classesRef, where('teacherCode', '==', currentUser.code));
        const snap = await getDocs(q);
       
        let html = '<h2 class="text-2xl font-bold mb-4">Giao b√†i t·∫≠p</h2><div class="space-y-4">';
       
        snap.forEach(doc => {
            const data = doc.data();
            html += `
                <div class="border rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-2">${data.name}</h3>
                    <button onclick="createAssignment('${doc.id}', '${data.name}')" class="bg-purple-500 text-white px-4 py-2 rounded">
                        ‚ûï T·∫°o b√†i t·∫≠p m·ªõi
                    </button>
                </div>
            `;
        });
       
        html += '</div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i danh s√°ch l·ªõp: ' + error.message);
    }
    showLoading(false);
}

window.createAssignment = function(classId, className) {
    document.getElementById('teacherContent').innerHTML = `
        <h2 class="text-2xl font-bold mb-4">T·∫°o b√†i t·∫≠p cho ${className}</h2>
        <button onclick="showAssignments()" class="text-green-600 mb-4">‚Üê Quay l·∫°i</button>
       
        <input type="text" id="assignmentName" placeholder="T√™n b√†i (vd: Week 1 - Unit 1)" class="w-full p-3 border rounded-lg mb-4">
       
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h3 class="font-bold mb-2">üìù H∆∞·ªõng d·∫´n nh·∫≠p t·ª´ v·ª±ng:</h3>
            <p class="text-sm text-gray-700 mb-2">M·ªói d√≤ng 1 t·ª´ (t·ªëi ƒëa 20 t·ª´):</p>
            <div class="bg-white p-3 rounded font-mono text-sm space-y-1">
                <div>fibre</div>
                <div>carbohydrate</div>
                <div>protein</div>
                <div>vitamin</div>
            </div>
            <p class="text-xs text-gray-500 mt-2">
                üí° Ch·ªâ c·∫ßn g√µ t·ª´ ti·∫øng Anh, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√°t √¢m!
            </p>
        </div>
       
        <textarea id="assignmentWords" placeholder="Nh·∫≠p t·ª´ v·ª±ng (t·ªëi ƒëa 20 t·ª´)
V√≠ d·ª•:
fibre
protein
carbohydrate
vitamin
healthy
exercise"
            rows="12" class="w-full p-3 border rounded-lg mb-4 font-mono"></textarea>
       
        <button onclick="saveAssignment('${classId}')" class="bg-purple-500 text-white px-6 py-3 rounded-lg font-semibold w-full">
            L∆∞u v√† giao b√†i
        </button>
    `;
}

window.saveAssignment = async function(classId) {
    const name = document.getElementById('assignmentName').value.trim();
    const wordsText = document.getElementById('assignmentWords').value.trim();
   
    if (!name || !wordsText) return alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
   
    const lines = wordsText.split('\n')
        .map(w => w.trim())
        .filter(Boolean)
        .slice(0, 20);
   
    if (lines.length === 0) return alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 t·ª´');
   
    const wordsData = lines.map(word => ({
        word: word,
        syllables: null
    }));
   
    showLoading(true);
    try {
        await addDoc(collection(db, 'assignments'), {
            name,
            wordsData: wordsData,
            classId,
            teacherCode: currentUser.code,
            createdAt: new Date()
        });
       
        alert(`ƒê√£ giao b√†i "${name}" v·ªõi ${wordsData.length} t·ª´!`);
        showAssignments();
    } catch (error) {
        alert('L·ªói l∆∞u b√†i t·∫≠p: ' + error.message);
    }
    showLoading(false);
}

window.viewStats = async function(classId, className) {
    showLoading(true);
   
    try {
        const assignmentsRef = collection(db, 'assignments');
        const qAssign = query(assignmentsRef, where('classId', '==', classId));
        const assignSnap = await getDocs(qAssign);
       
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const studentIds = classDoc.data().students || [];
       
        let html = `
            <h2 class="text-2xl font-bold mb-4">Th·ªëng k√™ l·ªõp ${className}</h2>
            <button onclick="showMyClasses()" class="text-green-600 mb-4">‚Üê Quay l·∫°i</button>
        `;
       
        if (assignSnap.empty) {
            html += '<p class="text-gray-600">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao.</p>';
        } else {
            for (const assignDoc of assignSnap.docs) {
                const assign = assignDoc.data();
               
                const wordCount = assign.wordsData ? assign.wordsData.length : (assign.words || []).length;
               
                html += `<div class="border rounded-lg p-4 mb-4">
                    <h3 class="text-xl font-bold mb-2">${assign.name}</h3>
                    <p class="text-gray-600 mb-3">S·ªë t·ª´: ${wordCount}</p>
                    <div class="space-y-2">
                `;
               
                for (const stId of studentIds) {
                    try {
                        const stDoc = await getDoc(doc(db, 'students', stId));
                        if (!stDoc.exists()) continue;
                       
                        const student = stDoc.data();
                       
                        const resultsRef = collection(db, 'results');
                        const qResults = query(resultsRef,
                            where('studentId', '==', stId),
                            where('assignmentId', '==', assignDoc.id)
                        );
                        const resultsSnap = await getDocs(qResults);
                       
                        let completed = 0;
                        let totalScore = 0;
                        let attempts = 0;
                       
                        resultsSnap.forEach(rDoc => {
                            const r = rDoc.data();
                            if (r.score >= 60) completed++;
                            totalScore += r.score;
                            attempts++;
                        });
                       
                        const avgScore = attempts > 0 ? Math.round(totalScore / attempts) : 0;
                        const progress = wordCount > 0 ? Math.round((completed / wordCount) * 100) : 0;
                       
                        html += `
                            <div class="bg-gray-50 p-3 rounded flex justify-between items-center">
                                <span class="font-semibold">${student.name}</span>
                                <div class="text-sm text-gray-600">
                                    <span class="mr-3">Ti·∫øn ƒë·ªô: ${progress}%</span>
                                    <span class="mr-3">ƒêi·ªÉm TB: ${avgScore}</span>
                                    <span>ƒê√£ luy·ªán: ${attempts} l·∫ßn</span>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.error('L·ªói t·∫£i th·ªëng k√™:', error);
                    }
                }
               
                html += '</div></div>';
            }
        }
       
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i th·ªëng k√™: ' + error.message);
    }
    showLoading(false);
}

// ==================== STUDENT FUNCTIONS ====================
window.loadStudentAssignments = async function() {
    showLoading(true);
   
    try {
        const student = currentUser;
        const classId = student.classId;
       
        const assignmentsRef = collection(db, 'assignments');
        const q = query(assignmentsRef, where('classId', '==', classId));
        const snap = await getDocs(q);
       
        let html = '';
       
        if (snap.empty) {
            html = '<p class="text-gray-600 text-center py-12 text-lg">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao.</p>';
        } else {
            for (const doc of snap.docs) {
                const assign = doc.data();
                const wordCount = assign.wordsData ? assign.wordsData.length : (assign.words || []).length;
               
                const resultsRef = collection(db, 'results');
                const qResults = query(resultsRef,
                    where('studentId', '==', student.id),
                    where('assignmentId', '==', doc.id)
                );
                const resultsSnap = await getDocs(qResults);
               
                let completed = 0;
                let totalScore = 0;
               
                resultsSnap.forEach(rDoc => {
                    const r = rDoc.data();
                    if (r.score >= 60) completed++;
                    totalScore += r.score;
                });
               
                const progress = wordCount > 0 ? Math.round((completed / wordCount) * 100) : 0;
                const avgScore = resultsSnap.size > 0 ? Math.round(totalScore / resultsSnap.size) : 0;
               
                html += `
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-2xl transition cursor-pointer" onclick="startPractice('${doc.id}')">
                        <h3 class="text-2xl font-bold mb-3">${assign.name}</h3>
                        <div class="space-y-2 text-gray-600">
                            <p>üìù S·ªë t·ª´: ${wordCount}</p>
                            <p>‚úÖ Ho√†n th√†nh: ${progress}%</p>
                            <p>‚≠ê ƒêi·ªÉm TB: ${avgScore}</p>
                        </div>
                        <button class="mt-4 w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition">
                            üöÄ B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
                        </button>
                    </div>
                `;
            }
        }
       
        document.getElementById('studentAssignments').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i b√†i t·∫≠p: ' + error.message);
        document.getElementById('studentAssignments').innerHTML = '<p class="text-red-600 text-center py-12">L·ªói t·∫£i b√†i t·∫≠p</p>';
    }
    showLoading(false);
}

window.startPractice = async function(assignmentId) {
    showLoading(true);
   
    try {
        const assignDoc = await getDoc(doc(db, 'assignments', assignmentId));
        const assign = assignDoc.data();
       
        currentAssignment = { id: assignmentId, ...assign };
       
        document.getElementById('assignmentTitle').textContent = assign.name;
       
        let wordsData = [];
        if (assign.wordsData) {
            wordsData = assign.wordsData;
        } else if (assign.words) {
            wordsData = assign.words.map(w => ({
                word: w,
                syllables: null
            }));
        }
       
        let html = '';
        for (const data of wordsData) {
            const word = data.word;
            const syllables = data.syllables || splitIntoSyllables(word);
           
            const syllableDisplay = syllables.map((s, idx) => {
                return `<span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full mx-1 font-mono font-bold">
                    ${s}
                </span>`;
            }).join('');
           
            html += `
                <div class="bg-white rounded-2xl shadow-2xl p-8 text-center border-2 border-gray-200 hover:border-green-400 transition">
                    <h3 class="text-5xl font-bold mb-4 text-gray-800">${word}</h3>
                   
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <p class="text-sm text-gray-600 mb-3">üìù √Çm ti·∫øt:</p>
                        <div class="flex flex-wrap justify-center gap-2">
                            ${syllableDisplay}
                        </div>
                    </div>
                   
                    <div class="flex gap-2 mb-6 justify-center">
                        <button onclick="speakWord('${word}', 0.3)" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 font-semibold flex items-center gap-2">
                            üê¢ R·∫•t ch·∫≠m
                        </button>
                        <button onclick="speakWord('${word}', 0.6)" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 font-semibold flex items-center gap-2">
                            üêå Ch·∫≠m
                        </button>
                        <button onclick="speakWord('${word}', 1)" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold flex items-center gap-2">
                            ‚ñ∂Ô∏è B√¨nh th∆∞·ªùng
                        </button>
                    </div>
                   
                    <button onclick="recordWord('${word}')" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-4 rounded-xl font-bold text-lg w-full shadow-lg transform hover:scale-105 transition-all duration-200">
                        üé§ B·∫ÆT ƒê·∫¶U THU √ÇM
                    </button>
                   
                    <div id="result-${word}" class="mt-6"></div>
                </div>
            `;
        }
       
        document.getElementById('wordsList').innerHTML = html;
        updateProgress();
        showScreen('practiceScreen');
    } catch (error) {
        alert('L·ªói t·∫£i b√†i t·∫≠p: ' + error.message);
    }
    showLoading(false);
}

window.updateProgress = async function() {
    if (!currentAssignment) return;
    
    try {
        const resultsRef = collection(db, 'results');
        const q = query(resultsRef,
            where('studentId', '==', currentUser.id),
            where('assignmentId', '==', currentAssignment.id)
        );
        const snap = await getDocs(q);
        
        let completed = 0;
        let totalScore = 0;
        
        snap.forEach(doc => {
            const r = doc.data();
            if (r.score >= 60) completed++;
            totalScore += r.score;
        });
        
        const avgScore = snap.size > 0 ? Math.round(totalScore / snap.size) : 0;
        const totalWords = currentAssignment.wordsData ? currentAssignment.wordsData.length : (currentAssignment.words || []).length;
        
        document.getElementById('progressText').textContent = `${completed}/${totalWords}`;
        document.getElementById('avgScoreText').textContent = avgScore;
    } catch (error) {
        console.error('L·ªói c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô:', error);
    }
}

window.backToStudent = function() {
    currentAssignment = null;
    showScreen('studentDashboard');
    loadStudentAssignments();
}
</script>
</body>
</html>
