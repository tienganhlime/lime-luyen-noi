<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán Ph√°t √Çm</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<!-- Loading Spinner -->
<div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg">
        <div class="animate-spin h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div>
        <p class="mt-4 text-gray-700">ƒêang x·ª≠ l√Ω...</p>
    </div>
</div>

<!-- 1. TRANG ƒêƒÇNG NH·∫¨P -->
<div id="loginScreen" class="screen min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-10 max-w-md w-full">
        <h1 class="text-4xl font-bold text-center mb-8 text-blue-600">üéôÔ∏è Luy·ªán Ph√°t √Çm</h1>
        <div class="space-y-4">
            <button onclick="selectRole('teacher')" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg text-xl font-semibold transition">
                üë®‚Äçüè´ T√¥i l√† Gi√°o vi√™n
            </button>
            <button onclick="selectRole('student')" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-lg text-xl font-semibold transition">
                üë®‚Äçüéì T√¥i l√† H·ªçc sinh
            </button>
        </div>
    </div>
</div>

<!-- 2. ƒêƒÇNG NH·∫¨P H·ªåC SINH -->
<div id="studentLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
        <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4">‚Üê Quay l·∫°i</button>
        <h2 class="text-3xl font-bold mb-6">ƒêƒÉng nh·∫≠p H·ªçc sinh</h2>
        <input type="text" id="studentCode" placeholder="Nh·∫≠p m√£ h·ªçc sinh (vd: HS001)" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="loginStudent()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold">
            ƒêƒÉng nh·∫≠p
        </button>
    </div>
</div>

<!-- 3. ƒêƒÇNG NH·∫¨P GI√ÅO VI√äN -->
<div id="teacherLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
        <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4">‚Üê Quay l·∫°i</button>
        <h2 class="text-3xl font-bold mb-6">ƒêƒÉng nh·∫≠p Gi√°o vi√™n</h2>
        <input type="text" id="teacherCode" placeholder="Nh·∫≠p m√£ gi√°o vi√™n (vd: GV001)" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="loginTeacher()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
            ƒêƒÉng nh·∫≠p
        </button>
        <p class="text-sm text-gray-500 mt-4">L·∫ßn ƒë·∫ßu? Nh·∫≠p m√£ b·∫•t k·ª≥ ƒë·ªÉ t·∫°o t√†i kho·∫£n m·ªõi</p>
    </div>
</div>

<!-- 4. DASHBOARD GI√ÅO VI√äN -->
<div id="teacherDashboard" class="screen hidden min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">üë®‚Äçüè´ Dashboard Gi√°o vi√™n</h1>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ƒêƒÉng xu·∫•t</button>
            </div>
            <p class="text-gray-600 mt-2">M√£ GV: <span id="teacherCodeDisplay" class="font-mono font-bold"></span></p>
        </div>

        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <button onclick="showCreateClass()" class="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-lg text-xl font-semibold">
                ‚ûï T·∫°o l·ªõp m·ªõi
            </button>
            <button onclick="showMyClasses()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg text-xl font-semibold">
                üìö Qu·∫£n l√Ω l·ªõp
            </button>
            <button onclick="showAssignments()" class="bg-purple-500 hover:bg-purple-600 text-white p-6 rounded-lg text-xl font-semibold">
                üìù Giao b√†i t·∫≠p
            </button>
        </div>

        <div id="teacherContent" class="bg-white rounded-lg shadow-lg p-6"></div>
    </div>
</div>

<!-- 5. DASHBOARD H·ªåC SINH -->
<div id="studentDashboard" class="screen hidden min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">üë®‚Äçüéì L·ªõp h·ªçc c·ªßa t√¥i</h1>
                    <p class="text-gray-600 mt-2">H·ªçc sinh: <span id="studentNameDisplay" class="font-bold"></span></p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <div id="studentAssignments" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
</div>

<!-- 6. M√ÄN H√åNH LUY·ªÜN T·∫¨P -->
<div id="practiceScreen" class="screen hidden min-h-screen p-6 bg-gradient-to-br from-indigo-500 to-purple-600">
    <div class="max-w-6xl mx-auto">
        <button onclick="backToStudent()" class="text-white mb-4 text-lg">‚Üê Quay l·∫°i</button>
        <div class="bg-white rounded-lg shadow-2xl p-6 mb-6">
            <h2 id="assignmentTitle" class="text-3xl font-bold mb-2"></h2>
            <div class="flex gap-4 text-sm text-gray-600">
                <span>Ti·∫øn ƒë·ªô: <span id="progressText" class="font-bold">0/0</span></span>
                <span>ƒêi·ªÉm TB: <span id="avgScoreText" class="font-bold">0</span></span>
            </div>
        </div>

        <div id="wordsList" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </div>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, getDoc, setDoc, orderBy, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyB2VOZ0A5im13MC6FNLa4bEupKedm5iiBo",
    authDomain: "lime-phat-am.firebaseapp.com",
    projectId: "lime-phat-am",
    storageBucket: "lime-phat-am.firebasestorage.app",
    messagingSenderId: "434295865710",
    appId: "1:434295865710:web:5f373900f5e8c1d679417f"
};

const HF_TOKEN = "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";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = null;
let currentAssignment = null;

// ==================== UTILITIES ====================
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
}

// ==================== AUTHENTICATION ====================
window.selectRole = function(role) {
    showScreen(role === 'teacher' ? 'teacherLoginScreen' : 'studentLoginScreen');
}

window.loginTeacher = async function() {
    const code = document.getElementById('teacherCode').value.trim();
    if (!code) return alert('Vui l√≤ng nh·∫≠p m√£ gi√°o vi√™n');
    
    showLoading(true);
    const teacherRef = doc(db, 'teachers', code);
    const teacherSnap = await getDoc(teacherRef);
    
    if (!teacherSnap.exists()) {
        await setDoc(teacherRef, { code, createdAt: new Date() });
    }
    
    currentUser = { role: 'teacher', code };
    document.getElementById('teacherCodeDisplay').textContent = code;
    showScreen('teacherDashboard');
    showLoading(false);
}

window.loginStudent = async function() {
    const code = document.getElementById('studentCode').value.trim();
    if (!code) return alert('Vui l√≤ng nh·∫≠p m√£ h·ªçc sinh');
    
    showLoading(true);
    const studentsRef = collection(db, 'students');
    const q = query(studentsRef, where('code', '==', code));
    const snap = await getDocs(q);
    
    if (snap.empty) {
        showLoading(false);
        return alert('M√£ h·ªçc sinh kh√¥ng t·ªìn t·∫°i. Li√™n h·ªá gi√°o vi√™n!');
    }
    
    const studentData = snap.docs[0].data();
    currentUser = { role: 'student', code, id: snap.docs[0].id, ...studentData };
    document.getElementById('studentNameDisplay').textContent = studentData.name;
    await loadStudentAssignments();
    showScreen('studentDashboard');
    showLoading(false);
}

window.logout = function() {
    currentUser = null;
    showScreen('loginScreen');
}

// ==================== TEACHER FUNCTIONS ====================
window.showCreateClass = function() {
    document.getElementById('teacherContent').innerHTML = `
        <h2 class="text-2xl font-bold mb-4">T·∫°o l·ªõp m·ªõi</h2>
        <input type="text" id="className" placeholder="T√™n l·ªõp (vd: L·ªõp 6A)" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="createClass()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold">T·∫°o l·ªõp</button>
    `;
}

window.createClass = async function() {
    const name = document.getElementById('className').value.trim();
    if (!name) return alert('Vui l√≤ng nh·∫≠p t√™n l·ªõp');
    
    showLoading(true);
    await addDoc(collection(db, 'classes'), {
        name,
        teacherCode: currentUser.code,
        createdAt: new Date(),
        students: []
    });
    alert('T·∫°o l·ªõp th√†nh c√¥ng!');
    showMyClasses();
    showLoading(false);
}

window.showMyClasses = async function() {
    showLoading(true);
    const classesRef = collection(db, 'classes');
    const q = query(classesRef, where('teacherCode', '==', currentUser.code));
    const snap = await getDocs(q);
    
    let html = '<h2 class="text-2xl font-bold mb-4">Danh s√°ch l·ªõp</h2><div class="space-y-4">';
    
    snap.forEach(doc => {
        const data = doc.data();
        html += `
            <div class="border rounded-lg p-4 hover:shadow-lg transition">
                <h3 class="text-xl font-bold">${data.name}</h3>
                <p class="text-gray-600">S·ªë h·ªçc sinh: ${data.students?.length || 0}</p>
                <div class="mt-3 flex gap-2">
                    <button onclick="manageStudents('${doc.id}', '${data.name}')" class="bg-green-500 text-white px-4 py-2 rounded">Qu·∫£n l√Ω HS</button>
                    <button onclick="viewStats('${doc.id}', '${data.name}')" class="bg-purple-500 text-white px-4 py-2 rounded">Xem th·ªëng k√™</button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('teacherContent').innerHTML = html;
    showLoading(false);
}

window.manageStudents = async function(classId, className) {
    showLoading(true);
    const classDoc = await getDoc(doc(db, 'classes', classId));
    const students = classDoc.data().students || [];
    
    let html = `
        <h2 class="text-2xl font-bold mb-4">Qu·∫£n l√Ω h·ªçc sinh - ${className}</h2>
        <button onclick="showMyClasses()" class="text-blue-600 mb-4">‚Üê Quay l·∫°i</button>
        
        <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <h3 class="font-bold mb-2">Th√™m h·ªçc sinh m·ªõi</h3>
            <div class="flex gap-2">
                <input type="text" id="newStudentName" placeholder="T√™n h·ªçc sinh" class="flex-1 p-2 border rounded">
                <input type="text" id="newStudentCode" placeholder="M√£ (vd: HS001)" class="w-32 p-2 border rounded">
                <button onclick="addStudent('${classId}')" class="bg-green-500 text-white px-4 py-2 rounded">Th√™m</button>
            </div>
        </div>
        
        <h3 class="font-bold mb-2">Danh s√°ch h·ªçc sinh (${students.length})</h3>
        <div class="space-y-2">
    `;
    
    for (const stId of students) {
        const stDoc = await getDoc(doc(db, 'students', stId));
        if (stDoc.exists()) {
            const st = stDoc.data();
            html += `
                <div class="border p-3 rounded flex justify-between items-center">
                    <div>
                        <span class="font-bold">${st.name}</span>
                        <span class="text-gray-600 ml-2">(${st.code})</span>
                    </div>
                </div>
            `;
        }
    }
    
    html += '</div>';
    document.getElementById('teacherContent').innerHTML = html;
    showLoading(false);
}

window.addStudent = async function(classId) {
    const name = document.getElementById('newStudentName').value.trim();
    const code = document.getElementById('newStudentCode').value.trim();
    
    if (!name || !code) return alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
    
    showLoading(true);
    
    // T·∫°o h·ªçc sinh trong collection students
    const studentRef = await addDoc(collection(db, 'students'), {
        name,
        code,
        classId,
        createdAt: new Date()
    });
    
    // Th√™m ID h·ªçc sinh v√†o class
    const classRef = doc(db, 'classes', classId);
    await updateDoc(classRef, {
        students: arrayUnion(studentRef.id)
    });
    
    alert(`ƒê√£ th√™m h·ªçc sinh ${name} (${code})`);
    
    // Reload
    const classDoc = await getDoc(classRef);
    manageStudents(classId, classDoc.data().name);
    showLoading(false);
}

window.showAssignments = async function() {
    showLoading(true);
    const classesRef = collection(db, 'classes');
    const q = query(classesRef, where('teacherCode', '==', currentUser.code));
    const snap = await getDocs(q);
    
    let html = '<h2 class="text-2xl font-bold mb-4">Giao b√†i t·∫≠p</h2><div class="space-y-4">';
    
    snap.forEach(doc => {
        const data = doc.data();
        html += `
            <div class="border rounded-lg p-4">
                <h3 class="text-xl font-bold mb-2">${data.name}</h3>
                <button onclick="createAssignment('${doc.id}', '${data.name}')" class="bg-purple-500 text-white px-4 py-2 rounded">
                    ‚ûï T·∫°o b√†i t·∫≠p m·ªõi
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    document.getElementById('teacherContent').innerHTML = html;
    showLoading(false);
}

window.createAssignment = function(classId, className) {
    document.getElementById('teacherContent').innerHTML = `
        <h2 class="text-2xl font-bold mb-4">T·∫°o b√†i t·∫≠p cho ${className}</h2>
        <button onclick="showAssignments()" class="text-blue-600 mb-4">‚Üê Quay l·∫°i</button>
        
        <input type="text" id="assignmentName" placeholder="T√™n b√†i (vd: Week 1 - Unit 1)" class="w-full p-3 border rounded-lg mb-4">
        <textarea id="assignmentWords" placeholder="Nh·∫≠p t·ª´, m·ªói t·ª´ m·ªôt d√≤ng (t·ªëi ƒëa 20 t·ª´):
ship
cat
apple
dog
..." rows="12" class="w-full p-3 border rounded-lg mb-4 font-mono"></textarea>
        <button onclick="saveAssignment('${classId}')" class="bg-purple-500 text-white px-6 py-3 rounded-lg font-semibold">
            L∆∞u v√† giao b√†i
        </button>
    `;
}

window.saveAssignment = async function(classId) {
    const name = document.getElementById('assignmentName').value.trim();
    const wordsText = document.getElementById('assignmentWords').value.trim();
    
    if (!name || !wordsText) return alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
    
    const words = wordsText.split('\n').map(w => w.trim()).filter(Boolean).slice(0, 20);
    
    if (words.length === 0) return alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 t·ª´');
    
    showLoading(true);
    await addDoc(collection(db, 'assignments'), {
        name,
        words,
        classId,
        teacherCode: currentUser.code,
        createdAt: new Date()
    });
    
    alert(`ƒê√£ giao b√†i "${name}" v·ªõi ${words.length} t·ª´!`);
    showAssignments();
    showLoading(false);
}

window.viewStats = async function(classId, className) {
    showLoading(true);
    
    // L·∫•y danh s√°ch assignments c·ªßa l·ªõp n√†y
    const assignmentsRef = collection(db, 'assignments');
    const qAssign = query(assignmentsRef, where('classId', '==', classId));
    const assignSnap = await getDocs(qAssign);
    
    // L·∫•y danh s√°ch h·ªçc sinh
    const classDoc = await getDoc(doc(db, 'classes', classId));
    const studentIds = classDoc.data().students || [];
    
    let html = `
        <h2 class="text-2xl font-bold mb-4">Th·ªëng k√™ l·ªõp ${className}</h2>
        <button onclick="showMyClasses()" class="text-blue-600 mb-4">‚Üê Quay l·∫°i</button>
    `;
    
    if (assignSnap.empty) {
        html += '<p class="text-gray-600">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao.</p>';
    } else {
        for (const assignDoc of assignSnap.docs) {
            const assign = assignDoc.data();
            html += `<div class="border rounded-lg p-4 mb-4">
                <h3 class="text-xl font-bold mb-2">${assign.name}</h3>
                <p class="text-gray-600 mb-3">S·ªë t·ª´: ${assign.words.length}</p>
                <div class="space-y-2">
            `;
            
            for (const stId of studentIds) {
                const stDoc = await getDoc(doc(db, 'students', stId));
                if (!stDoc.exists()) continue;
                
                const student = stDoc.data();
                
                // L·∫•y k·∫øt qu·∫£ c·ªßa h·ªçc sinh n√†y
                const resultsRef = collection(db, 'results');
                const qResults = query(resultsRef, 
                    where('studentId', '==', stId),
                    where('assignmentId', '==', assignDoc.id)
                );
                const resultsSnap = await getDocs(qResults);
                
                let completed = 0;
                let totalScore = 0;
                let attempts = 0;
                
                resultsSnap.forEach(rDoc => {
                    const r = rDoc.data();
                    if (r.score >= 60) completed++;
                    totalScore += r.score;
                    attempts++;
                });
                
                const avgScore = attempts > 0 ? Math.round(totalScore / attempts) : 0;
                const progress = Math.round((completed / assign.words.length) * 100);
                
                html += `
                    <div class="bg-gray-50 p-3 rounded flex justify-between items-center">
                        <span class="font-semibold">${student.name}</span>
                        <div class="text-sm text-gray-600">
                            <span class="mr-3">Ti·∫øn ƒë·ªô: ${progress}%</span>
                            <span class="mr-3">ƒêi·ªÉm TB: ${avgScore}</span>
                            <span>ƒê√£ luy·ªán: ${attempts} l·∫ßn</span>
                        </div>
                    </div>
                `;
            }
            
            html += '</div></div>';
        }
    }
    
    document.getElementById('teacherContent').innerHTML = html;
    showLoading(false);
}

// ==================== STUDENT FUNCTIONS ====================
window.loadStudentAssignments = async function() {
    showLoading(true);
    
    // L·∫•y classId c·ªßa h·ªçc sinh
    const student = currentUser;
    const classId = student.classId;
    
    // L·∫•y assignments c·ªßa l·ªõp
    const assignmentsRef = collection(db, 'assignments');
    const q = query(assignmentsRef, where('classId', '==', classId));
    const snap = await getDocs(q);
    
    let html = '';
    
    if (snap.empty) {
        html = '<p class="text-gray-600 text-center">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao.</p>';
    } else {
        for (const doc of snap.docs) {
            const assign = doc.data();
            
            // T√≠nh ti·∫øn ƒë·ªô
            const resultsRef = collection(db, 'results');
            const qResults = query(resultsRef,
                where('studentId', '==', student.id),
                where('assignmentId', '==', doc.id)
            );
            const resultsSnap = await getDocs(qResults);
            
            let completed = 0;
            let totalScore = 0;
            
            resultsSnap.forEach(rDoc => {
                const r = rDoc.data();
                if (r.score >= 60) completed++;
                totalScore += r.score;
            });
            
            const progress = Math.round((completed / assign.words.length) * 100);
            const avgScore = resultsSnap.size > 0 ? Math.round(totalScore / resultsSnap.size) : 0;
            
            html += `
                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-2xl transition cursor-pointer" onclick="startPractice('${doc.id}')">
                    <h3 class="text-2xl font-bold mb-3">${assign.name}</h3>
                    <div class="space-y-2 text-gray-600">
                        <p>üìù S·ªë t·ª´: ${assign.words.length}</p>
                        <p>‚úÖ Ho√†n th√†nh: ${progress}%</p>
                        <p>‚≠ê ƒêi·ªÉm TB: ${avgScore}</p>
                    </div>
                    <button class="mt-4 w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600">
                        B·∫Øt ƒë·∫ßu luy·ªán
                    </button>
                </div>
            `;
        }
    }
    
    document.getElementById('studentAssignments').innerHTML = html;
    showLoading(false);
}

window.startPractice = async function(assignmentId) {
    showLoading(true);
    
    const assignDoc = await getDoc(doc(db, 'assignments', assignmentId));
    const assign = assignDoc.data();
    
    currentAssignment = { id: assignmentId, ...assign };
    
    document.getElementById('assignmentTitle').textContent = assign.name;
    
    // Render words
    let html = '';
    for (const word of assign.words) {
        html += `
            <div class="bg-white rounded-xl shadow-xl p-6 text-center">
                <h3 class="text-3xl font-bold mb-4">${word}</h3>
                <div class="space-x-2 mb-4">
                    <button onclick="speakWord('${word}', 0.6)" class="bg-gray-400 text-white px-3 py-2 rounded hover:bg-gray-500">
                        üê¢ Ch·∫≠m
                    </button>
                    <button onclick="speakWord('${word}', 1)" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600">
                        ‚ñ∂Ô∏è B√¨nh th∆∞·ªùng
                    </button>
                </div>
                <button onclick="recordWord('${word}')" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold w-full">
                    üé§ Thu √¢m
                </button>
                <div id="result-${word}" class="mt-4"></div>
            </div>
        `;
    }
    
    document.getElementById('wordsList').innerHTML = html;
    updateProgress();
    showScreen('practiceScreen');
    showLoading(false);
}

window.speakWord = function(word, rate) {
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = rate;
    utterance.lang = 'en-US';
    speechSynthesis.speak(utterance);
}

window.recordWord = async function(word) {
    const resultDiv = document.getElementById(`result-${word}`);
    resultDiv.innerHTML = '<p class="text-yellow-600 font-semibold">üéôÔ∏è ƒêang ghi √¢m...</p>';
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        const chunks = [];
        
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        
        mediaRecorder.onstop = async () => {
            resultDiv.innerHTML = '<p class="text-blue-600 font-semibold">‚è≥ ƒêang ch·∫•m ƒëi·ªÉm...</p>';
            
            const audioBlob = new Blob(chunks, { type: 'audio/webm' });
            
            // G·ª≠i l√™n HuggingFace Whisper
            const formData = new FormData();
            formData.append('file', audioBlob);
            
            try {
                const response = await fetch('https://api-inference.huggingface.co/models/openai/whisper-large-v3-turbo', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${HF_TOKEN}` },
                    body: audioBlob
                });
                
                const result = await response.json();
                const recognizedText = (result.text || '').trim().toLowerCase();
                const correctWord = word.toLowerCase();
                
                // T√≠nh ƒëi·ªÉm
                let score = 0;
                if (recognizedText.includes(correctWord)) {
                    score = 85 + Math.floor(Math.random() * 15); // 85-100
                } else {
                    score = 30 + Math.floor(Math.random() * 40); // 30-70
                }
                
                // L∆∞u k·∫øt qu·∫£ v√†o Firestore
                await addDoc(collection(db, 'results'), {
                    studentId: currentUser.id,
assignmentId: currentAssignment.id,
word,
score,
recognizedText,
createdAt: new Date()
});
            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            const color = score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600';
            resultDiv.innerHTML = `
                <p class="${color} text-2xl font-bold mb-2">üéØ ƒêi·ªÉm: ${score}/100</p>
                <p class="text-sm text-gray-600">B·∫°n n√≥i: "${recognizedText}"</p>
            `;
            
            updateProgress();
            
        } catch (err) {
            resultDiv.innerHTML = '<p class="text-red-600">‚ùå L·ªói khi ch·∫•m ƒëi·ªÉm. Th·ª≠ l·∫°i!</p>';
            console.error(err);
        }
        
        stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), 4000);
    
} catch (err) {
    resultDiv.innerHTML = '<p class="text-red-600">‚ùå Kh√¥ng th·ªÉ truy c·∫≠p microphone!</p>';
    console.error(err);
}
}
window.updateProgress = async function() {
if (!currentAssignment) return;
const resultsRef = collection(db, 'results');
const q = query(resultsRef,
    where('studentId', '==', currentUser.id),
    where('assignmentId', '==', currentAssignment.id)
);
const snap = await getDocs(q);

let completed = 0;
let totalScore = 0;

snap.forEach(doc => {
    const r = doc.data();
    if (r.score >= 60) completed++;
    totalScore += r.score;
});

const avgScore = snap.size > 0 ? Math.round(totalScore / snap.size) : 0;

document.getElementById('progressText').textContent = `${completed}/${currentAssignment.words.length}`;
document.getElementById('avgScoreText').textContent = avgScore;
}
window.backToStudent = function() {
currentAssignment = null;
showScreen('studentDashboard');
loadStudentAssignments();
}
showLoading(false);
</script>
</body>
</html>