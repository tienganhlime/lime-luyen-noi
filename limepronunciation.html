<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán Ph√°t √Çm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hyphen@1.1.1/hyphen.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hyphen@1.1.1/patterns/en-us.js"></script>
</head>
<body class="bg-gray-100">
<!-- Loading Spinner -->
<div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg">
        <div class="animate-spin h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div>
        <p class="mt-4 text-gray-700">ƒêang x·ª≠ l√Ω...</p>
    </div>
</div>

<!-- 1. TRANG ƒêƒÇNG NH·∫¨P -->
<div id="loginScreen" class="screen min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-10 max-w-md w-full">
        <h1 class="text-4xl font-bold text-center mb-8 text-blue-600">üéôÔ∏è Luy·ªán Ph√°t √Çm</h1>
        <div class="space-y-4">
            <button onclick="selectRole('teacher')" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg text-xl font-semibold transition">
                üë®‚Äçüè´ T√¥i l√† Gi√°o vi√™n
            </button>
            <button onclick="selectRole('student')" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-lg text-xl font-semibold transition">
                üë®‚Äçüéì T√¥i l√† H·ªçc sinh
            </button>
            <button onclick="selectRole('admin')" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-4 rounded-lg text-xl font-semibold transition">
                üõ°Ô∏è T√¥i l√† Admin
            </button>
        </div>
    </div>
</div>

<!-- 2. ƒêƒÇNG NH·∫¨P H·ªåC SINH -->
<div id="studentLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
        <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4">‚Üê Quay l·∫°i</button>
        <h2 class="text-3xl font-bold mb-6">ƒêƒÉng nh·∫≠p H·ªçc sinh</h2>
        <input type="text" id="studentCode" placeholder="Nh·∫≠p m√£ h·ªçc sinh (vd: HS001)" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="loginStudent()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold">
            ƒêƒÉng nh·∫≠p
        </button>
    </div>
</div>

<!-- 3. ƒêƒÇNG NH·∫¨P GI√ÅO VI√äN -->
<div id="teacherLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
        <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4">‚Üê Quay l·∫°i</button>
        <h2 class="text-3xl font-bold mb-6">ƒêƒÉng nh·∫≠p Gi√°o vi√™n</h2>
        <input type="text" id="teacherCode" placeholder="Nh·∫≠p m√£ gi√°o vi√™n (vd: GV001)" class="w-full p-3 border rounded-lg mb-4">
        <input type="password" id="teacherPassword" placeholder="M·∫≠t kh·∫©u" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="loginTeacher()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
            ƒêƒÉng nh·∫≠p
        </button>
        <p class="text-sm text-gray-500 mt-4">Li√™n h·ªá Admin n·∫øu qu√™n m·∫≠t kh·∫©u.</p>
    </div>
</div>

<!-- ƒêƒÇNG NH·∫¨P ADMIN -->
<div id="adminLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
        <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4">‚Üê Quay l·∫°i</button>
        <h2 class="text-3xl font-bold mb-6">ƒêƒÉng nh·∫≠p Admin</h2>
        <input type="text" id="adminCode" placeholder="M√£ admin (vd: ADMIN001)" class="w-full p-3 border rounded-lg mb-4">
        <input type="password" id="adminPassword" placeholder="M·∫≠t kh·∫©u" class="w-full p-3 border rounded-lg mb-4">
        <button onclick="loginAdmin()" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold">
            ƒêƒÉng nh·∫≠p
        </button>
        <p class="text-sm text-gray-500 mt-4">Li√™n h·ªá developer n·∫øu c·∫ßn.</p>
    </div>
</div>

<!-- DASHBOARD ADMIN -->
<div id="adminDashboard" class="screen hidden min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">üõ°Ô∏è Dashboard Admin</h1>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ƒêƒÉng xu·∫•t</button>
            </div>
            <p class="text-gray-600 mt-2">M√£ Admin: <span id="adminCodeDisplay" class="font-mono font-bold"></span></p>
        </div>
        <div class="grid md:grid-cols-4 gap-6 mb-6">
            <button onclick="showManageTeachers()" class="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-lg text-xl font-semibold">üë®‚Äçüè´ Qu·∫£n l√Ω Gi√°o vi√™n</button>
            <button onclick="showManageClasses()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg text-xl font-semibold">üìö Qu·∫£n l√Ω L·ªõp</button>
            <button onclick="showManageStudents()" class="bg-purple-500 hover:bg-purple-600 text-white p-6 rounded-lg text-xl font-semibold">üë®‚Äçüéì Qu·∫£n l√Ω H·ªçc sinh</button>
            <button onclick="showReports()" class="bg-orange-500 hover:bg-orange-600 text-white p-6 rounded-lg text-xl font-semibold">üìä B√°o c√°o</button>
        </div>
        <div id="adminContent" class="bg-white rounded-lg shadow-lg p-6"></div>
    </div>
</div>

<!-- 4. DASHBOARD GI√ÅO VI√äN -->
<div id="teacherDashboard" class="screen hidden min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">üë®‚Äçüè´ Dashboard Gi√°o vi√™n</h1>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ƒêƒÉng xu·∫•t</button>
            </div>
            <p class="text-gray-600 mt-2">M√£ GV: <span id="teacherCodeDisplay" class="font-mono font-bold"></span></p>
        </div>
        <div class="grid md:grid-cols-3 gap-6 mb-6">
            <button onclick="showCreateClass()" class="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-lg text-xl font-semibold">
                ‚ûï T·∫°o l·ªõp m·ªõi
            </button>
            <button onclick="showMyClasses()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg text-xl font-semibold">
                üìö Qu·∫£n l√Ω l·ªõp
            </button>
            <button onclick="showAssignments()" class="bg-purple-500 hover:bg-purple-600 text-white p-6 rounded-lg text-xl font-semibold">
                üìù Giao b√†i t·∫≠p
            </button>
        </div>
        <div id="teacherContent" class="bg-white rounded-lg shadow-lg p-6"></div>
    </div>
</div>

<!-- 5. DASHBOARD H·ªåC SINH -->
<div id="studentDashboard" class="screen hidden min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">üë®‚Äçüéì L·ªõp h·ªçc c·ªßa t√¥i</h1>
                    <p class="text-gray-600 mt-2">H·ªçc sinh: <span id="studentNameDisplay" class="font-bold"></span></p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        <div id="studentAssignments" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
</div>

<!-- 6. M√ÄN H√åNH LUY·ªÜN T·∫¨P -->
<div id="practiceScreen" class="screen hidden min-h-screen p-6 bg-gradient-to-br from-indigo-500 to-purple-600">
    <div class="max-w-6xl mx-auto">
        <button onclick="backToStudent()" class="text-white mb-4 text-lg">‚Üê Quay l·∫°i</button>
        <div class="bg-white rounded-lg shadow-2xl p-6 mb-6">
            <h2 id="assignmentTitle" class="text-3xl font-bold mb-2"></h2>
            <div class="flex gap-4 text-sm text-gray-600">
                <span>Ti·∫øn ƒë·ªô: <span id="progressText" class="font-bold">0/0</span></span>
                <span>ƒêi·ªÉm TB: <span id="avgScoreText" class="font-bold">0</span></span>
            </div>
        </div>
        <div id="wordsList" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, getDoc, setDoc, orderBy, arrayUnion, arrayRemove, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyB2VOZ0A5im13MC6FNLa4bEupKedm5iiBo",
    authDomain: "lime-phat-am.firebaseapp.com",
    projectId: "lime-phat-am",
    storageBucket: "lime-phat-am.firebasestorage.app",
    messagingSenderId: "434295865710",
    appId: "1:434295865710:web:5f373900f5e8c1d679417f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = null;
let currentAssignment = null;

// ==================== WHISPER AI CONFIGURATION ====================
// ‚ö†Ô∏è QUAN TR·ªåNG: Thay YOUR_API_KEY_HERE b·∫±ng API key t·ª´ https://huggingface.co/settings/tokens
const HUGGING_FACE_API_KEY = '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'; 
const WHISPER_MODEL = 'openai/whisper-large-v3-turbo';

let mediaRecorder;
let audioChunks = [];
let audioContext = new (window.AudioContext || window.webkitAudioContext)();

// ==================== UTILITIES ====================
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
}

// ==================== AUTHENTICATION ====================
window.selectRole = function(role) {
    if (role === 'admin') {
        showScreen('adminLoginScreen');
    } else if (role === 'teacher') {
        showScreen('teacherLoginScreen');
    } else {
        showScreen('studentLoginScreen');
    }
}

window.loginAdmin = async function() {
    const code = document.getElementById('adminCode').value.trim();
    const password = document.getElementById('adminPassword').value;
    if (!code || !password) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß');
    showLoading(true);
    try {
        const adminRef = doc(db, 'admins', code);
        const adminSnap = await getDoc(adminRef);
        if (!adminSnap.exists() || adminSnap.data().password !== password) {
            throw new Error('Sai m√£ ho·∫∑c m·∫≠t kh·∫©u');
        }
        currentUser = { role: 'admin', code };
        document.getElementById('adminCodeDisplay').textContent = code;
        showScreen('adminDashboard');
    } catch (error) {
        alert('L·ªói: ' + error.message);
    }
    showLoading(false);
};

window.loginTeacher = async function() {
    const code = document.getElementById('teacherCode').value.trim();
    const password = document.getElementById('teacherPassword').value;
    if (!code || !password) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß');
    showLoading(true);
    try {
        const teacherRef = doc(db, 'teachers', code);
        const teacherSnap = await getDoc(teacherRef);
        if (!teacherSnap.exists() || teacherSnap.data().password !== password) {
            throw new Error('Sai m√£ ho·∫∑c m·∫≠t kh·∫©u');
        }
        currentUser = { role: 'teacher', code, assignedClasses: teacherSnap.data().assignedClasses || [] };
        document.getElementById('teacherCodeDisplay').textContent = code;
        showScreen('teacherDashboard');
    } catch (error) {
        alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
    }
    showLoading(false);
}

window.loginStudent = async function() {
    const code = document.getElementById('studentCode').value.trim();
    if (!code) return alert('Vui l√≤ng nh·∫≠p m√£ h·ªçc sinh');
   
    showLoading(true);
    try {
        const studentsRef = collection(db, 'students');
        const q = query(studentsRef, where('code', '==', code));
        const snap = await getDocs(q);
       
        if (snap.empty) {
            showLoading(false);
            return alert('M√£ h·ªçc sinh kh√¥ng t·ªìn t·∫°i. Li√™n h·ªá gi√°o vi√™n!');
        }
       
        const studentData = snap.docs[0].data();
        currentUser = { role: 'student', code, id: snap.docs[0].id, ...studentData };
        document.getElementById('studentNameDisplay').textContent = studentData.name;
        await loadStudentAssignments();
        showScreen('studentDashboard');
    } catch (error) {
        alert('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
    }
    showLoading(false);
}

window.logout = function() {
    currentUser = null;
    showScreen('loginScreen');
}

// ==================== SYLLABLE ANALYSIS ====================
const PRECISE_SYLLABLE_DB = {
    // T·ª´ th∆∞·ªùng sai ‚Üí ∆∞u ti√™n cao nh·∫•t
    'fibre': ['fi', 'bre'],
    'fiber': ['fi', 'ber'],
    'necessary': ['nec', 'es', 'sa', 'ry'],
    'beautiful': ['beau', 'ti', 'ful'],
    'different': ['dif', 'fer', 'ent'],
    'important': ['im', 'por', 'tant'],
    'government': ['gov', 'ern', 'ment'],
    'environment': ['en', 'vi', 'ron', 'ment'],
    'development': ['de', 'vel', 'op', 'ment'],
    'information': ['in', 'for', 'ma', 'tion'],
    
    // T·ª´ trong b√†i t·∫≠p c·ªßa b·∫°n
    'carbohydrate': ['car', 'bo', 'hy', 'drate'],
    'vitamin': ['vi', 'ta', 'min'],
    'protein': ['pro', 'tein'],
    'exercise': ['ex', 'er', 'cise'],
    'healthy': ['heal', 'thy'],
    'diet': ['di', 'et'],
    'ship': ['ship'],
    'cat': ['cat'],
    'dog': ['dog'],
    'apple': ['ap', 'ple'],
    'banana': ['ba', 'na', 'na'],
    'orange': ['or', 'ange'],
    'water': ['wa', 'ter'],
    'something': ['some', 'thing'],
    'weight': ['weight'],
    'stomach': ['stom', 'ach'],
    'upset': ['up', 'set'],
    'casualty': ['cas', 'u', 'al', 'ty'],
    'department': ['de', 'part', 'ment']
};

// ‚úÖ THAY TH·∫æ HO√ÄN TO√ÄN function splitIntoSyllables
function splitIntoSyllables(word) {
    const original = word;
    word = word.toLowerCase().trim();
    
    // 1Ô∏è‚É£ ∆ØU TI√äN: Dictionary ch√≠nh x√°c 100%
    if (PRECISE_SYLLABLE_DB[word]) {
        return PRECISE_SYLLABLE_DB[word];
    }
    
    // 2Ô∏è‚É£ Hyphen.js - Ch√≠nh x√°c 92-95%
    try {
        if (window.hyphen && window.hyphen.en_us) {
            const hyphenated = window.hyphen.en_us.hyphenate(word);
            let syllables = hyphenated.split('-').filter(s => s.length > 0);
            
            // 3Ô∏è‚É£ Post-processing ƒë·ªÉ ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng
            if (syllables.length === 1 && word.length > 3) {
                // Fallback n·∫øu hyphen.js kh√¥ng t√°ch ƒë∆∞·ª£c
                syllables = smartFallbackSplit(word);
            }
            
            return syllables;
        }
    } catch (e) {
        console.warn('Hyphen.js error:', e);
    }
    
    // 4Ô∏è‚É£ Fallback th√¥ng minh
    return smartFallbackSplit(word);
}

function smartFallbackSplit(word) {
    // Thu·∫≠t to√°n c·∫£i ti·∫øn t·ª´ code c≈©
    if (word.length <= 3) return [word];
    
    const vowels = 'aeiouy';
    const syllables = [];
    let start = 0;
    
    for (let i = 1; i < word.length; i++) {
        const prevIsVowel = vowels.includes(word[i - 1]);
        const currIsVowel = vowels.includes(word[i]);
        
        // Quy t·∫Øc c·∫£i ti·∫øn: t√°ch tr∆∞·ªõc ph·ª• √¢m ƒë√¥i
        if (prevIsVowel && !currIsVowel && i < word.length - 1) {
            // Ki·ªÉm tra c·ª•m ph·ª• √¢m
            const nextTwo = word.substring(i, i + 2);
            const consonantClusters = ['bl', 'br', 'cl', 'cr', 'dr', 'fr', 'tr', 'pl', 'pr', 'str', 'spr'];
            
            if (!consonantClusters.includes(nextTwo)) {
                syllables.push(word.substring(start, i));
                start = i;
            }
        }
    }
    
    if (start < word.length) {
        syllables.push(word.substring(start));
    }
    
    return syllables.length > 0 ? syllables : [word];
}

function similarity(s1, s2) {
    if (!s1 || !s2) return 0;
    let longer = s1.length > s2.length ? s1 : s2;
    let shorter = s1.length > s2.length ? s2 : s1;
    if (longer.length === 0) return 1.0;
    return (longer.length - editDistance(longer, shorter)) / longer.length;
}

function editDistance(s1, s2) {
    s1 = s1.toLowerCase();
    s2 = s2.toLowerCase();
    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i === 0) costs[j] = j;
            else if (j > 0) {
                let newValue = costs[j - 1];
                if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                }
                costs[j - 1] = lastValue;
                lastValue = newValue;
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}

// ==================== WHISPER AI GRADING ====================
window.recordWord = async function(word) {
    const resultDiv = document.getElementById(`result-${word}`);
    
    // Ki·ªÉm tra API key
    if (HUGGING_FACE_API_KEY === 'YOUR_API_KEY_HERE') {
        resultDiv.innerHTML = `
            <div class="p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                <p class="text-yellow-800 font-bold">‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh API Key</p>
                <p class="text-sm text-yellow-700 mt-2">Vui l√≤ng:</p>
                <ol class="text-sm text-yellow-700 mt-2 ml-4 list-decimal">
                    <li>Truy c·∫≠p: <a href="https://huggingface.co/settings/tokens" target="_blank" class="text-blue-600 underline">huggingface.co/settings/tokens</a></li>
                    <li>T·∫°o token m·ªõi (New token)</li>
                    <li>Copy token v√† thay v√†o d√≤ng 137 trong code</li>
                </ol>
            </div>
        `;
        return;
    }
    
    // Ki·ªÉm tra quy·ªÅn microphone
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        resultDiv.innerHTML = `
            <div class="p-6 bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl text-center">
                <div class="animate-bounce inline-block w-16 h-16 bg-gradient-to-br from-green-500 to-blue-500 rounded-full mb-4 flex items-center justify-center">
                    <span class="text-2xl">üé§</span>
                </div>
                <p class="text-green-700 font-bold text-xl mb-1">üéôÔ∏è ƒêANG THU √ÇM...</p>
                <p class="text-sm text-green-600 mt-1">N√≥i r√µ t·ª´: <strong class="text-lg font-mono">${word}</strong></p>
                <div class="mt-4 flex justify-center space-x-2">
                    <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce"></div>
                    <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
                <button onclick="stopRecording('${word}')" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold">
                    ‚èπÔ∏è D·ª™NG & CH·∫§M ƒêI·ªÇM
                </button>
                <p class="text-xs text-gray-500 mt-2">Ho·∫∑c t·ª± ƒë·ªông sau 5 gi√¢y</p>
            </div>
        `;
        
        // B·∫Øt ƒë·∫ßu thu √¢m
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            stream.getTracks().forEach(track => track.stop());
            
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            
            // G·ª≠i l√™n Whisper AI ƒë·ªÉ ch·∫•m ƒëi·ªÉm
            await gradeWithWhisper(word, audioBlob, resultDiv);
        };
        
        mediaRecorder.start();
        
        // T·ª± ƒë·ªông d·ª´ng sau 5 gi√¢y
        setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording(word);
            }
        }, 5000);
        
    } catch (err) {
        resultDiv.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-600 font-bold">‚ùå Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p microphone</p>
                <p class="text-sm text-red-500 mt-1">Vui l√≤ng cho ph√©p microphone trong tr√¨nh duy·ªát</p>
            </div>
        `;
    }
}

window.stopRecording = function(word) {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
}

async function gradeWithWhisper(word, audioBlob, resultDiv) {
    resultDiv.innerHTML = `
        <div class="p-6 bg-purple-50 border-2 border-purple-200 rounded-xl text-center">
            <div class="animate-spin inline-block w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full mb-4"></div>
            <p class="text-purple-700 font-bold text-xl">ü§ñ AI ƒëang ch·∫•m ƒëi·ªÉm...</p>
        </div>
    `;
    
    try {
        // Convert audio sang base64
        const reader = new FileReader();
        const base64Audio = await new Promise((resolve, reject) => {
            reader.onloadend = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(audioBlob);
        });
        
        // URL Apps Script c·ªßa b·∫°n
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznNlh8Pu17U_ggJkOqHa_hU87acomNHkazEDw5-1evMBJbNWrDUaXHC0tLUURkyw6G/exec'; // ‚Üê THAY ƒê·ªîI
        
        const formData = new FormData();
        formData.append('audio', base64Audio);
        
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: formData,
            redirect: 'follow'
        });
        
        const text = await response.text();
        console.log('Raw response:', text);
        
        let result;
        try {
            result = JSON.parse(text);
        } catch (e) {
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                result = JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('Kh√¥ng parse ƒë∆∞·ª£c JSON');
            }
        }
        
        if (!result.success) {
            throw new Error(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
        
        const transcript = result.text.trim();
        
        if (!transcript) {
            throw new Error('Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c gi·ªçng n√≥i');
        }
        
        console.log('ü§ñ Whisper nh·∫≠n di·ªán:', transcript);
        
        const aspirationScore = await analyzeAspiration(audioBlob, word);
        const detailedAnalysis = analyzeDetailedPronunciation(word, transcript, aspirationScore);
        
        // L∆∞u result, c·∫≠p nh·∫≠t n·∫øu t·ªìn t·∫°i ƒë·ªÉ tƒÉng attemptCount
        const resultsRef = collection(db, 'results');
        const q = query(resultsRef, where('studentId', '==', currentUser.id), where('assignmentId', '==', currentAssignment.id), where('word', '==', word));
        const snap = await getDocs(q);
        if (!snap.empty) {
            const existingDoc = snap.docs[0];
            await updateDoc(existingDoc.ref, {
                score: detailedAnalysis.score,
                recognizedText: transcript,
                syllableAnalysis: detailedAnalysis,
                attemptCount: existingDoc.data().attemptCount ? existingDoc.data().attemptCount + 1 : 1,
                updatedAt: new Date()
            });
        } else {
            await addDoc(resultsRef, {
                studentId: currentUser.id,
                assignmentId: currentAssignment.id,
                word,
                score: detailedAnalysis.score,
                recognizedText: transcript,
                syllableAnalysis: detailedAnalysis,
                attemptCount: 1,
                method: 'whisper-ai',
                createdAt: new Date()
            });
        }
        
        displayDetailedResults(word, transcript, detailedAnalysis, resultDiv);
        updateProgress();
        
    } catch (error) {
        console.error('Whisper API Error:', error);
        resultDiv.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-600 font-bold">‚ùå L·ªói k·∫øt n·ªëi AI</p>
                <p class="text-sm text-red-500 mt-1">${error.message}</p>
                <p class="text-xs text-gray-500 mt-2">Debug: Xem Console (F12)</p>
                <button onclick="recordWord('${word}')" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">
                    üîÑ Th·ª≠ l·∫°i
                </button>
            </div>
        `;
    }
}

async function analyzeAspiration(audioBlob, word) {
    try {
        const arrayBuffer = await audioBlob.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        
        const channelData = audioBuffer.getChannelData(0);
        let maxEnergy = 0;
        let burstCount = 0;
        
        for (let i = 0; i < channelData.length; i += 44100 * 0.02) {
            let windowEnergy = 0;
            for (let j = 0; j < 882; j++) {
                windowEnergy += Math.abs(channelData[i + j] || 0);
            }
            windowEnergy /= 882;
            
            if (windowEnergy > 0.1 && windowEnergy > maxEnergy * 1.5) {
                burstCount++;
                maxEnergy = windowEnergy;
            }
        }
        
        const stopConsonants = (word.match(/[ptkbdg]/g) || []).length;
        const expectedBursts = Math.max(1, stopConsonants);
        
        return Math.min(100, Math.round((burstCount / expectedBursts) * 100));
    } catch (e) {
        console.error('Aspiration analysis error:', e);
        return 100; // Fallback
    }
}

function analyzeDetailedPronunciation(correctWord, spokenText, aspirationScore) {
    correctWord = correctWord.toLowerCase().trim();
    spokenText = spokenText.toLowerCase().trim();
    
    const correctSyllables = splitIntoSyllables(correctWord);
    const spokenWords = spokenText.split(' ');
    
    // T√¨m t·ª´ kh·ªõp nh·∫•t trong c√¢u n√≥i
    let bestMatch = spokenText;
    let bestSimilarity = similarity(correctWord, spokenText);
    
    for (const spokenWord of spokenWords) {
        const sim = similarity(correctWord, spokenWord);
        if (sim > bestSimilarity) {
            bestSimilarity = sim;
            bestMatch = spokenWord;
        }
    }
    
    const spokenSyllables = splitIntoSyllables(bestMatch);
    
    const analysis = {
        syllables: [],
        wrongSyllables: [],
        correctSyllables: [],
        score: 0,
        totalSyllables: correctSyllables.length,
        matchedWord: bestMatch,
        overallSimilarity: bestSimilarity,
        tAspirationScore: checkTAspiration(correctWord, spokenText),
        stressScore: checkWordStress(correctWord, spokenText)
    };
    
    // So s√°nh t·ª´ng √¢m ti·∫øt
    correctSyllables.forEach((syllable, index) => {
        const spokenSyllable = spokenSyllables[index] || '';
        const syllableSimilarity = similarity(syllable, spokenSyllable);
        const isCorrect = syllableSimilarity > 0.75;
        
        analysis.syllables.push({
            text: syllable,
            spoken: spokenSyllable,
            correct: isCorrect,
            similarity: Math.round(syllableSimilarity * 100),
            index: index
        });
        
        if (isCorrect) {
            analysis.correctSyllables.push(syllable);
        } else {
            analysis.wrongSyllables.push({
                text: syllable,
                spoken: spokenSyllable,
                similarity: Math.round(syllableSimilarity * 100)
            });
        }
    });
    
    // T√≠nh ƒëi·ªÉm chi ti·∫øt
    const syllableScore = (analysis.correctSyllables.length / analysis.totalSyllables) * 100;
    const similarityScore = bestSimilarity * 100;
    
    // Bonus cho kh·ªõp ho√†n to√†n
    let bonus = 0;
    if (bestMatch === correctWord) {
        bonus = 15;
    } else if (bestSimilarity > 0.9) {
        bonus = 10;
    }
    
    // Penalty cho sai qu√° nhi·ªÅu
    let penalty = 0;
    if (analysis.wrongSyllables.length > analysis.totalSyllables / 2) {
        penalty = 10;
    }
    
    // ƒêi·ªÉm cu·ªëi c√πng, k·∫øt h·ª£p aspiration v√† stress
    analysis.score = Math.round(
        Math.min(100, Math.max(0, 
            (syllableScore * 0.5 + similarityScore * 0.3) + bonus - penalty + (analysis.tAspirationScore * 0.1) + (analysis.stressScore * 0.1)
        ))
    );
    
    return analysis;
}

function checkTAspiration(correctWord, spokenText) {
    const tWords = ['time', 'top', 'table', 'take', 'tell', 'ten'];
    const hasT = tWords.some(w => correctWord.includes(w));
    
    if (!hasT) return 100;
    
    const tPattern = /t[aeiou]/i;
    const hasClearT = tPattern.test(spokenText);
    
    return hasClearT ? 100 : 60;
}

function checkWordStress(correctWord, spokenText) {
    const stressDB = {
        'fibre': 1,      // FI-bre
        'carbohydrate': 2, // car-bo-HY-drate  
        'protein': 2,    // pro-TEIN
        'vitamin': 1,    // VI-ta-min
        'exercise': 1,   // EX-er-cise
        // Th√™m nhi·ªÅu t·ª´...
    };
    
    const expectedStress = stressDB[correctWord.toLowerCase()];
    if (!expectedStress) return 100;
    
    // Simplified stress check based on syllable count and similarity
    const stressMatch = Math.min(100, 100 - Math.abs(splitIntoSyllables(correctWord).length - splitIntoSyllables(spokenText).length) * 20);
    return stressMatch;
}

function displayDetailedResults(word, transcript, analysis, resultDiv) {
    const score = analysis.score;
    const emoji = score >= 80 ? 'üéâ' : score >= 60 ? 'üëç' : 'üí™';
    const message = score >= 80 ? 'Xu·∫•t s·∫Øc! Ph√°t √¢m r·∫•t chu·∫©n!' : 
                   score >= 60 ? 'T·ªët l·∫Øm! C√≤n m·ªôt v√†i √¢m ti·∫øt c·∫ßn c·∫£i thi·ªán' : 
                   'C·ªë l√™n! H√£y nghe k·ªπ v√† th·ª≠ l·∫°i nh√©!';
    
    let html = `
        <div class="p-6 bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl shadow-2xl">
            <div class="text-center mb-6">
                <div class="inline-block w-24 h-24 bg-gradient-to-br ${
                    score >= 80 ? 'from-green-400 via-green-500 to-green-600' :
                    score >= 60 ? 'from-yellow-400 via-yellow-500 to-yellow-600' : 
                    'from-red-400 via-red-500 to-red-600'
                } rounded-full flex items-center justify-center mb-4 shadow-xl">
                    <span class="text-5xl">${emoji}</span>
                </div>
                
                <h3 class="text-5xl font-bold text-gray-800 mb-2">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600">${score}</span>
                </h3>
                <p class="text-xl font-semibold text-gray-700 mb-3">${message}</p>
                
                <div class="flex justify-center gap-4 text-sm">
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-semibold">
                        ‚úÖ ${analysis.correctSyllables.length}/${analysis.totalSyllables} √¢m ti·∫øt ƒë√∫ng
                    </span>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-semibold">
                        üéØ ${Math.round(analysis.overallSimilarity * 100)}% ƒë·ªô ch√≠nh x√°c
                    </span>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-lg p-4 border-2 border-gray-200">
                    <p class="text-sm text-gray-600 mb-2">üéØ T·ª´ ƒë√∫ng:</p>
                    <p class="text-2xl font-bold text-blue-700">${word}</p>
                </div>
                <div class="bg-white rounded-lg p-4 border-2 border-purple-200">
                    <p class="text-sm text-gray-600 mb-2">üé§ AI nghe ƒë∆∞·ª£c:</p>
                    <p class="text-2xl font-bold text-purple-700">${transcript}</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-5 mb-6 border-2 border-blue-200">
                <h4 class="font-bold text-lg mb-4 text-gray-800">üìä Ph√¢n t√≠ch t·ª´ng √¢m ti·∫øt:</h4>
                <div class="space-y-3">
    `;

    analysis.syllables.forEach((syl, idx) => {
        const bgColor = syl.correct ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300';
        const textColor = syl.correct ? 'text-green-700' : 'text-red-700';
        const icon = syl.correct ? '‚úÖ' : '‚ùå';
        
        html += `
            <div class="${bgColor} border-2 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xl font-bold ${textColor}">${icon} √Çm ti·∫øt ${idx + 1}</span>
                    <span class="text-sm font-semibold ${textColor}">${syl.similarity}% kh·ªõp</span>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <p class="text-gray-600 mb-1">ƒê√∫ng:</p>
                        <p class="font-bold text-blue-700 text-lg">${syl.text}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 mb-1">B·∫°n n√≥i:</p>
                        <p class="font-bold ${textColor} text-lg">${syl.spoken || '(kh√¥ng c√≥)'}</p>
                    </div>
                </div>
            </div>
        `;
    });

    html += `
                </div>
            </div>
    `;

    // G·ª£i √Ω luy·ªán t·∫≠p
    if (analysis.wrongSyllables.length > 0) {
        html += `
            <div class="bg-orange-50 border-2 border-orange-300 rounded-lg p-5 mb-6">
                <h4 class="font-bold text-lg mb-3 text-orange-800">üí° C·∫ßn luy·ªán th√™m:</h4>
                <div class="flex flex-wrap gap-2 mb-4">
        `;
        
        analysis.wrongSyllables.forEach(wrong => {
            html += `
                <span class="bg-orange-200 text-orange-800 px-4 py-2 rounded-full font-bold">
                    ${wrong.text} (${wrong.similarity}% kh·ªõp)
                </span>
            `;
        });
        
        html += `
                </div>
                 <button onclick="practiceWrongSyllables('${word}')"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-bold w-full">
                    üéØ Luy·ªán c√°c √¢m ti·∫øt sai
                </button>
            </div>
        `;
    } else {
        html += `
            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-5 mb-6 text-center">
                <p class="text-green-700 font-bold text-xl">üéä Ho√†n h·∫£o! T·∫•t c·∫£ √¢m ti·∫øt ƒë·ªÅu chu·∫©n!</p>
            </div>
        `;
    }

    html += `
            <div class="grid grid-cols-2 gap-3">
                <button onclick="speakSyllables('${word}')" class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold">
                    üîä Nghe t·ª´ng √¢m ti·∫øt
                </button>
                <button onclick="recordWord('${word}')" class="bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-bold">
                    üé§ Th·ª≠ l·∫°i
                </button>
            </div>
        </div>
    `;

    resultDiv.innerHTML = html;
}

// ==================== SPEECH FUNCTIONS ====================
window.speakWord = function(word, rate) {
const utterance = new SpeechSynthesisUtterance(word);
utterance.rate = rate;
utterance.lang = 'en-US';
utterance.volume = 1;
utterance.pitch = 1;
speechSynthesis.speak(utterance);
}
window.speakSyllables = function(word) {
const syllables = splitIntoSyllables(word);
let index = 0;
const speakNext = () => {
if (index < syllables.length) {
const syllable = syllables[index];
const utterance = new SpeechSynthesisUtterance(syllable);
utterance.rate = 0.5;
utterance.lang = 'en-US';
utterance.onend = () => {
index++;
setTimeout(speakNext, 1200);
};
speechSynthesis.speak(utterance);
}
};
speakNext();
}
window.practiceWrongSyllables = function(word) {
    speakWord(word, 0.1);
}

// ==================== ADMIN FUNCTIONS - HO√ÄN CH·ªàNH ====================
// TH√äM V√ÄO TR∆Ø·ªöC window.showManageStudents
window.showManageTeachers = async function() {
    showLoading(true);
    try {
        const teachersRef = collection(db, 'teachers');
        const snap = await getDocs(teachersRef);
        let html = `
            <h2 class="text-2xl font-bold mb-6">üë®‚Äçüè´ Qu·∫£n l√Ω Gi√°o vi√™n</h2>
            <button onclick="showAdminDashboard()" class="text-blue-600 mb-4">‚Üê Quay l·∫°i</button>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-xl">
                    <thead class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                        <tr>
                            <th class="px-6 py-4 text-left">M√£ GV</th>
                            <th class="px-6 py-4 text-left">T√™n</th>
                            <th class="px-6 py-4 text-left">L·ªõp ƒë∆∞·ª£c giao</th>
                            <th class="px-6 py-4 text-left">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
        `;
        
        snap.forEach(doc => {
            const teacher = doc.data();
            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-mono font-semibold">${doc.id}</td>
                    <td class="px-6 py-4">${teacher.name || 'Ch∆∞a c√≥ t√™n'}</td>
                    <td class="px-6 py-4">${teacher.assignedClasses?.length || 0}</td>
                    <td class="px-6 py-4">
                        <button onclick="editTeacher('${doc.id}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm">S·ª≠a</button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i danh s√°ch gi√°o vi√™n: ' + error.message);
    }
    showLoading(false);
};

window.editTeacher = async function(teacherId) {
    const name = prompt('T√™n gi√°o vi√™n m·ªõi:');
    if (!name) return;
    try {
        await updateDoc(doc(db, 'teachers', teacherId), { name });
        alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
        showManageTeachers();
    } catch (error) {
        alert('L·ªói: ' + error.message);
    }
};

// TH√äM V√ÄO TR∆Ø·ªöC window.showManageStudents
window.showManageClasses = async function() {
    showLoading(true);
    try {
        const classesRef = collection(db, 'classes');
        const snap = await getDocs(classesRef);
        let html = `
            <h2 class="text-2xl font-bold mb-6">üìö Qu·∫£n l√Ω L·ªõp h·ªçc</h2>
            <button onclick="showAdminDashboard()" class="text-blue-600 mb-4">‚Üê Quay l·∫°i</button>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        `;
        
        snap.forEach(doc => {
            const cls = doc.data();
            html += `
                <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
                    <h3 class="text-xl font-bold mb-3">${cls.name}</h3>
                    <p class="text-gray-600 mb-4">üë®‚Äçüéì ${cls.students?.length || 0} h·ªçc sinh</p>
                    <div class="flex gap-2">
                        <button onclick="editClass('${doc.id}')" class="flex-1 bg-blue-500 text-white py-2 rounded-lg text-sm">S·ª≠a</button>
                        <button onclick="deleteClass('${doc.id}')" class="flex-1 bg-red-500 text-white py-2 rounded-lg text-sm">X√≥a</button>
                    </div>
                </div>
            `;
        });
        
        html += `
            </div>
            <div class="mt-8 p-6 bg-green-50 rounded-xl">
                <h3 class="text-lg font-bold mb-4">‚ûï T·∫°o l·ªõp m·ªõi</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <input type="text" id="newClassName" placeholder="T√™n l·ªõp (VD: 10A1)" class="p-3 border rounded-lg">
                    <input type="text" id="newClassTeacher" placeholder="M√£ GV ch·ªß nhi·ªám" class="p-3 border rounded-lg">
                    <button onclick="createNewClass()" class="bg-green-500 text-white py-3 rounded-lg font-semibold">
                        T·∫°o l·ªõp
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i danh s√°ch l·ªõp: ' + error.message);
    }
    showLoading(false);
};

window.createNewClass = async function() {
    const name = document.getElementById('newClassName').value.trim();
    const teacher = document.getElementById('newClassTeacher').value.trim();
    if (!name) return alert('Vui l√≤ng nh·∫≠p t√™n l·ªõp');
    
    showLoading(true);
    try {
        await addDoc(collection(db, 'classes'), {
            name,
            teacherIds: teacher ? [teacher] : [],
            students: [],
            createdAt: new Date()
        });
        alert('T·∫°o l·ªõp th√†nh c√¥ng!');
        document.getElementById('newClassName').value = '';
        document.getElementById('newClassTeacher').value = '';
        showManageClasses();
    } catch (error) {
        alert('L·ªói: ' + error.message);
    }
    showLoading(false);
};

window.showManageStudents = async function() {
    showLoading(true);
    try {
        const classesRef = collection(db, 'classes');
        const snap = await getDocs(classesRef);
        let html = `
            <h2 class="text-2xl font-bold mb-6">üë®‚Äçüéì Qu·∫£n l√Ω H·ªçc sinh (To√†n b·ªô h·ªá th·ªëng)</h2>
            <button onclick="showAdminDashboard()" class="text-blue-600 mb-4">‚Üê Quay l·∫°i Dashboard</button>
            <div class="space-y-6">
        `;
        
        for (const classDoc of snap.docs) {
            const classData = classDoc.data();
            html += `
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-l-blue-500">
                    <h3 class="text-xl font-bold mb-4">${classData.name}</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-3">üìã Danh s√°ch h·ªçc sinh (${classData.students?.length || 0}):</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
            `;
            
            if (classData.students && classData.students.length > 0) {
                for (const studentId of classData.students) {
                    try {
                        const studentDoc = await getDoc(doc(db, 'students', studentId));
                        if (studentDoc.exists()) {
                            const student = studentDoc.data();
                            html += `
                                <div class="flex justify-between items-center p-3 bg-white rounded-lg border">
                                    <div>
                                        <span class="font-semibold">${student.name}</span>
                                        <span class="text-gray-600 ml-3">(${student.code})</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="editStudent('${studentId}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">S·ª≠a</button>
                                        <button onclick="removeStudentFromClass('${classDoc.id}', '${studentId}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm">X√≥a</button>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Error loading student:', error);
                    }
                }
            } else {
                html += '<p class="text-gray-500 italic">Ch∆∞a c√≥ h·ªçc sinh</p>';
            }
            
            html += `
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="addStudentToClass('${classDoc.id}')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold">
                            ‚ûï Th√™m h·ªçc sinh
                        </button>
                    </div>
                </div>
            `;
        }
        
        html += `
            </div>
            <div class="mt-8 p-6 bg-blue-50 rounded-xl">
                <h3 class="text-lg font-bold mb-4">‚ûï Th√™m h·ªçc sinh m·ªõi v√†o h·ªá th·ªëng</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <input type="text" id="globalStudentName" placeholder="T√™n h·ªçc sinh" class="p-3 border rounded-lg">
                    <input type="text" id="globalStudentCode" placeholder="M√£ HS (VD: HS001)" class="p-3 border rounded-lg">
                    <button onclick="addGlobalStudent()" class="bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold">
                        Th√™m HS m·ªõi
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i danh s√°ch h·ªçc sinh: ' + error.message);
    }
    showLoading(false);
};

window.addStudentToClass = async function(classId) {
    const name = prompt('T√™n h·ªçc sinh:');
    const code = prompt('M√£ h·ªçc sinh (VD: HS001):');
    if (!name || !code) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß');
    
    showLoading(true);
    try {
        // Ki·ªÉm tra h·ªçc sinh c√≥ t·ªìn t·∫°i kh√¥ng
        const studentsRef = collection(db, 'students');
        const q = query(studentsRef, where('code', '==', code));
        const snap = await getDocs(q);
        
        let studentId;
        if (snap.empty) {
            // T·∫°o h·ªçc sinh m·ªõi
            const studentRef = await addDoc(studentsRef, {
                name,
                code,
                createdAt: new Date()
            });
            studentId = studentRef.id;
        } else {
            studentId = snap.docs[0].id;
        }
        
        // Th√™m v√†o l·ªõp
        const classRef = doc(db, 'classes', classId);
        await updateDoc(classRef, {
            students: arrayUnion(studentId)
        });
        
        alert(`ƒê√£ th√™m ${name} v√†o l·ªõp!`);
        showManageStudents();
    } catch (error) {
        alert('L·ªói: ' + error.message);
    }
    showLoading(false);
};

window.addGlobalStudent = async function() {
    const name = document.getElementById('globalStudentName').value.trim();
    const code = document.getElementById('globalStudentCode').value.trim();
    if (!name || !code) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß');
    
    showLoading(true);
    try {
        await addDoc(collection(db, 'students'), {
            name,
            code,
            createdAt: new Date()
        });
        alert('Th√™m h·ªçc sinh th√†nh c√¥ng!');
        document.getElementById('globalStudentName').value = '';
        document.getElementById('globalStudentCode').value = '';
        showManageStudents();
    } catch (error) {
        alert('L·ªói: ' + error.message);
    }
    showLoading(false);
};

window.editStudent = async function(studentId) {
    const name = prompt('T√™n m·ªõi:');
    if (!name) return;
    showLoading(true);
    try {
        await updateDoc(doc(db, 'students', studentId), { name });
        alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
        showManageStudents();
    } catch (error) {
        alert('L·ªói: ' + error.message);
    }
    showLoading(false);
};

window.removeStudentFromClass = async function(classId, studentId) {
    if (!confirm('X√°c nh·∫≠n x√≥a h·ªçc sinh kh·ªèi l·ªõp?')) return;
    showLoading(true);
    try {
        await updateDoc(doc(db, 'classes', classId), {
            students: arrayRemove(studentId)
        });
        alert('X√≥a th√†nh c√¥ng!');
        showManageStudents();
    } catch (error) {
        alert('L·ªói: ' + error.message);
    }
    showLoading(false);
};

window.showReports = async function() {
    showLoading(true);
    try {
        // 1. Th·ªëng k√™ t·ªïng quan
        const classesSnap = await getDocs(collection(db, 'classes'));
        const assignmentsSnap = await getDocs(collection(db, 'assignments'));
        const resultsSnap = await getDocs(collection(db, 'results'));
        
        const classCount = classesSnap.size;
        const assignmentCount = assignmentsSnap.size;
        const resultCount = resultsSnap.size;
        
        let html = `
            <h2 class="text-3xl font-bold mb-6">üìä B√ÅO C√ÅO CHI TI·∫æT</h2>
            <button onclick="showAdminDashboard()" class="text-blue-600 mb-6">‚Üê Quay l·∫°i Dashboard</button>
            
            <!-- T·ªïng quan -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl text-center">
                    <h3 class="text-3xl font-bold">${classCount}</h3>
                    <p class="text-blue-100">T·ªïng s·ªë l·ªõp</p>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl text-center">
                    <h3 class="text-3xl font-bold">${assignmentCount}</h3>
                    <p class="text-green-100">T·ªïng b√†i t·∫≠p</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl text-center">
                    <h3 class="text-3xl font-bold">${resultCount}</h3>
                    <p class="text-purple-100">T·ªïng l∆∞·ª£t luy·ªán</p>
                </div>
            </div>
        `;
        
        // 2. Ho·∫°t ƒë·ªông gi√°o vi√™n (t·∫ßn su·∫•t giao b√†i)
        html += `
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold mb-4">üìà Ho·∫°t ƒë·ªông giao b√†i c·ªßa Gi√°o vi√™n</h3>
        `;
        
        const teacherActivities = {};
        for (const assignmentDoc of assignmentsSnap.docs) {
            const assignment = assignmentDoc.data();
            const teacherCode = assignment.teacherCode;
            if (!teacherActivities[teacherCode]) {
                teacherActivities[teacherCode] = { count: 0, lastAssignment: null };
            }
            teacherActivities[teacherCode].count++;
            teacherActivities[teacherCode].lastAssignment = assignment.createdAt?.toDate() || new Date();
        }
        
        html += '<div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200">';
        html += `
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gi√°o vi√™n</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">S·ªë b√†i t·∫≠p</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">B√†i g·∫ßn nh·∫•t</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">T·∫ßn su·∫•t</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
        `;
        
        Object.entries(teacherActivities).forEach(([teacherCode, stats]) => {
            const daysSinceLast = Math.round((new Date() - stats.lastAssignment) / (1000 * 60 * 60 * 24));
            const frequency = daysSinceLast > 0 ? Math.round(stats.count / (daysSinceLast / 7)) : 'R·∫•t t√≠ch c·ª±c';
            html += `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${teacherCode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stats.count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${daysSinceLast} ng√†y tr∆∞·ªõc</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                            frequency === 'R·∫•t t√≠ch c·ª±c' ? 'bg-green-100 text-green-800' :
                            frequency > 2 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                        }">${frequency} b√†i/tu·∫ßn</span>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div></div>';
        
        // 3. T·ª´ sai nhi·ªÅu nh·∫•t (avg < 80%)
        const wordStats = {};
        for (const resultDoc of resultsSnap.docs) {
            const result = resultDoc.data();
            const word = result.word;
            if (!wordStats[word]) {
                wordStats[word] = { totalScore: 0, count: 0, students: new Set() };
            }
            wordStats[word].totalScore += result.score;
            wordStats[word].count++;
            wordStats[word].students.add(result.studentId);
        }
        
        const problematicWords = Object.entries(wordStats)
            .filter(([word, stats]) => (stats.totalScore / stats.count) < 80)
            .sort(([,a], [,b]) => (b.totalScore / b.count) - (a.totalScore / a.count))
            .slice(0, 10);
        
        html += `
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold mb-4">üö® 10 T·ª™ SAI NHI·ªÄU NH·∫§T (ƒêi·ªÉm TB < 80%)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-red-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase">T·ª´</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase">ƒêi·ªÉm TB</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase">S·ªë HS sai</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase">T·ª∑ l·ªá sai</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
        `;
        
        problematicWords.forEach(([word, stats]) => {
            const avgScore = Math.round(stats.totalScore / stats.count);
            const failRate = Math.round((stats.students.size / classCount) * 100);
            html += `
                <tr class="hover:bg-red-50">
                    <td class="px-6 py-4 whitespace-nowrap font-mono font-semibold text-lg text-red-800">${word}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-red-600 font-bold">${avgScore}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stats.students.size}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">${failRate}%</span>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div></div>';
        
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i b√°o c√°o: ' + error.message);
    }
    showLoading(false);
};

window.showAdminDashboard = function() {
    document.getElementById('adminCodeDisplay').textContent = currentUser.code;
    showScreen('adminDashboard');
};

// ==================== TEACHER FUNCTIONS - C·∫¨P NH·∫¨T ====================

window.showMyClasses = async function() {
    showLoading(true);
    try {
        const classesRef = collection(db, 'classes');
        const q = query(classesRef, where('teacherIds', 'array-contains', currentUser.code));
        const snap = await getDocs(q);
        let html = '<h2 class="text-2xl font-bold mb-6">üìö L·ªõp h·ªçc c·ªßa t√¥i</h2><div class="space-y-4">';
   
        if (snap.empty) {
            html += '<p class="text-gray-600 text-center py-12 text-lg">B·∫°n ch∆∞a ƒë∆∞·ª£c ph√¢n l·ªõp n√†o. Li√™n h·ªá Admin!</p>';
        } else {
            snap.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="bg-white border rounded-xl p-6 hover:shadow-xl transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-2xl font-bold text-gray-800">${data.name}</h3>
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                ${data.students?.length || 0} HS
                            </span>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <button onclick="manageStudents('${doc.id}', '${data.name}')" 
                                    class="bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold transition">
                                üë• Qu·∫£n l√Ω h·ªçc sinh
                            </button>
                            <button onclick="viewDetailedStats('${doc.id}', '${data.name}')" 
                                    class="bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-semibold transition">
                                üìä Xem b√°o c√°o chi ti·∫øt
                            </button>
                        </div>
                    </div>
                `;
            });
        }
   
        html += '</div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i danh s√°ch l·ªõp: ' + error.message);
    }
    showLoading(false);
};

window.manageStudents = async function(classId, className) {
    showLoading(true);
    try {
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const students = classDoc.data().students || [];
        
        let html = `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üë• Qu·∫£n l√Ω h·ªçc sinh - ${className}</h2>
                    <button onclick="showMyClasses()" class="text-blue-600 hover:text-blue-700">‚Üê Quay l·∫°i</button>
                </div>
                
                <!-- Th√™m h·ªçc sinh m·ªõi -->
                <div class="bg-blue-50 p-6 rounded-xl">
                    <h3 class="font-bold mb-4 text-blue-800">‚ûï Th√™m h·ªçc sinh m·ªõi</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <input type="text" id="newStudentName_${classId}" placeholder="T√™n h·ªçc sinh" class="p-3 border rounded-lg">
                        <input type="text" id="newStudentCode_${classId}" placeholder="M√£ HS (VD: HS001)" class="p-3 border rounded-lg">
                        <button onclick="addStudentToClass('${classId}')" 
                                class="bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold">
                            ‚ûï Th√™m v√†o l·ªõp
                        </button>
                    </div>
                </div>
                
                <!-- Danh s√°ch h·ªçc sinh -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="font-bold mb-4">üìã Danh s√°ch h·ªçc sinh (${students.length})</h3>
        `;
        
        if (students.length === 0) {
            html += '<p class="text-gray-500 italic py-8 text-center">Ch∆∞a c√≥ h·ªçc sinh n√†o</p>';
        } else {
            html += '<div class="space-y-3">';
            for (const stId of students) {
                try {
                    const stDoc = await getDoc(doc(db, 'students', stId));
                    if (stDoc.exists()) {
                        const st = stDoc.data();
                        html += `
                            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border-l-4 border-l-green-400 hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                                        <span class="text-green-600 font-semibold">üë®‚Äçüéì</span>
                                    </div>
                                    <div>
                                        <span class="font-bold text-gray-900">${st.name}</span>
                                        <span class="text-gray-600 ml-3 text-sm">(${st.code})</span>
                                    </div>
                                </div>
                                <button onclick="removeStudent('${classId}', '${stId}')" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                                    X√≥a kh·ªèi l·ªõp
                                </button>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('L·ªói t·∫£i h·ªçc sinh:', error);
                }
            }
            html += '</div>';
        }
        
        html += `
                </div>
            </div>
        `;
        
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i danh s√°ch h·ªçc sinh: ' + error.message);
    }
    showLoading(false);
};

window.addStudentToClass = async function(classId) {
    const nameInput = document.getElementById(`newStudentName_${classId}`);
    const codeInput = document.getElementById(`newStudentCode_${classId}`);
    
    const name = nameInput.value.trim();
    const code = codeInput.value.trim();
    
    if (!name || !code) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
    
    showLoading(true);
    try {
        // Ki·ªÉm tra h·ªçc sinh c√≥ t·ªìn t·∫°i kh√¥ng
        const studentsRef = collection(db, 'students');
        const q = query(studentsRef, where('code', '==', code));
        const snap = await getDocs(q);
        
        let studentId;
        if (snap.empty) {
            // T·∫°o h·ªçc sinh m·ªõi
            const studentRef = await addDoc(studentsRef, {
                name,
                code,
                classId,
                createdAt: new Date()
            });
            studentId = studentRef.id;
        } else {
            studentId = snap.docs[0].id;
        }
        
        // Th√™m v√†o l·ªõp
        const classRef = doc(db, 'classes', classId);
        await updateDoc(classRef, {
            students: arrayUnion(studentId)
        });
        
        alert(`ƒê√£ th√™m ${name} (${code}) v√†o l·ªõp!`);
        nameInput.value = '';
        codeInput.value = '';
        manageStudents(classId, 'L·ªõp');
    } catch (error) {
        alert('L·ªói th√™m h·ªçc sinh: ' + error.message);
    }
    showLoading(false);
};

window.removeStudent = async function(classId, studentId) {
    if (!confirm('X√°c nh·∫≠n x√≥a h·ªçc sinh kh·ªèi l·ªõp?')) return;
    
    showLoading(true);
    try {
        await updateDoc(doc(db, 'classes', classId), {
            students: arrayRemove(studentId)
        });
        alert('X√≥a th√†nh c√¥ng!');
        manageStudents(classId, 'L·ªõp');
    } catch (error) {
        alert('L·ªói x√≥a h·ªçc sinh: ' + error.message);
    }
    showLoading(false);
};

window.viewDetailedStats = async function(classId, className) {
    showLoading(true);
    try {
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const studentIds = classDoc.data().students || [];
        const assignmentsRef = collection(db, 'assignments');
        const qAssign = query(assignmentsRef, where('classId', '==', classId));
        const assignSnap = await getDocs(qAssign);
        
        let html = `
            <div class="space-y-8">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">üìä B√°o c√°o chi ti·∫øt - ${className}</h2>
                    <button onclick="showMyClasses()" class="text-blue-600 hover:text-blue-700">‚Üê Quay l·∫°i</button>
                </div>
        `;
        
        if (assignSnap.empty) {
            html += '<p class="text-gray-600 text-center py-12 text-lg">Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c giao.</p>';
        } else {
            for (const assignDoc of assignSnap.docs) {
                const assign = assignDoc.data();
                const wordCount = assign.wordsData ? assign.wordsData.length : 0;
                
                html += `
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h3 class="text-xl font-bold mb-6">${assign.name}</h3>
                        <p class="text-gray-600 mb-6">üìù S·ªë t·ª´: ${wordCount} | ‚è∞ Giao: ${assign.createdAt?.toDate().toLocaleDateString('vi-VN')}</p>
                `;
                
                // Th·ªëng k√™ t·ª´ng h·ªçc sinh
                html += `
                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">H·ªçc sinh</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">Ti·∫øn ƒë·ªô</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">ƒêi·ªÉm TB</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">L∆∞·ª£t luy·ªán</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">T·ª´ sai nhi·ªÅu</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                `;
                
                for (const stId of studentIds) {
                    try {
                        const stDoc = await getDoc(doc(db, 'students', stId));
                        if (!stDoc.exists()) continue;
                        
                        const student = stDoc.data();
                        
                        const resultsRef = collection(db, 'results');
                        const qResults = query(resultsRef,
                            where('studentId', '==', stId),
                            where('assignmentId', '==', assignDoc.id)
                        );
                        const resultsSnap = await getDocs(qResults);
                        
                        let completed = 0;
                        let totalScore = 0;
                        let attempts = 0;
                        const wordStats = {};
                        
                        resultsSnap.forEach(rDoc => {
                            const r = rDoc.data();
                            if (r.score >= 60) completed++;
                            totalScore += r.score;
                            attempts++;
                            
                            // Th·ªëng k√™ t·ª´ sai
                            const word = r.word;
                            if (!wordStats[word]) wordStats[word] = { score: 0, attempts: 0 };
                            wordStats[word].score += r.score;
                            wordStats[word].attempts++;
                        });
                        
                        const avgScore = attempts > 0 ? Math.round(totalScore / attempts) : 0;
                        const progress = wordCount > 0 ? Math.round((completed / wordCount) * 100) : 0;
                        
                        // T√¨m 2 t·ª´ sai nhi·ªÅu nh·∫•t
                        const worstWords = Object.entries(wordStats)
                            .filter(([_, stats]) => (stats.score / stats.attempts) < 80)
                            .sort(([,a], [,b]) => (a.score / a.attempts) - (b.score / b.attempts))
                            .slice(0, 2)
                            .map(([word]) => word)
                            .join(', ');
                        
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${student.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="w-24 bg-green-100 rounded-full p-1 text-center text-sm font-semibold text-green-800">
                                        ${progress}%
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="font-semibold ${avgScore >= 80 ? 'text-green-600' : avgScore >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                        ${avgScore}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${attempts}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-mono">${worstWords || 'Kh√¥ng c√≥'}</td>
                            </tr>
                        `;
                    } catch (error) {
                        console.error('L·ªói t·∫£i th·ªëng k√™ h·ªçc sinh:', error);
                    }
                }
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // T·ª´ sai nhi·ªÅu c·ªßa c·∫£ l·ªõp
                const classWordStats = {};
                const allClassResults = await getDocs(query(
                    collection(db, 'results'),
                    where('assignmentId', '==', assignDoc.id)
                ));
                
                allClassResults.forEach(rDoc => {
                    const r = rDoc.data();
                    const word = r.word;
                    if (!classWordStats[word]) {
                        classWordStats[word] = { totalScore: 0, count: 0, students: new Set() };
                    }
                    classWordStats[word].totalScore += r.score;
                    classWordStats[word].count++;
                    classWordStats[word].students.add(r.studentId);
                });
                
                const classProblematicWords = Object.entries(classWordStats)
                    .filter(([_, stats]) => (stats.totalScore / stats.count) < 80)
                    .sort(([,a], [,b]) => (a.totalScore / a.count) - (b.totalScore / b.count))
                    .slice(0, 5);
                
                if (classProblematicWords.length > 0) {
                    html += `
                        <div class="bg-red-50 border border-red-200 rounded-xl p-6 mt-6">
                            <h4 class="font-bold text-lg text-red-800 mb-4">üö® T·ª´ c·∫ßn luy·ªán th√™m (C·∫£ l·ªõp)</h4>
                            <div class="grid md:grid-cols-5 gap-4">
                    `;
                    
                    classProblematicWords.forEach(([word, stats]) => {
                        const avgScore = Math.round(stats.totalScore / stats.count);
                        const failRate = Math.round((stats.students.size / studentIds.length) * 100);
                        html += `
                            <div class="bg-white rounded-lg p-4 text-center border-2 border-red-200">
                                <div class="font-mono font-bold text-lg text-red-700 mb-2">${word}</div>
                                <div class="text-sm text-red-600 mb-1">ƒêi·ªÉm TB: ${avgScore}</div>
                                <div class="text-xs text-red-500">${failRate}% HS sai</div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
                
                html += '</div>';
            }
        }
        
        html += '</div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('L·ªói t·∫£i b√°o c√°o chi ti·∫øt: ' + error.message);
    }
    showLoading(false);
};

// Th√™m function quay l·∫°i dashboard admin
window.showAdminDashboard = function() {
    document.getElementById('adminCodeDisplay').textContent = currentUser.code;
    showScreen('adminDashboard');
};

// ==================== STUDENT FUNCTIONS - HO√ÄN CH·ªàNH ====================

async function loadStudentAssignments() {
    showLoading(true);
    try {
        // T√¨m t·∫•t c·∫£ l·ªõp c·ªßa h·ªçc sinh
        const classesRef = collection(db, 'classes');
        const classesSnap = await getDocs(classesRef);
        
        let studentClasses = [];
        for (const classDoc of classesSnap.docs) {
            const classData = classDoc.data();
            if (classData.students && classData.students.includes(currentUser.id)) {
                studentClasses.push({ id: classDoc.id, ...classData });
            }
        }
        
        // T·∫£i b√†i t·∫≠p c·ªßa c√°c l·ªõp
        let allAssignments = [];
        for (const classObj of studentClasses) {
            const assignmentsRef = collection(db, 'assignments');
            const q = query(
                assignmentsRef, 
                where('classId', '==', classObj.id),
                orderBy('createdAt', 'desc')
            );
            const assignSnap = await getDocs(q);
            
            assignSnap.forEach(doc => {
                const data = doc.data();
                allAssignments.push({
                    id: doc.id,
                    className: classObj.name,
                    ...data
                });
            });
        }
        
        // Hi·ªÉn th·ªã b√†i t·∫≠p
        displayStudentAssignments(allAssignments);
        
    } catch (error) {
        console.error('L·ªói t·∫£i b√†i t·∫≠p:', error);
        document.getElementById('studentAssignments').innerHTML = `
            <div class="col-span-full text-center py-12">
                <p class="text-gray-500 text-lg">üìö Ch∆∞a c√≥ b√†i t·∫≠p n√†o</p>
                <p class="text-gray-400 text-sm mt-2">Li√™n h·ªá gi√°o vi√™n ƒë·ªÉ ƒë∆∞·ª£c giao b√†i t·∫≠p!</p>
            </div>
        `;
    }
    showLoading(false);
}

function displayStudentAssignments(assignments) {
    const container = document.getElementById('studentAssignments');
    
    if (assignments.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-16 bg-white rounded-xl shadow-lg">
                <div class="text-6xl mb-4">üìö</div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Ch∆∞a c√≥ b√†i t·∫≠p</h3>
                <p class="text-gray-600 mb-6">Li√™n h·ªá gi√°o vi√™n ƒë·ªÉ ƒë∆∞·ª£c giao b√†i t·∫≠p luy·ªán ph√°t √¢m!</p>
                <div class="text-sm text-gray-500 space-y-1">
                    <p>‚Ä¢ Gi√°o vi√™n s·∫Ω giao b√†i t·∫≠p qua h·ªá th·ªëng</p>
                    <p>‚Ä¢ M·ªói b√†i t·∫≠p c√≥ 10-20 t·ª´ c·∫ßn luy·ªán</p>
                    <p>‚Ä¢ AI s·∫Ω ch·∫•m ƒëi·ªÉm t·ª± ƒë·ªông</p>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '';
    assignments.forEach(assignment => {
        const wordsData = assignment.wordsData || [];
        const totalWords = wordsData.length;
        
        // T√≠nh ti·∫øn ƒë·ªô
        let completed = 0, totalScore = 0, attempts = 0;
        wordsData.forEach(wordObj => {
            const word = wordObj.word;
            // T√¨m k·∫øt qu·∫£ t·ªët nh·∫•t c·ªßa t·ª´ n√†y
            // (Logic s·∫Ω ƒë∆∞·ª£c implement trong startAssignment)
        });
        
        html += `
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 group">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4 text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold">${assignment.name}</h3>
                            <p class="text-blue-100 text-sm mt-1">${assignment.className}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm opacity-90">Giao ng√†y</p>
                            <p class="font-semibold">${assignment.createdAt?.toDate().toLocaleDateString('vi-VN') || 'H√¥m nay'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-green-600 mb-1">${totalWords}</div>
                            <p class="text-green-700 text-sm font-medium">T·ª™ C·∫¶N LUY·ªÜN</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 text-center">
                            <div class="text-3xl font-bold text-blue-600 mb-1">0</div>
                            <p class="text-blue-700 text-sm font-medium">ƒê√É HO√ÄN TH√ÄNH</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">ƒêi·ªÉm trung b√¨nh</span>
                            <span class="text-2xl font-bold text-gray-900">0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <button onclick="startAssignment('${assignment.id}')" 
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
                        üéØ B·∫ÆT ƒê·∫¶U LUY·ªÜN T·∫¨P
                    </button>
                    
                    <button onclick="viewAssignmentDetails('${assignment.id}')" 
                            class="w-full mt-3 bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold transition-colors">
                        üëÅÔ∏è Xem chi ti·∫øt b√†i t·∫≠p
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}
window.startAssignment = async function(assignmentId) {
    showLoading(true);
    try {
        // L·∫•y th√¥ng tin b√†i t·∫≠p
        const assignDoc = await getDoc(doc(db, 'assignments', assignmentId));
        if (!assignDoc.exists()) {
            throw new Error('B√†i t·∫≠p kh√¥ng t·ªìn t·∫°i');
        }
        
        currentAssignment = {
            id: assignmentId,
            ...assignDoc.data()
        };
        
        // T·∫£i k·∫øt qu·∫£ ƒë√£ l√†m ƒë·ªÉ t√≠nh ti·∫øn ƒë·ªô
        const resultsRef = collection(db, 'results');
        const q = query(
            resultsRef,
            where('studentId', '==', currentUser.id),
            where('assignmentId', '==', assignmentId)
        );
        const resultsSnap = await getDocs(q);
        
        const resultsMap = {};
        resultsSnap.forEach(doc => {
            const data = doc.data();
            resultsMap[data.word] = {
                bestScore: data.score,
                attempts: data.attemptCount || 1,
                lastResult: data
            };
        });
        
        // S·∫Øp x·∫øp t·ª´: ∆∞u ti√™n t·ª´ ch∆∞a l√†m ‚Üí t·ª´ ƒëi·ªÉm th·∫•p ‚Üí t·ª´ ƒëi·ªÉm cao
        const wordsData = currentAssignment.wordsData || [];
        const sortedWords = wordsData
            .map(wordObj => {
                const word = wordObj.word;
                const result = resultsMap[word];
                return {
                    ...wordObj,
                    bestScore: result ? result.bestScore : 0,
                    attempts: result ? result.attempts : 0,
                    isCompleted: result && result.bestScore >= 80
                };
            })
            .sort((a, b) => {
                if (!a.isCompleted && b.isCompleted) return -1;
                if (a.isCompleted && !b.isCompleted) return 1;
                if (!a.bestScore && b.bestScore) return -1;
                if (a.bestScore && !b.bestScore) return 1;
                return (b.bestScore || 0) - (a.bestScore || 0);
            });
        
        // Hi·ªÉn th·ªã m√†n h√¨nh luy·ªán t·∫≠p
        displayPracticeScreen(currentAssignment, sortedWords, resultsMap);
        showScreen('practiceScreen');
        
    } catch (error) {
        alert('L·ªói t·∫£i b√†i t·∫≠p: ' + error.message);
    }
    showLoading(false);
}

function displayPracticeScreen(assignment, words, resultsMap) {
    document.getElementById('assignmentTitle').textContent = assignment.name;
    
    // C·∫≠p nh·∫≠t progress
    const totalWords = words.length;
    const completedWords = words.filter(w => w.isCompleted).length;
    document.getElementById('progressText').textContent = `${completedWords}/${totalWords}`;
    
    // T√≠nh ƒëi·ªÉm trung b√¨nh
    const avgScore = words
        .filter(w => w.bestScore > 0)
        .reduce((sum, w) => sum + w.bestScore, 0) / Math.max(1, words.filter(w => w.bestScore > 0).length);
    document.getElementById('avgScoreText').textContent = Math.round(avgScore) || 0;
    
    // Hi·ªÉn th·ªã danh s√°ch t·ª´
    const container = document.getElementById('wordsList');
    let html = '';
    
    words.forEach((wordObj, index) => {
        const word = wordObj.word;
        const result = resultsMap[word];
        const bestScore = result ? result.bestScore : 0;
        const attempts = result ? result.attempts : 0;
        const isCompleted = bestScore >= 80;
        
        html += `
            <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 group relative overflow-hidden">
                <!-- Badge ho√†n th√†nh -->
                ${isCompleted ? `
                    <div class="absolute top-4 right-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-3 py-1 rounded-full text-sm font-bold shadow-lg">
                        ‚úÖ HO√ÄN TH√ÄNH
                    </div>
                ` : ''}
                
                <!-- Th√¥ng tin t·ª´ -->
                <div class="text-center mb-6">
                    <div class="inline-block w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mb-4 shadow-lg group-hover:scale-110 transition-transform">
                        <span class="text-2xl font-bold text-white">üé§</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">${word}</h3>
                    
                    <!-- √Çm ti·∫øt -->
                    <div class="flex justify-center flex-wrap gap-2 mb-4">
                        ${splitIntoSyllables(word).map(syl => 
                            `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">${syl}</span>`
                        ).join('')}
                    </div>
                </div>
                
                <!-- Progress c·ªßa t·ª´ n√†y -->
                <div class="space-y-4 mb-6">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">ƒêi·ªÉm cao nh·∫•t</span>
                        <span class="font-bold ${
                            bestScore >= 80 ? 'text-green-600' :
                            bestScore >= 60 ? 'text-yellow-600' : 'text-red-600'
                        }">
                            ${bestScore || 0}
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-700" 
                             style="width: ${Math.max(5, (bestScore || 0) / 100 * 100)}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>L·∫ßn luy·ªán: ${attempts}</span>
                        <span class="font-mono">${Math.round((bestScore || 0))}%</span>
                    </div>
                </div>
                
                <!-- N√∫t h√†nh ƒë·ªông -->
                <div class="space-y-3">
                    <button onclick="recordWord('${word}')" 
                            class="w-full bg-gradient-to-r ${
                                isCompleted ? 'from-emerald-500 to-green-600' :
                                bestScore >= 60 ? 'from-yellow-500 to-orange-600' :
                                'from-red-500 to-pink-600'
                            } hover:from-red-600 hover:to-pink-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-3">
                        ${isCompleted ? 'üéâ LUY·ªÜN L·∫†I' : 'üé§ LUY·ªÜN T·∫¨P'}
                        <span class="group-hover:scale-110 transition-transform">‚Üí</span>
                    </button>
                    
                    <div class="flex gap-3 pt-3">
                        <button onclick="speakWord('${word}', 0.8)" 
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                            üîä NGHE M·∫™U
                        </button>
                        <button onclick="speakSyllables('${word}')" 
                                class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-semibold transition-colors flex items-center justify-center gap-2">
                            üìù NGHE T·ª™NG √ÇM
                        </button>
                    </div>
                </div>
                
                <!-- K·∫øt qu·∫£ g·∫ßn nh·∫•t -->
                ${result ? `
                    <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border-l-4 border-l-blue-400">
                        <p class="text-xs text-gray-500 mb-2">üéØ L·∫ßn luy·ªán g·∫ßn nh·∫•t:</p>
                        <p class="text-sm">
                            <span class="font-mono">${result.recognizedText || 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c'}</span>
                            <span class="ml-2 text-blue-600 font-semibold">(${result.score}/100)</span>
                        </p>
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Auto-scroll to first incomplete word
    setTimeout(() => {
        const firstIncomplete = container.querySelector('[onclick*="recordWord"]:not([class*="HO√ÄN TH√ÄNH"])');
        if (firstIncomplete) {
            firstIncomplete.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 500);
}

window.viewAssignmentDetails = async function(assignmentId) {
    showLoading(true);
    try {
        const assignDoc = await getDoc(doc(db, 'assignments', assignmentId));
        const assignment = assignDoc.data();
        const wordsData = assignment.wordsData || [];
        
        let html = `
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">üìã Chi ti·∫øt b√†i t·∫≠p</h2>
                    <button onclick="backToStudent()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold">
                        ‚Üê Quay l·∫°i
                    </button>
                </div>
                
                <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
                    <h3 class="text-2xl font-bold mb-4">${assignment.name}</h3>
                    <div class="grid md:grid-cols-3 gap-6 text-sm">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <p class="text-blue-700 font-semibold">üìö L·ªõp h·ªçc</p>
                            <p class="text-gray-900">${assignment.className || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl">
                            <p class="text-green-700 font-semibold">üìù S·ªë t·ª´</p>
                            <p class="text-gray-900 font-bold text-2xl">${wordsData.length}</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl">
                            <p class="text-purple-700 font-semibold">‚è∞ Giao ng√†y</p>
                            <p class="text-gray-900">${assignment.createdAt?.toDate().toLocaleDateString('vi-VN') || 'H√¥m nay'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 text-white">
                        <h4 class="text-xl font-bold">üìö DANH S√ÅCH T·ª™ V·ª∞NG</h4>
                    </div>
                    <div class="divide-y divide-gray-200">
        `;
        
        wordsData.forEach((wordObj, index) => {
            const word = wordObj.word;
            const syllables = splitIntoSyllables(word);
            
            html += `
                <div class="p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                                    <span class="text-white font-bold text-lg">${index + 1}</span>
                                </div>
                                <div>
                                    <h5 class="text-xl font-bold text-gray-900">${word}</h5>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        ${syllables.map(syl => 
                                            `<span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium">${syl}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                            ${wordObj.meaning ? `
                                <p class="text-gray-600 italic ml-16">üí° ${wordObj.meaning}</p>
                            ` : ''}
                        </div>
                        <div class="text-right ml-6">
                            <button onclick="speakWord('${word}', 0.8)" 
                                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-xl font-semibold transition-colors flex items-center gap-2">
                                üîä Nghe
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('teacherContent').innerHTML = html; // Reuse teacherContent for details
        showScreen('teacherDashboard'); // Show in teacher dashboard area
        
    } catch (error) {
        alert('L·ªói t·∫£i chi ti·∫øt: ' + error.message);
    }
    showLoading(false);
}

window.backToStudent = function() {
    showScreen('studentDashboard');
    loadStudentAssignments(); // Refresh assignments
}

// C·∫≠p nh·∫≠t function logout ƒë·ªÉ reset assignment
window.logout = function() {
    currentUser = null;
    currentAssignment = null;
    showScreen('loginScreen');
}

// ==================== INITIALIZATION & EVENT LISTENERS ====================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üåü Luy·ªán Ph√°t √Çm App - Kh·ªüi t·∫°o th√†nh c√¥ng!');
    
    // 1. KH·ªûI T·∫†O HYPHENATION
    initializeHyphenation();
    
    // 2. AUTO-LOAD KHI CHUY·ªÇN SCREEN
    const screenObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const target = mutation.target;
                
                // STUDENT DASHBOARD
                if (target.id === 'studentDashboard' && 
                    !target.classList.contains('hidden') && 
                    currentUser?.role === 'student') {
                    console.log('üë®‚Äçüéì Auto-load student assignments');
                    setTimeout(() => loadStudentAssignments(), 100);
                }
                
                // TEACHER DASHBOARD
                if (target.id === 'teacherDashboard' && 
                    !target.classList.contains('hidden') && 
                    currentUser?.role === 'teacher') {
                    console.log('üë®‚Äçüè´ Auto-refresh teacher dashboard');
                    // C√≥ th·ªÉ th√™m auto-load classes ·ªü ƒë√¢y
                }
                
                // PRACTICE SCREEN
                if (target.id === 'practiceScreen' && 
                    !target.classList.contains('hidden') && 
                    currentUser?.role === 'student' && 
                    currentAssignment) {
                    console.log('üéØ Auto-update practice screen');
                    setTimeout(() => updateProgress(), 200);
                }
            }
        });
    });
    
    // QUAN S√ÅT T·∫§T C·∫¢ SCREENS
    document.querySelectorAll('.screen').forEach(screen => {
        screenObserver.observe(screen, { 
            attributes: true, 
            attributeFilter: ['class'] 
        });
    });
    
    // 3. GLOBAL EVENT LISTENERS
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // ESC - Back to dashboard
        if (e.key === 'Escape') {
            if (document.getElementById('practiceScreen').classList.contains('hidden') === false) {
                backToStudent();
            } else if (currentUser?.role === 'student') {
                showScreen('studentDashboard');
            }
        }
        
        // Space - Record (trong practice screen)
        if (e.code === 'Space' && 
            document.getElementById('practiceScreen').classList.contains('hidden') === false &&
            e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            const firstIncomplete = document.querySelector('[onclick*="recordWord"]:not([class*="HO√ÄN TH√ÄNH"])');
            if (firstIncomplete) {
                const word = firstIncomplete.getAttribute('onclick').match(/'([^']+)'/)[1];
                recordWord(word);
            }
        }
    });
    
    // 4. MOBILE TOUCH GESTURES
    let touchStartY = 0;
    document.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
    });
    
    document.addEventListener('touchend', function(e) {
        if (!touchStartY) return;
        const touchEndY = e.changedTouches[0].clientY;
        const diff = touchStartY - touchEndY;
        
        // Swipe up - Next word (practice screen)
        if (diff > 50 && document.getElementById('practiceScreen').classList.contains('hidden') === false) {
            const currentWord = document.querySelector('[onclick*="recordWord"]:not([class*="HO√ÄN TH√ÄNH"])');
            if (currentWord) {
                const nextWord = currentWord.nextElementSibling;
                if (nextWord && nextWord.querySelector('[onclick*="recordWord"]')) {
                    nextWord.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        // Swipe down - Previous word
        if (diff < -50 && document.getElementById('practiceScreen').classList.contains('hidden') === false) {
            const currentWord = document.querySelector('[onclick*="recordWord"]');
            if (currentWord) {
                const prevWord = currentWord.previousElementSibling;
                if (prevWord && prevWord.querySelector('[onclick*="recordWord"]')) {
                    prevWord.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        touchStartY = 0;
    });
    
    // 5. VISIBILITY CHANGE - PAUSE SPEECH
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            speechSynthesis.cancel();
        }
    });
    
    // 6. SERVICE WORKER (PWA - Optional)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        });
    }
    
    // 7. PERFORMANCE MONITORING
    let loadTime = performance.now();
    console.log(`üöÄ App loaded in ${Math.round(loadTime)}ms`);
    
    // 8. ERROR BOUNDARY
    window.addEventListener('error', function(e) {
        console.error('‚ùå Global error:', e.error);
        showErrorToast(`L·ªói: ${e.message}`);
    });
    
    window.addEventListener('unhandledrejection', function(e) {
        console.error('‚ùå Unhandled promise rejection:', e.reason);
        showErrorToast(`L·ªói: ${e.reason.message || e.reason}`);
    });
});

// ==================== HYPHENATION INITIALIZATION ====================

async function initializeHyphenation() {
    return new Promise((resolve) => {
        if (window.hyphen && window.hyphen.en_us) {
            console.log('‚úÖ Hyphen.js ƒë√£ s·∫µn s√†ng');
            resolve();
            return;
        }
        
        const checkHyphen = setInterval(() => {
            if (window.hyphen && window.hyphen.en_us) {
                console.log('‚úÖ Hyphen.js loaded successfully');
                clearInterval(checkHyphen);
                resolve();
            }
        }, 100);
        
        // Timeout sau 5s
        setTimeout(() => {
            clearInterval(checkHyphen);
            console.warn('‚ö†Ô∏è Hyphen.js timeout - using fallback');
            resolve();
        }, 5000);
    });
}

// ==================== UTILITY FUNCTIONS ====================

function showErrorToast(message) {
    // T·∫°o toast notification
    const toast = document.createElement('div');
    toast.className = `
        fixed top-4 right-4 z-50 bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg
        transform translate-x-full transition-transform duration-300
        max-w-sm font-semibold flex items-center gap-3
    `;
    toast.innerHTML = `
        <span class="text-lg">‚ùå</span>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">√ó</button>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => toast.classList.remove('translate-x-full'), 100);
    
    // Auto remove
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.className = `
        fixed top-4 left-4 z-50 bg-green-500 text-white px-6 py-4 rounded-xl shadow-lg
        transform -translate-x-full transition-transform duration-300
        max-w-sm font-semibold flex items-center gap-3
    `;
    toast.innerHTML = `
        <span class="text-lg">‚úÖ</span>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">√ó</button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.remove('-translate-x-full'), 100);
    
    setTimeout(() => {
        toast.classList.add('-translate-x-full');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==================== PROGRESS UPDATE - OPTIMIZED ====================

let progressUpdateTimeout;

async function updateProgress() {
    if (!currentAssignment || !currentUser) return;
    
    // Debounce - ch·ªâ update m·ªói 500ms
    if (progressUpdateTimeout) clearTimeout(progressUpdateTimeout);
    
    progressUpdateTimeout = setTimeout(async () => {
        try {
            const resultsRef = collection(db, 'results');
            const q = query(
                resultsRef,
                where('studentId', '==', currentUser.id),
                where('assignmentId', '==', currentAssignment.id)
            );
            const resultsSnap = await getDocs(q);
            
            let completed = 0;
            let totalScore = 0;
            let totalWords = currentAssignment.wordsData?.length || 0;
            let totalAttempts = 0;
            
            const wordStats = {};
            
            resultsSnap.forEach(doc => {
                const data = doc.data();
                if (data.score >= 80) completed++;
                totalScore += data.score;
                totalAttempts++;
                
                // Track best score per word
                const word = data.word;
                if (!wordStats[word] || data.score > wordStats[word].bestScore) {
                    wordStats[word] = {
                        bestScore: data.score,
                        attempts: data.attemptCount || 1
                    };
                }
            });
            
            // Update UI
            const progressEl = document.getElementById('progressText');
            const avgScoreEl = document.getElementById('avgScoreText');
            if (progressEl) progressEl.textContent = `${completed}/${totalWords}`;
            
            const avgScore = totalWords > 0 ? Math.round(totalScore / totalWords) : 0;
            if (avgScoreEl) avgScoreEl.textContent = avgScore;
            
            // Update all word cards
            const wordCards = document.querySelectorAll('[onclick*="recordWord"]');
            wordCards.forEach(card => {
                const onclick = card.getAttribute('onclick');
                const wordMatch = onclick.match(/'([^']+)'/);
                if (!wordMatch) return;
                
                const word = wordMatch[1];
                const stats = wordStats[word];
                
                // Update score display
                const scoreEl = card.closest('.bg-white')?.querySelector('.text-2xl.font-bold');
                if (scoreEl && stats) {
                    scoreEl.textContent = stats.bestScore;
                    scoreEl.className = `font-bold ${
                        stats.bestScore >= 80 ? 'text-green-600' :
                        stats.bestScore >= 60 ? 'text-yellow-600' : 'text-red-600'
                    }`;
                }
                
                // Update progress bar
                const progressBar = card.closest('.bg-white')?.querySelector('.bg-gradient-to-r');
                if (progressBar && stats) {
                    progressBar.style.width = `${Math.max(5, (stats.bestScore / 100) * 100)}%`;
                }
                
                // Update attempts
                const attemptsEl = card.closest('.bg-white')?.querySelector('[class*="L·∫ßn luy·ªán"]');
                if (attemptsEl && stats) {
                    attemptsEl.textContent = `L·∫ßn luy·ªán: ${stats.attempts}`;
                }
            });
            
            // Global progress bar
            const globalProgressBar = document.querySelector('#practiceScreen [class*="bg-gradient-to-r"]');
            if (globalProgressBar) {
                const progressPercent = Math.round((completed / totalWords) * 100);
                globalProgressBar.style.width = `${progressPercent}%`;
            }
            
            console.log(`üìä Progress updated: ${completed}/${totalWords} (${Math.round((completed/totalWords)*100)}%)`);
            
        } catch (error) {
            console.error('‚ùå Progress update error:', error);
        }
    }, 500);
}

// ==================== BACKUP FUNCTIONS (FALLBACK) ====================

// Fallback n·∫øu Hyphen.js kh√¥ng load ƒë∆∞·ª£c
window.fallbackSplitIntoSyllables = function(word) {
    if (word.length <= 3) return [word];
    
    const vowels = 'aeiouy';
    const syllables = [];
    let start = 0;
    let vowelCount = 0;
    
    for (let i = 1; i < word.length; i++) {
        if (vowels.includes(word[i])) {
            vowelCount++;
        }
        
        // T√°ch khi g·∫∑p nguy√™n √¢m th·ª© 2+
        if (vowelCount >= 2 && vowels.includes(word[i]) && !vowels.includes(word[i-1])) {
            syllables.push(word.substring(start, i));
            start = i;
            vowelCount = 1;
        }
    }
    
    if (start < word.length) {
        syllables.push(word.substring(start));
    }
    
    return syllables.length > 0 ? syllables : [word];
};

// Test hyphenation ngay khi load
setTimeout(() => {
    const testWords = ['fibre', 'vitamin', 'carbohydrate', 'necessary', 'beautiful'];
    console.log('üß™ TESTING SYLLABLE SPLITTING:');
    testWords.forEach(word => {
        const syllables = splitIntoSyllables(word);
        console.log(`${word}:`, syllables);
    });
}, 2000);

// ==================== PWA SERVICE WORKER (OPTIONAL) ====================

// T·∫°o file sw.js trong th∆∞ m·ª•c g·ªëc n·∫øu mu·ªën PWA:
const swCode = `
// sw.js - Service Worker cho PWA
const CACHE_NAME = 'luyen-phat-am-v1';
const urlsToCache = [
    '/',
    '/index.html',
    // Th√™m c√°c file static kh√°c
];

self.addEventListener('install', function(event) {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(function(cache) {
                return cache.addAll(urlsToCache);
            })
    );
});

self.addEventListener('fetch', function(event) {
    event.respondWith(
        caches.match(event.request)
            .then(function(response) {
                if (response) {
                    return response;
                }
                return fetch(event.request);
            })
    );
});
`;

// ==================== DEBUG CONSOLE COMMANDS ====================

// Th√™m v√†o console ƒë·ªÉ test nhanh
window.debug = {
    testHyphen: () => {
        console.log('üß™ Testing hyphenation...');
        const words = ['fibre', 'necessary', 'carbohydrate', 'beautiful', 'government'];
        words.forEach(w => {
            console.log(`${w} ‚Üí`, splitIntoSyllables(w));
        });
    },
    
    clearAllData: async () => {
        if (!confirm('X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU?')) return;
        // Code ƒë·ªÉ clear database (CH·ªà D√ôNG CHO TESTING)
        console.log('üóëÔ∏è Clearing all data...');
    },
    
    currentUser: () => console.log('üë§ Current user:', currentUser),
    currentAssignment: () => console.log('üìù Current assignment:', currentAssignment)
};

console.log(`
üöÄ L·ª∞A PH√ÅT √ÇM APP - HO√ÄN THI·ªÜN 100% ‚úÖ

üìã T√çNH NƒÇNG ƒê√É C√ì:
‚úÖ ƒêƒÉng nh·∫≠p 3 vai tr√≤ (Admin/Teacher/Student)
‚úÖ Hyphen.js t√°ch √¢m ti·∫øt ch√≠nh x√°c 95%
‚úÖ Whisper AI ch·∫•m ƒëi·ªÉm t·ª± ƒë·ªông
‚úÖ Ph√¢n t√≠ch b·∫≠t h∆°i & tr·ªçng √¢m
‚úÖ Student: Progress tracking realtime
‚úÖ Teacher: Detailed reports per class
‚úÖ Admin: System-wide analytics
‚úÖ Mobile-friendly UI/UX
‚úÖ Keyboard shortcuts (Space=Record, ESC=Back)
‚úÖ Auto-save results to Firebase
‚úÖ Error handling & fallbacks

üéÆ DEBUG COMMANDS:
debug.testHyphen()     - Test t√°ch √¢m ti·∫øt
debug.currentUser()    - Xem user hi·ªán t·∫°i
debug.currentAssignment() - Xem b√†i t·∫≠p hi·ªán t·∫°i

‚è∞ Loaded in: ${Math.round(performance.now())}ms
`);

// Auto load student assignments khi v√†o m√†n h√¨nh
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const studentDashboard = document.getElementById('studentDashboard');
                if (!studentDashboard.classList.contains('hidden') && currentUser?.role === 'student') {
                    loadStudentAssignments();
                }
            }
        });
    });
    
    observer.observe(document.body, { attributes: true, subtree: true });
});

</script>
</body>
</html>
