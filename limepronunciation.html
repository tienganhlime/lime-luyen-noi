<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyá»‡n PhÃ¡t Ã‚m</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hyphen@1.8.0/dist/jquery.hyphenate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hyphen@1.8.0/patterns/en-us.js"></script>
   <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
    
    body {
        font-family: 'Quicksand', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 50%, #81C784 100%);
    }
    
    .screen { display: none; }
    .screen:not(.hidden) { display: block; }
    
    .fade-in { 
        animation: fadeIn 0.5s ease-in; 
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

</head>
<body class="bg-gray-100">
<!-- Loading Spinner -->
<div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg">
        <div class="animate-spin h-12 w-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div>
        <p class="mt-4 text-gray-700">Äang xá»­ lÃ½...</p>
    </div>
</div>

<!-- 1. TRANG ÄÄ‚NG NHáº¬P -->
<div id="loginScreen" class="screen min-h-screen flex items-center justify-center p-4">
    <div class="w-full">
        <!-- HEADER -->
        <div class="bg-gradient-to-r from-green-600 via-lime-500 to-green-700 text-white p-4 shadow-lg mb-8 rounded-lg">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="h-12">
                    <span class="text-2xl font-bold">LIME Luyá»‡n PhÃ¡t Ã‚m</span>
                </div>
                <div class="text-right">
                    <p class="font-semibold">ğŸ“ Hotline: 0976 222 792</p>
                    <p class="text-sm">FB: fb.com/tienganhtreemlime</p>
                </div>
            </div>
        </div>

        <!-- FORM ÄÄ‚NG NHáº¬P -->
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-auto">
            <h1 class="text-4xl font-bold text-center mb-8 text-blue-600">ğŸ™ï¸ Luyá»‡n PhÃ¡t Ã‚m</h1>
            <div class="space-y-4">
                <button onclick="selectRole('admin')" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-4 rounded-xl text-xl font-semibold transition shadow-lg">
                    ğŸ”‘ TÃ´i lÃ  Admin
                </button>
                <button onclick="selectRole('teacher')" class="w-full bg-gradient-to-r from-green-500 to-lime-500 hover:from-green-600 hover:to-lime-600 text-white py-4 rounded-xl text-xl font-semibold transition shadow-lg">
                    ğŸ‘¨â€ğŸ« TÃ´i lÃ  GiÃ¡o viÃªn
                </button>
                <button onclick="selectRole('student')" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white py-4 rounded-xl text-xl font-semibold transition shadow-lg">
                    ğŸ‘¨â€ğŸ“ TÃ´i lÃ  Há»c sinh
                </button>
            </div>
        </div>
    </div> <!-- ÄÃ“ ÄÃ‚Y: Ä‘Ã³ng <div class="w-full"> -->
</div>
<!-- ÄÄ‚NG NHáº¬P ADMIN -->
<!-- ÄÄ‚NG NHáº¬P ADMIN -->
<div id="adminLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="w-full">
        <!-- HEADER -->
        <div class="bg-gradient-to-r from-red-600 via-red-500 to-red-700 text-white p-4 shadow-lg mb-8 rounded-lg">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="h-12">
                    <span class="text-2xl font-bold">LIME Luyá»‡n PhÃ¡t Ã‚m - Admin</span>
                </div>
                <div class="text-right">
                    <p class="font-semibold">ğŸ“ Hotline: 0976 222 792</p>
                    <p class="text-sm">FB: fb.com/tienganhtreemlime</p>
                </div>
            </div>
        </div>
        
        <!-- FORM -->
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-auto">
            <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4 hover:text-gray-800 flex items-center gap-2">
                <span>â†</span> Quay láº¡i
            </button>
            <h2 class="text-3xl font-bold mb-6 text-red-600">ğŸ”’ ÄÄƒng nháº­p Admin</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">TÃªn Ä‘Äƒng nháº­p</label>
                    <input type="text" id="adminUsername" class="w-full p-3 border rounded-lg" placeholder="admin">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Máº­t kháº©u</label>
                    <input type="password" id="adminPassword" class="w-full p-3 border rounded-lg" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
            </div>
            
            <button onclick="loginAdmin()" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold mt-6">
                ÄÄƒng nháº­p
            </button>
        </div>
    </div> <!-- ÄÃ“ ÄÃ‚Y -->
</div>
<!-- DASHBOARD ADMIN -->
<div id="adminDashboard" class="screen hidden min-h-screen p-6 bg-gradient-to-br from-red-50 via-orange-50 to-red-100">
    <!-- THÃŠM HEADER -->
    <div class="bg-gradient-to-r from-red-600 via-red-500 to-red-700 text-white p-4 shadow-lg rounded-lg mb-6">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="h-12">
                <span class="text-2xl font-bold">LIME Luyá»‡n PhÃ¡t Ã‚m - Admin</span>
            </div>
            <div class="text-right">
                <p class="font-semibold">ğŸ“ Hotline: 0976 222 792</p>
                <p class="text-sm">FB: fb.com/tienganhtreemlime</p>
            </div>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ğŸ” Admin Dashboard</h1>
                    <p class="text-gray-600 mt-2">Quáº£n lÃ½: <span id="adminNameDisplay" class="font-bold"></span></p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ÄÄƒng xuáº¥t</button>
            </div>
        </div>
        
        <div class="grid md:grid-cols-3 gap-4 mb-6">
            <button onclick="adminManageClasses()" class="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-lg font-semibold">
                ğŸ“š Quáº£n lÃ½ Lá»›p
            </button>
            <button onclick="adminManageTeachers()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg font-semibold">
                ğŸ‘¨â€ğŸ« Quáº£n lÃ½ GV
            </button>
            <button onclick="adminManageStudents()" class="bg-purple-500 hover:bg-purple-600 text-white p-6 rounded-lg font-semibold">
                ğŸ‘¨â€ğŸ“ Quáº£n lÃ½ HS
            </button>
            <button onclick="adminViewReports()" class="bg-orange-500 hover:bg-orange-600 text-white p-6 rounded-lg font-semibold">
                ğŸ“Š BÃ¡o cÃ¡o
            </button>
        </div>
        
        <div id="adminContent" class="bg-white rounded-lg shadow-lg p-6"></div>
    </div>
</div>

<!-- 2. ÄÄ‚NG NHáº¬P Há»ŒC SINH -->
<!-- 2. ÄÄ‚NG NHáº¬P Há»ŒC SINH -->
<div id="studentLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="w-full">
        <!-- HEADER -->
        <div class="bg-gradient-to-r from-blue-600 via-blue-500 to-blue-700 text-white p-4 shadow-lg mb-8 rounded-lg">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="h-12">
                    <span class="text-2xl font-bold">LIME Luyá»‡n PhÃ¡t Ã‚m - Há»c sinh</span>
                </div>
                <div class="text-right">
                    <p class="font-semibold">ğŸ“ Hotline: 0976 222 792</p>
                    <p class="text-sm">FB: fb.com/tienganhtreemlime</p>
                </div>
            </div>
        </div>
        
        <!-- FORM -->
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-auto">
            <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4 hover:text-gray-800 flex items-center gap-2">
                <span>â†</span> Quay láº¡i
            </button>
            <h2 class="text-3xl font-bold mb-6">ÄÄƒng nháº­p Há»c sinh</h2>
            <input type="text" id="studentCode" placeholder="Nháº­p mÃ£ há»c sinh (vd: HS001)" class="w-full p-3 border rounded-lg mb-4">
            <button onclick="loginStudent()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold">
                ÄÄƒng nháº­p
            </button>
        </div>
    </div> <!-- ÄÃ“ ÄÃ‚Y -->
</div>
<!-- ÄÄ‚NG NHáº¬P GIÃO VIÃŠN -->
<div id="teacherLoginScreen" class="screen hidden min-h-screen flex items-center justify-center p-4">
    <div class="w-full">
        <!-- HEADER -->
        <div class="bg-gradient-to-r from-green-600 via-lime-500 to-green-700 text-white p-4 shadow-lg mb-8 rounded-lg">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="h-12">
                    <span class="text-2xl font-bold">LIME Luyá»‡n PhÃ¡t Ã‚m - GiÃ¡o viÃªn</span>
                </div>
                <div class="text-right">
                    <p class="font-semibold">ğŸ“ Hotline: 0976 222 792</p>
                    <p class="text-sm">FB: fb.com/tienganhtreemlime</p>
                </div>
            </div>
        </div>
        
        <!-- FORM -->
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
            <button onclick="showScreen('loginScreen')" class="text-gray-600 mb-4 hover:text-gray-800 flex items-center gap-2">
                <span>â†</span> Quay láº¡i
            </button>
            <h2 class="text-3xl font-bold mb-6 text-green-600">ğŸ‘¨â€ğŸ« ÄÄƒng nháº­p GiÃ¡o viÃªn</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">TÃªn Ä‘Äƒng nháº­p</label>
                    <input type="text" id="teacherUsername" class="w-full p-3 border rounded-lg" placeholder="gv001">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Máº­t kháº©u</label>
                    <input type="password" id="teacherPassword" class="w-full p-3 border rounded-lg" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
            </div>
            
            <button onclick="loginTeacher()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold mt-6">
                ÄÄƒng nháº­p
            </button>
        </div>
    </div> <!-- ÄÃ“ ÄÃ‚Y -->
</div>

<!-- 4. DASHBOARD GIÃO VIÃŠN -->
<div id="teacherDashboard" class="screen hidden min-h-screen p-6 bg-gradient-to-br from-green-50 via-lime-50 to-green-100">
<!-- ThÃªm vÃ o Ä‘áº§u má»—i <div class="screen"> -->
<div class="bg-gradient-to-r from-green-600 via-lime-500 to-green-700 text-white p-4 shadow-lg">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="h-12">
            <span class="text-2xl font-bold">LIME Luyá»‡n PhÃ¡t Ã‚m</span>
        </div>
        <div class="text-right">
            <p class="font-semibold">ğŸ“ Hotline: 0976 222 792</p>
            <p class="text-sm">Email: fb.com/tienganhtreemlimen</p>
        </div>
    </div>
</div>    

<div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">ğŸ‘¨â€ğŸ« Dashboard GiÃ¡o viÃªn</h1>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ÄÄƒng xuáº¥t</button>
            </div>
            <p class="text-gray-600 mt-2">MÃ£ GV: <span id="teacherCodeDisplay" class="font-mono font-bold"></span></p>
        </div>
        <div class="grid md:grid-cols-3 gap-6 mb-6">
    <button onclick="showMyClasses()" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg text-xl font-semibold">
        ğŸ“š Quáº£n lÃ½ lá»›p
    </button>
    <button onclick="showAssignments()" class="bg-purple-500 hover:bg-purple-600 text-white p-6 rounded-lg text-xl font-semibold">
        ğŸ“ Giao bÃ i táº­p
    </button>
    <button onclick="teacherViewReports()" class="bg-orange-500 hover:bg-orange-600 text-white p-6 rounded-lg text-xl font-semibold">
        ğŸ“Š Xem bÃ¡o cÃ¡o
    </button>
    <button onclick="manageLibrary()" class="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-lg text-xl font-semibold">
        ğŸ“– ThÆ° viá»‡n tá»«
    </button>
</div>
        <div id="teacherContent" class="bg-white rounded-lg shadow-lg p-6"></div>
    </div>
</div>

<!-- 5. DASHBOARD Há»ŒC SINH -->
<div id="studentDashboard" class="screen hidden min-h-screen p-6 bg-gradient-to-br from-green-50 via-lime-50 to-green-100">

<!-- ThÃªm vÃ o Ä‘áº§u má»—i <div class="screen"> -->
<div class="bg-gradient-to-r from-green-600 via-lime-500 to-green-700 text-white p-4 shadow-lg rounded-lg mb-6">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="h-12">
            <span class="text-2xl font-bold">LIME Luyá»‡n PhÃ¡t Ã‚m</span>
        </div>
        <div class="text-right">
            <p class="font-semibold">ğŸ“ Hotline: 0976 222 792</p>
            <p class="text-sm">Email: fb.com/tienganhtreemlime</p>
        </div>
    </div>
</div>    
<div class="max-w-6xl mx-auto">
<button onclick="backToStudent()" class="flex items-center gap-2 px-4 py-3 bg-white hover:bg-gray-100 rounded-lg transition-colors shadow-md mb-4 font-semibold text-gray-700">
        <span class="text-2xl">â†</span>
        <span>Quay láº¡i Dashboard</span>
    </button>
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ğŸ‘¨â€ğŸ“ Lá»›p há»c cá»§a tÃ´i</h1>
                    <p class="text-gray-600 mt-2">Há»c sinh: <span id="studentNameDisplay" class="font-bold"></span></p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">ÄÄƒng xuáº¥t</button>
            </div>
        </div>
        <div id="studentAssignments" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
</div>

<!-- 6. MÃ€N HÃŒNH LUYá»†N Táº¬P -->
<div id="practiceScreen" class="screen hidden min-h-screen p-6 bg-gradient-to-br from-green-100 via-lime-100 to-green-200">
<!-- ThÃªm vÃ o Ä‘áº§u má»—i <div class="screen"> -->
<div class="bg-gradient-to-r from-green-600 via-lime-500 to-green-700 text-white p-4 shadow-lg rounded-lg mb-6">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://gofirst.pro/images/uploads/62/baseimg/logo_16541442053.png" alt="LIME" class="h-12">
            <span class="text-2xl font-bold">LIME Luyá»‡n PhÃ¡t Ã‚m</span>
        </div>
        <div class="text-right">
            <p class="font-semibold">ğŸ“ Hotline: 0976 222 792</p>
            <p class="text-sm">Email: fb.com/tienganhtreemlime</p>
        </div>
    </div>
</div>
<div class="max-w-6xl mx-auto">
        <button onclick="backToStudent()" class="text-white mb-4 text-lg">â† Quay láº¡i</button>
        <div class="bg-white rounded-lg shadow-2xl p-6 mb-6">
            <h2 id="assignmentTitle" class="text-3xl font-bold mb-2"></h2>
            <div class="flex gap-4 text-sm text-gray-600">
                <span>Tiáº¿n Ä‘á»™: <span id="progressText" class="font-bold">0/0</span></span>
                <span>Äiá»ƒm TB: <span id="avgScoreText" class="font-bold">0</span></span>
            </div>
        </div>
        <div id="wordsList" class="space-y-6 max-w-3xl mx-auto"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, getDoc, setDoc, orderBy, arrayUnion, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyB2VOZ0A5im13MC6FNLa4bEupKedm5iiBo",
    authDomain: "lime-phat-am.firebaseapp.com",
    projectId: "lime-phat-am",
    storageBucket: "lime-phat-am.firebasestorage.app",
    messagingSenderId: "434295865710",
    appId: "1:434295865710:web:5f373900f5e8c1d679417f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = null;
let currentAssignment = null;

// ==================== WHISPER AI CONFIGURATION ====================
// âš ï¸ QUAN TRá»ŒNG: Thay YOUR_API_KEY_HERE báº±ng API key tá»« https://huggingface.co/settings/tokens
const HUGGING_FACE_API_KEY = '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'; 
const WHISPER_MODEL = 'openai/whisper-large-v3-turbo';

let mediaRecorder;
let audioChunks = [];

// ==================== UTILITIES ====================
window.showScreen = function(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('hidden', !show);
}

// ==================== AUTHENTICATION ====================
window.selectRole = function(role) {
    if (role === 'admin') {
        showScreen('adminLoginScreen');
    } else if (role === 'teacher') {
        showScreen('teacherLoginScreen');
    } else {
        showScreen('studentLoginScreen');
    }
}

// HÃ m hash máº­t kháº©u Ä‘Æ¡n giáº£n (PRODUCTION nÃªn dÃ¹ng bcrypt)
function simpleHash(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString();
}

// ÄÄ‚NG NHáº¬P ADMIN
window.loginAdmin = async function() {
    const username = document.getElementById('adminUsername').value.trim();
    const password = document.getElementById('adminPassword').value.trim();
    
    if (!username || !password) {
        return alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin');
    }
    
    showLoading(true);
    try {
        const adminsRef = collection(db, 'admins');
        const q = query(adminsRef, where('username', '==', username));
        const snap = await getDocs(q);
        
        if (snap.empty) {
            showLoading(false);
            return alert('TÃ i khoáº£n khÃ´ng tá»“n táº¡i');
        }
        
        const adminData = snap.docs[0].data();
       // const hashedPassword = simpleHash(password);
        
        if (adminData.password !== password) {
            showLoading(false);
            return alert('Máº­t kháº©u khÃ´ng Ä‘Ãºng');
        }
        
        currentUser = { 
            role: 'admin', 
            id: snap.docs[0].id,
            username: adminData.username 
        };
        
        document.getElementById('adminNameDisplay').textContent = username;
        showScreen('adminDashboard');
    } catch (error) {
        alert('Lá»—i Ä‘Äƒng nháº­p: ' + error.message);
    }
    showLoading(false);
}

// ÄÄ‚NG NHáº¬P GIÃO VIÃŠN (Sá»¬A)
window.loginTeacher = async function() {
    const username = document.getElementById('teacherUsername').value.trim();
    const password = document.getElementById('teacherPassword').value.trim();
    
    if (!username || !password) {
        return alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin');
    }
    
    showLoading(true);
    try {
        const teachersRef = collection(db, 'teachers');
        const q = query(teachersRef, where('username', '==', username));
        const snap = await getDocs(q);
        
        if (snap.empty) {
            showLoading(false);
            return alert('TÃ i khoáº£n khÃ´ng tá»“n táº¡i');
        }
        
        const teacherData = snap.docs[0].data();
       // const hashedPassword = simpleHash(password);
        
        if (teacherData.password !== password) {
            showLoading(false);
            return alert('Máº­t kháº©u khÃ´ng Ä‘Ãºng');
        }
        
        currentUser = { 
            role: 'teacher', 
            id: snap.docs[0].id,
            ...teacherData
        };
        
        document.getElementById('teacherCodeDisplay').textContent = teacherData.name || username;
        showScreen('teacherDashboard');
    } catch (error) {
        alert('Lá»—i Ä‘Äƒng nháº­p: ' + error.message);
    }
    showLoading(false);
}

// ÄÄ‚NG NHáº¬P Há»ŒC SINH (GIá»® NGUYÃŠN)
window.loginStudent = async function() {
    const code = document.getElementById('studentCode').value.trim();
    if (!code) return alert('Vui lÃ²ng nháº­p mÃ£ há»c sinh');
   
    showLoading(true);
    try {
        const studentsRef = collection(db, 'students');
        const q = query(studentsRef, where('code', '==', code));
        const snap = await getDocs(q);
       
        if (snap.empty) {
            showLoading(false);
            return alert('MÃ£ há»c sinh khÃ´ng tá»“n táº¡i. LiÃªn há»‡ giÃ¡o viÃªn!');
        }
       
        const studentData = snap.docs[0].data();
        currentUser = { role: 'student', code, id: snap.docs[0].id, ...studentData };
        document.getElementById('studentNameDisplay').textContent = studentData.name;
        await loadStudentAssignments();
        showScreen('studentDashboard');
    } catch (error) {
        alert('Lá»—i Ä‘Äƒng nháº­p: ' + error.message);
    }
    showLoading(false);
}

window.logout = function() {
    currentUser = null;
    showScreen('loginScreen');
}
// ==================== ADMIN FUNCTIONS ====================

// Quáº£n lÃ½ Lá»›p
window.adminManageClasses = async function() {
    showLoading(true);
    try {
        const classesRef = collection(db, 'classes');
        const snap = await getDocs(classesRef);
        
        let html = `
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">ğŸ“š Quáº£n lÃ½ Lá»›p há»c</h2>
                <button onclick="showAddClassForm()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold">
                    â• ThÃªm lá»›p má»›i
                </button>
            </div>
            
            <div id="classFormArea"></div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
        `;
        
        snap.forEach(doc => {
            const data = doc.data();
            html += `
                <div class="border rounded-lg p-4 bg-white hover:shadow-lg transition">
                    <h3 class="text-xl font-bold mb-2">${data.name}</h3>
                    <p class="text-sm text-gray-600 mb-3">Há»c sinh: ${data.students?.length || 0}</p>
                    <div class="flex gap-2">
                        <button onclick="editClass('${doc.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm">
                            âœï¸ Sá»­a
                        </button>
                        <button onclick="deleteClass('${doc.id}', '${data.name}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm">
                            ğŸ—‘ï¸ XÃ³a
                        </button>
                        <button onclick="assignTeacherToClass('${doc.id}', '${data.name}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm">
                            ğŸ‘¨â€ğŸ« PhÃ¢n GV
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.showAddClassForm = function() {
    document.getElementById('classFormArea').innerHTML = `
        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-4">
            <h3 class="font-bold text-lg mb-4">â• ThÃªm lá»›p má»›i</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-semibold mb-1">TÃªn lá»›p</label>
                    <input type="text" id="newClassName" placeholder="VÃ­ dá»¥: Lá»›p 6A" class="w-full p-3 border rounded-lg">
                </div>
                <div class="flex gap-2">
                    <button onclick="saveNewClass()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold">
                        ğŸ’¾ LÆ°u
                    </button>
                    <button onclick="document.getElementById('classFormArea').innerHTML=''" class="bg-gray-500 text-white px-6 py-2 rounded-lg">
                        âŒ Há»§y
                    </button>
                </div>
            </div>
        </div>
    `;
}

window.saveNewClass = async function() {
    const name = document.getElementById('newClassName').value.trim();
    if (!name) return alert('Vui lÃ²ng nháº­p tÃªn lá»›p');
    
    showLoading(true);
    try {
        await addDoc(collection(db, 'classes'), {
            name,
            createdBy: currentUser.id,
            teacherIds: [],
            students: [],
            createdAt: new Date()
        });
        alert('ThÃªm lá»›p thÃ nh cÃ´ng!');
        adminManageClasses();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.deleteClass = async function(classId, className) {
    if (!confirm(`XÃ³a lá»›p "${className}"? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!`)) return;
    
    showLoading(true);
    try {
        await deleteDoc(doc(db, 'classes', classId));
        alert('ÄÃ£ xÃ³a lá»›p!');
        adminManageClasses();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.editClass = async function(classId) {
    showLoading(true);
    try {
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const data = classDoc.data();
        
        document.getElementById('classFormArea').innerHTML = `
            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 mb-4">
                <h3 class="font-bold text-lg mb-4">âœï¸ Sá»­a thÃ´ng tin lá»›p</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-1">TÃªn lá»›p</label>
                        <input type="text" id="editClassName" value="${data.name}" class="w-full p-3 border rounded-lg">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveEditClass('${classId}')" class="bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold">
                            ğŸ’¾ LÆ°u thay Ä‘á»•i
                        </button>
                        <button onclick="adminManageClasses()" class="bg-gray-500 text-white px-6 py-2 rounded-lg">
                            âœ– Há»§y
                        </button>
                    </div>
                </div>
            </div>
        `;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.saveEditClass = async function(classId) {
    const name = document.getElementById('editClassName').value.trim();
    if (!name) return alert('Vui lÃ²ng nháº­p tÃªn lá»›p');
    
    showLoading(true);
    try {
        await updateDoc(doc(db, 'classes', classId), { name });
        alert('Cáº­p nháº­t thÃ nh cÃ´ng!');
        adminManageClasses();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// Quáº£n lÃ½ GiÃ¡o viÃªn
window.adminManageTeachers = async function() {
    showLoading(true);
    try {
        const teachersRef = collection(db, 'teachers');
        const snap = await getDocs(teachersRef);
        
        let html = `
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">ğŸ‘¨â€ğŸ« Quáº£n lÃ½ GiÃ¡o viÃªn</h2>
                <button onclick="showAddTeacherForm()" class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold">
                    â• ThÃªm giÃ¡o viÃªn
                </button>
            </div>
            
            <div id="teacherFormArea"></div>
            
            <div class="grid md:grid-cols-2 gap-4 mt-6">
        `;
        
        snap.forEach(doc => {
            const data = doc.data();
            html += `
                <div class="border rounded-lg p-4 bg-white">
                    <h3 class="text-xl font-bold">${data.name || data.username}</h3>
                    <p class="text-sm text-gray-600">Username: ${data.username}</p>
                    <p class="text-sm text-gray-600">Lá»›p phá»¥ trÃ¡ch: ${data.assignedClasses?.length || 0}</p>
                    <div class="flex gap-2 mt-3">
                        <button onclick="editTeacher('${doc.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm">
                            âœï¸ Sá»­a
                        </button>
                        <button onclick="deleteTeacher('${doc.id}', '${data.name}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm">
                            ğŸ—‘ï¸ XÃ³a
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.showAddTeacherForm = function() {
    document.getElementById('teacherFormArea').innerHTML = `
        <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6 mb-4">
            <h3 class="font-bold text-lg mb-4">â• ThÃªm giÃ¡o viÃªn má»›i</h3>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">Há» tÃªn</label>
                    <input type="text" id="newTeacherName" placeholder="Nguyá»…n VÄƒn A" class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">TÃªn Ä‘Äƒng nháº­p</label>
                    <input type="text" id="newTeacherUsername" placeholder="gv001" class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Máº­t kháº©u</label>
                    <input type="password" id="newTeacherPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Email</label>
                    <input type="email" id="newTeacherEmail" placeholder="email@example.com" class="w-full p-3 border rounded-lg">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="saveNewTeacher()" class="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ğŸ’¾ LÆ°u
                </button>
                <button onclick="document.getElementById('teacherFormArea').innerHTML=''" class="bg-gray-500text-white px-6 py-2 rounded-lg">
âŒ Há»§y
</button>
</div>
</div>
`;
}
window.saveNewTeacher = async function() {
const name = document.getElementById('newTeacherName').value.trim();
const username = document.getElementById('newTeacherUsername').value.trim();
const password = document.getElementById('newTeacherPassword').value.trim();
const email = document.getElementById('newTeacherEmail').value.trim();
if (!name || !username || !password) {
    return alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin báº¯t buá»™c');
}

showLoading(true);
try {
    await addDoc(collection(db, 'teachers'), {
        name,
        username,
        password: password,
        email,
        assignedClasses: [],
        createdAt: new Date()
    });
    alert('ThÃªm giÃ¡o viÃªn thÃ nh cÃ´ng!');
    adminManageTeachers();
} catch (error) {
    alert('Lá»—i: ' + error.message);
}
showLoading(false);
}

// ==================== ADMIN FUNCTIONS (TIáº¾P THEO) ====================

window.deleteTeacher = async function(teacherId, teacherName) {
    if (!confirm(`XÃ³a giÃ¡o viÃªn "${teacherName}"? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!`)) return;
    
    showLoading(true);
    try {
        await deleteDoc(doc(db, 'teachers', teacherId));
        alert('ÄÃ£ xÃ³a giÃ¡o viÃªn!');
        adminManageTeachers();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.editTeacher = async function(teacherId) {
    showLoading(true);
    try {
        const teacherDoc = await getDoc(doc(db, 'teachers', teacherId));
        const data = teacherDoc.data();
        
        document.getElementById('teacherFormArea').innerHTML = `
            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 mb-4">
                <h3 class="font-bold text-lg mb-4">âœï¸ Sá»­a thÃ´ng tin giÃ¡o viÃªn</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Há» tÃªn</label>
                        <input type="text" id="editTeacherName" value="${data.name || ''}" class="w-full p-3 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">TÃªn Ä‘Äƒng nháº­p</label>
                        <input type="text" id="editTeacherUsername" value="${data.username}" class="w-full p-3 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Máº­t kháº©u má»›i (Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng Ä‘á»•i)</label>
                        <input type="password" id="editTeacherPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-3 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Email</label>
                        <input type="email" id="editTeacherEmail" value="${data.email || ''}" class="w-full p-3 border rounded-lg">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="saveEditTeacher('${teacherId}')" class="bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold">
                        ğŸ’¾ LÆ°u thay Ä‘á»•i
                    </button>
                    <button onclick="adminManageTeachers()" class="bg-gray-500 text-white px-6 py-2 rounded-lg">
                        âŒ Há»§y
                    </button>
                </div>
            </div>
        `;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.saveEditTeacher = async function(teacherId) {
    const name = document.getElementById('editTeacherName').value.trim();
    const username = document.getElementById('editTeacherUsername').value.trim();
    const password = document.getElementById('editTeacherPassword').value.trim();
    const email = document.getElementById('editTeacherEmail').value.trim();
    
    if (!name || !username) {
        return alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin');
    }
    
    showLoading(true);
    try {
        const updateData = {
            name,
            username,
            email
        };
        
        // Chá»‰ update password náº¿u cÃ³ nháº­p má»›i
        if (password) {
            updateData.password = password;
        }
        
        await updateDoc(doc(db, 'teachers', teacherId), updateData);
        alert('Cáº­p nháº­t thÃ nh cÃ´ng!');
        adminManageTeachers();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// PHÃ‚N GIÃO VIÃŠN CHO Lá»šP
window.assignTeacherToClass = async function(classId, className) {
    showLoading(true);
    try {
        // Láº¥y danh sÃ¡ch táº¥t cáº£ giÃ¡o viÃªn
        const teachersRef = collection(db, 'teachers');
        const teachersSnap = await getDocs(teachersRef);
        
        // Láº¥y danh sÃ¡ch GV Ä‘Ã£ phÃ¢n cá»§a lá»›p nÃ y
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const assignedTeacherIds = classDoc.data().teacherIds || [];
        
        let html = `
            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-6">
                <h3 class="font-bold text-lg mb-4">ğŸ‘¨â€ğŸ« PhÃ¢n giÃ¡o viÃªn cho lá»›p: ${className}</h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">Chá»n giÃ¡o viÃªn</label>
                    <select id="selectTeacher" class="w-full p-3 border rounded-lg">
                        <option value="">-- Chá»n giÃ¡o viÃªn --</option>
        `;
        
        teachersSnap.forEach(doc => {
            const teacher = doc.data();
            const isAssigned = assignedTeacherIds.includes(doc.id);
            html += `<option value="${doc.id}" ${isAssigned ? 'disabled' : ''}>
                ${teacher.name || teacher.username} ${isAssigned ? '(ÄÃ£ phÃ¢n)' : ''}
            </option>`;
        });
        
        html += `
                    </select>
                </div>
                
                <div class="flex gap-2 mb-6">
                    <button onclick="addTeacherToClass('${classId}')" class="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold">
                        â• ThÃªm GV vÃ o lá»›p
                    </button>
                    <button onclick="adminManageClasses()" class="bg-gray-500 text-white px-4 py-2 rounded-lg">
                        â† Quay láº¡i
                    </button>
                </div>
                
                <h4 class="font-bold mb-3">Danh sÃ¡ch GV Ä‘Ã£ phÃ¢n:</h4>
                <div id="assignedTeachersList" class="space-y-2"></div>
            </div>
        `;
        
        document.getElementById('adminContent').innerHTML = html;
        
        // Hiá»ƒn thá»‹ danh sÃ¡ch GV Ä‘Ã£ phÃ¢n
        let assignedHtml = '';
        for (const tId of assignedTeacherIds) {
            const tDoc = await getDoc(doc(db, 'teachers', tId));
            if (tDoc.exists()) {
                const teacher = tDoc.data();
                assignedHtml += `
                    <div class="bg-white border p-3 rounded flex justify-between items-center">
                        <span class="font-semibold">${teacher.name || teacher.username}</span>
                        <button onclick="removeTeacherFromClass('${classId}', '${tId}')" 
                                class="bg-red-500 text-white px-3 py-1 rounded text-sm">
                            ğŸ—‘ï¸ Gá»¡
                        </button>
                    </div>
                `;
            }
        }
        
        document.getElementById('assignedTeachersList').innerHTML = assignedHtml || '<p class="text-gray-500">ChÆ°a cÃ³ giÃ¡o viÃªn nÃ o</p>';
        
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.addTeacherToClass = async function(classId) {
    const teacherId = document.getElementById('selectTeacher').value;
    if (!teacherId) return alert('Vui lÃ²ng chá»n giÃ¡o viÃªn');
    
    showLoading(true);
    try {
        // Cáº­p nháº­t class: thÃªm teacherId vÃ o teacherIds
        await updateDoc(doc(db, 'classes', classId), {
            teacherIds: arrayUnion(teacherId)
        });
        
        // Cáº­p nháº­t teacher: thÃªm classId vÃ o assignedClasses
        await updateDoc(doc(db, 'teachers', teacherId), {
            assignedClasses: arrayUnion(classId)
        });
        
        alert('ÄÃ£ phÃ¢n giÃ¡o viÃªn!');
        
        // Reload mÃ n hÃ¬nh
        const classDoc = await getDoc(doc(db, 'classes', classId));
        assignTeacherToClass(classId, classDoc.data().name);
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.removeTeacherFromClass = async function(classId, teacherId) {
    if (!confirm('Gá»¡ giÃ¡o viÃªn khá»i lá»›p nÃ y?')) return;
    
    showLoading(true);
    try {
        // Láº¥y dá»¯ liá»‡u hiá»‡n táº¡i
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const teacherDoc = await getDoc(doc(db, 'teachers', teacherId));
        
        const teacherIds = classDoc.data().teacherIds || [];
        const assignedClasses = teacherDoc.data().assignedClasses || [];
        
        // XÃ³a khá»i máº£ng
        const newTeacherIds = teacherIds.filter(id => id !== teacherId);
        const newAssignedClasses = assignedClasses.filter(id => id !== classId);
        
        // Cáº­p nháº­t
        await updateDoc(doc(db, 'classes', classId), {
            teacherIds: newTeacherIds
        });
        
        await updateDoc(doc(db, 'teachers', teacherId), {
            assignedClasses: newAssignedClasses
        });
        
        alert('ÄÃ£ gá»¡ giÃ¡o viÃªn!');
        assignTeacherToClass(classId, classDoc.data().name);
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// QUáº¢N LÃ Há»ŒC SINH
window.adminManageStudents = async function() {
    showLoading(true);
    try {
        const studentsRef = collection(db, 'students');
        const studentsSnap = await getDocs(studentsRef);
        
        const classesRef = collection(db, 'classes');
        const classesSnap = await getDocs(classesRef);
        
        let html = `
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">ğŸ‘¨â€ğŸ“ Quáº£n lÃ½ Há»c sinh</h2>
                <button onclick="showAddStudentFormAdmin()" class="bg-purple-500 text-white px-6 py-3 rounded-lg font-semibold">
                    â• ThÃªm há»c sinh
                </button>
            </div>
            
            <div id="studentFormArea"></div>
            
            <div class="overflow-x-auto mt-6">
                <table class="w-full bg-white rounded-lg overflow-hidden">
                    <thead class="bg-purple-600 text-white">
                        <tr>
                            <th class="p-3 text-left">MÃ£ HS</th>
                            <th class="p-3 text-left">Há» tÃªn</th>
                            <th class="p-3 text-left">Lá»›p</th>
                            <th class="p-3 text-center">Thao tÃ¡c</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const studentDoc of studentsSnap.docs) {
            const student = studentDoc.data();
            
            // TÃ¬m tÃªn lá»›p
            let className = 'ChÆ°a phÃ¢n lá»›p';
            if (student.classId) {
                const classDoc = classesSnap.docs.find(c => c.id === student.classId);
                if (classDoc) {
                    className = classDoc.data().name;
                }
            }
            
            html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-mono">${student.code}</td>
                    <td class="p-3 font-semibold">${student.name}</td>
                    <td class="p-3">${className}</td>
                    <td class="p-3 text-center">
                        <button onclick="editStudentAdmin('${studentDoc.id}')" 
                                class="bg-yellow-500 text-white px-3 py-1 rounded text-sm mr-2">
                            âœï¸ Sá»­a
                        </button>
                        <button onclick="deleteStudent('${studentDoc.id}', '${student.name}')" 
                                class="bg-red-500 text-white px-3 py-1 rounded text-sm">
                            ğŸ—‘ï¸ XÃ³a
                        </button>
                    </td>
                </tr>
            `;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.showAddStudentFormAdmin = async function() {
    // Láº¥y danh sÃ¡ch lá»›p
    const classesSnap = await getDocs(collection(db, 'classes'));
    
    let classOptions = '<option value="">-- Chá»n lá»›p --</option>';
    classesSnap.forEach(doc => {
        classOptions += `<option value="${doc.id}">${doc.data().name}</option>`;
    });
    
    document.getElementById('studentFormArea').innerHTML = `
        <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6 mb-4">
            <h3 class="font-bold text-lg mb-4">â• ThÃªm há»c sinh má»›i</h3>
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">Há» tÃªn</label>
                    <input type="text" id="newStudentName" placeholder="Nguyá»…n VÄƒn A" class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">MÃ£ há»c sinh</label>
                    <input type="text" id="newStudentCode" placeholder="HS001" class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Lá»›p</label>
                    <select id="newStudentClass" class="w-full p-3 border rounded-lg">
                        ${classOptions}
                    </select>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="saveNewStudentAdmin()" class="bg-purple-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ğŸ’¾ LÆ°u
                </button>
                <button onclick="document.getElementById('studentFormArea').innerHTML=''" class="bg-gray-500 text-white px-6 py-2 rounded-lg">
                    âŒ Há»§y
                </button>
            </div>
        </div>
    `;
}

window.saveNewStudentAdmin = async function() {
    const name = document.getElementById('newStudentName').value.trim();
    const code = document.getElementById('newStudentCode').value.trim();
    const classId = document.getElementById('newStudentClass').value;
    
    if (!name || !code || !classId) {
        return alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin');
    }
    
    showLoading(true);
    try {
        // Kiá»ƒm tra mÃ£ HS Ä‘Ã£ tá»“n táº¡i chÆ°a
        const studentsRef = collection(db, 'students');
        const q = query(studentsRef, where('code', '==', code));
        const existSnap = await getDocs(q);
        
        if (!existSnap.empty) {
            showLoading(false);
            return alert('MÃ£ há»c sinh Ä‘Ã£ tá»“n táº¡i!');
        }
        
        // ThÃªm há»c sinh
        const studentRef = await addDoc(studentsRef, {
            name,
            code,
            classId,
            createdAt: new Date()
        });
        
        // Cáº­p nháº­t class: thÃªm student vÃ o máº£ng students
        await updateDoc(doc(db, 'classes', classId), {
            students: arrayUnion(studentRef.id)
        });
        
        alert('ThÃªm há»c sinh thÃ nh cÃ´ng!');
        adminManageStudents();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.editStudentAdmin = async function(studentId) {
    showLoading(true);
    try {
        const studentDoc = await getDoc(doc(db, 'students', studentId));
        const student = studentDoc.data();
        
        // Láº¥y danh sÃ¡ch lá»›p
        const classesSnap = await getDocs(collection(db, 'classes'));
        let classOptions = '';
        classesSnap.forEach(doc => {
            const selected = doc.id === student.classId ? 'selected' : '';
            classOptions += `<option value="${doc.id}" ${selected}>${doc.data().name}</option>`;
        });
        
        document.getElementById('studentFormArea').innerHTML = `
            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 mb-4">
                <h3 class="font-bold text-lg mb-4">âœï¸ Sá»­a thÃ´ng tin há»c sinh</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Há» tÃªn</label>
                        <input type="text" id="editStudentName" value="${student.name}" class="w-full p-3 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">MÃ£ há»c sinh</label>
                        <input type="text" id="editStudentCode" value="${student.code}" class="w-full p-3 border rounded-lg" disabled>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Lá»›p</label>
                        <select id="editStudentClass" class="w-full p-3 border rounded-lg">
                            ${classOptions}
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="saveEditStudentAdmin('${studentId}', '${student.classId}')" class="bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold">
                        ğŸ’¾ LÆ°u thay Ä‘á»•i
                    </button>
                    <button onclick="adminManageStudents()" class="bg-gray-500 text-white px-6 py-2 rounded-lg">
                        âŒ Há»§y
                    </button>
                </div>
            </div>
        `;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.saveEditStudentAdmin = async function(studentId, oldClassId) {
    const name = document.getElementById('editStudentName').value.trim();
    const newClassId = document.getElementById('editStudentClass').value;
    
    if (!name || !newClassId) {
        return alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin');
    }
    
    showLoading(true);
    try {
        // Cáº­p nháº­t thÃ´ng tin há»c sinh
        await updateDoc(doc(db, 'students', studentId), {
            name,
            classId: newClassId
        });
        
        // Náº¿u Ä‘á»•i lá»›p, cáº­p nháº­t cáº£ 2 lá»›p
        if (oldClassId !== newClassId) {
            // XÃ³a khá»i lá»›p cÅ©
            const oldClassDoc = await getDoc(doc(db, 'classes', oldClassId));
            const oldStudents = oldClassDoc.data().students || [];
            await updateDoc(doc(db, 'classes', oldClassId), {
                students: oldStudents.filter(id => id !== studentId)
            });
            
            // ThÃªm vÃ o lá»›p má»›i
            await updateDoc(doc(db, 'classes', newClassId), {
                students: arrayUnion(studentId)
            });
        }
        
        alert('Cáº­p nháº­t thÃ nh cÃ´ng!');
        adminManageStudents();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.deleteStudent = async function(studentId, studentName) {
    if (!confirm(`XÃ³a há»c sinh "${studentName}"? Táº¥t cáº£ káº¿t quáº£ há»c táº­p sáº½ bá»‹ xÃ³a!`)) return;
    
    showLoading(true);
    try {
        // Láº¥y thÃ´ng tin há»c sinh Ä‘á»ƒ biáº¿t classId
        const studentDoc = await getDoc(doc(db, 'students', studentId));
        const classId = studentDoc.data().classId;
        
        // XÃ³a khá»i class
        if (classId) {
            const classDoc = await getDoc(doc(db, 'classes', classId));
            const students = classDoc.data().students || [];
            await updateDoc(doc(db, 'classes', classId), {
                students: students.filter(id => id !== studentId)
            });
        }
        
        // XÃ³a táº¥t cáº£ results cá»§a há»c sinh nÃ y
        const resultsRef = collection(db, 'results');
        const q = query(resultsRef, where('studentId', '==', studentId));
        const resultsSnap = await getDocs(q);
        resultsSnap.forEach(async (doc) => {
            await deleteDoc(doc.ref);
        });
        
        // XÃ³a há»c sinh
        await deleteDoc(doc(db, 'students', studentId));
        
        alert('ÄÃ£ xÃ³a há»c sinh!');
        adminManageStudents();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// XEM BÃO CÃO
window.adminViewReports = async function() {
    showLoading(true);
    try {
        const classesSnap = await getDocs(collection(db, 'classes'));
        
        let html = `
            <h2 class="text-2xl font-bold mb-6">ğŸ“Š BÃ¡o cÃ¡o tá»•ng quan</h2>
            
            <div class="grid md:grid-cols-3 gap-4 mb-6">
        `;
        
        // Thá»‘ng kÃª tá»•ng quan
        const teachersSnap = await getDocs(collection(db, 'teachers'));
        const studentsSnap = await getDocs(collection(db, 'students'));
        const assignmentsSnap = await getDocs(collection(db, 'assignments'));
        
        html += `
                <div class="bg-green-100 border-2 border-green-300 rounded-lg p-6 text-center">
                    <p class="text-4xl font-bold text-green-700">${teachersSnap.size}</p>
                    <p class="text-gray-700 mt-2">GiÃ¡o viÃªn</p>
                </div>
                <div class="bg-blue-100 border-2 border-blue-300 rounded-lg p-6 text-center">
                    <p class="text-4xl font-bold text-blue-700">${studentsSnap.size}</p>
                    <p class="text-gray-700 mt-2">Há»c sinh</p>
                </div>
                <div class="bg-purple-100 border-2 border-purple-300 rounded-lg p-6 text-center">
                    <p class="text-4xl font-bold text-purple-700">${assignmentsSnap.size}</p>
                    <p class="text-gray-700 mt-2">BÃ i táº­p</p>
                </div>
            </div>
            
            <h3 class="text-xl font-bold mb-4">ğŸ“š BÃ¡o cÃ¡o theo lá»›p</h3>
            <div class="space-y-4">
        `;
        
        for (const classDoc of classesSnap.docs) {
            const classData = classDoc.data();
            const studentIds = classData.students || [];
            
            // Äáº¿m sá»‘ bÃ i táº­p cá»§a lá»›p
            const assignmentsRef = collection(db, 'assignments');
            const qAssign = query(assignmentsRef, where('classId', '==', classDoc.id));
            const assignSnap = await getDocs(qAssign);
            
            // TÃ­nh Ä‘iá»ƒm trung bÃ¬nh lá»›p
            let totalScore = 0;
            let totalAttempts = 0;
            
            for (const stId of studentIds) {
                const resultsRef = collection(db, 'results');
                const qResults = query(resultsRef, where('studentId', '==', stId));
                const resultsSnap = await getDocs(qResults);
                
                resultsSnap.forEach(rDoc => {
                    totalScore += rDoc.data().score;
                    totalAttempts++;
                });
            }
            
            const avgScore = totalAttempts > 0 ? Math.round(totalScore / totalAttempts) : 0;
            
            html += `
                <div class="bg-white border rounded-lg p-6">
                    <h4 class="text-xl font-bold mb-3">${classData.name}</h4>
                    <div class="grid md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">Há»c sinh</p>
                            <p class="text-2xl font-bold text-blue-600">${studentIds.length}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">BÃ i táº­p</p>
                            <p class="text-2xl font-bold text-purple-600">${assignSnap.size}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">LÆ°á»£t lÃ m bÃ i</p>
                            <p class="text-2xl font-bold text-orange-600">${totalAttempts}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Äiá»ƒm TB</p>
                            <p class="text-2xl font-bold text-green-600">${avgScore}</p>
                        </div>
                    </div>
<div class="flex gap-2 mt-4">
    <button onclick="viewDetailedClassReport('${classDoc.id}', '${classData.name}')" 
            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
        ğŸ“Š Xem chi tiáº¿t há»c sinh
    </button>
    <button onclick="viewWordStats('${classDoc.id}', '${classData.name}')" 
            class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
        ğŸ“ˆ Thá»‘ng kÃª tá»«ng tá»«
    </button>
</div>                    
                </div>
            `;
        }
        
        html += '</div>';
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.viewWordStats = async function(classId, className) {
    showLoading(true);
    try {
        const assignmentsRef = collection(db, 'assignments');
        const qAssign = query(assignmentsRef, where('classId', '==', classId));
        const assignSnap = await getDocs(qAssign);
        
        let html = `
            <button onclick="adminViewReports()" class="text-blue-600 hover:underline mb-4 flex items-center gap-2">
                <span>â†</span> Quay láº¡i bÃ¡o cÃ¡o tá»•ng quan
            </button>
            
            <h2 class="text-2xl font-bold mb-6">ğŸ“ˆ Thá»‘ng kÃª tá»«ng tá»« - ${className}</h2>
            <p class="text-gray-600 mb-6">Xem tá»« nÃ o há»c sinh hay sai Ä‘á»ƒ dáº¡y láº¡i trÃªn lá»›p</p>
        `;
        
        if (assignSnap.empty) {
            html += '<p class="text-gray-500">ChÆ°a cÃ³ bÃ i táº­p nÃ o.</p>';
        } else {
            for (const assignDoc of assignSnap.docs) {
                const assign = assignDoc.data();
                const wordsData = assign.wordsData || assign.words.map(w => ({word: w}));
                
                html += `
                    <div class="bg-white border rounded-lg p-6 mb-6 shadow">
                        <h3 class="text-xl font-bold mb-4">ğŸ“ ${assign.name}</h3>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-blue-600 text-white">
                                    <tr>
                                        <th class="p-3 text-left">Tá»«</th>
                                        <th class="p-3 text-center">LÆ°á»£t lÃ m</th>
                                        <th class="p-3 text-center">Äiá»ƒm TB</th>
                                        <th class="p-3 text-center">Tá»· lá»‡ Ä‘áº¡t (â‰¥60Ä‘)</th>
                                        <th class="p-3 text-center">Äá»™ khÃ³</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                // Máº£ng Ä‘á»ƒ sort theo Ä‘iá»ƒm TB
                let wordStats = [];
                
                for (const wordData of wordsData) {
                    const word = wordData.word;
                    const resultsRef = collection(db, 'results');
                    const qResults = query(resultsRef,
                        where('assignmentId', '==', assignDoc.id),
                        where('word', '==', word)
                    );
                    const resultsSnap = await getDocs(qResults);
                    
                    let totalScore = 0;
                    let passCount = 0;
                    
                    resultsSnap.forEach(rDoc => {
                        const score = rDoc.data().score;
                        totalScore += score;
                        if (score >= 60) passCount++;
                    });
                    
                    const avgScore = resultsSnap.size > 0 ? Math.round(totalScore / resultsSnap.size) : 0;
                    const passRate = resultsSnap.size > 0 ? Math.round((passCount / resultsSnap.size) * 100) : 0;
                    
                    wordStats.push({
                        word,
                        attempts: resultsSnap.size,
                        avgScore,
                        passRate
                    });
                }
                
                // Sort: Tá»« khÃ³ nháº¥t (Ä‘iá»ƒm tháº¥p) lÃªn Ä‘áº§u
                wordStats.sort((a, b) => a.avgScore - b.avgScore);
                
                wordStats.forEach(stat => {
                    let scoreColor, difficultyLabel, difficultyColor;
                    if (stat.avgScore >= 80) {
                        scoreColor = 'text-green-600';
                        difficultyLabel = 'âœ… Dá»…';
                        difficultyColor = 'bg-green-100 text-green-800';
                    } else if (stat.avgScore >= 60) {
                        scoreColor = 'text-yellow-600';
                        difficultyLabel = 'âš ï¸ Trung bÃ¬nh';
                        difficultyColor = 'bg-yellow-100 text-yellow-800';
                    } else {
                        scoreColor = 'text-red-600';
                        difficultyLabel = 'ğŸ”¥ KHÃ“ - Cáº§n dáº¡y láº¡i';
                        difficultyColor = 'bg-red-100 text-red-800';
                    }
                    
                    html += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-bold text-lg">${stat.word}</td>
                            <td class="p-3 text-center">${stat.attempts}</td>
                            <td class="p-3 text-center font-bold text-xl ${scoreColor}">${stat.avgScore}</td>
                            <td class="p-3 text-center">${stat.passRate}%</td>
                            <td class="p-3 text-center">
                                <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${difficultyColor}">
                                    ${difficultyLabel}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
        }
        
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.viewDetailedClassReport = async function(classId, className) {
    showLoading(true);
    try {
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const studentIds = classDoc.data().students || [];
        
        let html = `
            <div class="mb-4">
                <button onclick="adminViewReports()" class="text-blue-600">â† Quay láº¡i bÃ¡o cÃ¡o tá»•ng quan</button>
            </div>
            
            <h2 class="text-2xl font-bold mb-6">ğŸ“Š BÃ¡o cÃ¡o chi tiáº¿t: ${className}</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full bg-white rounded-lg overflow-hidden">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th class="p-3 text-left">Há»c sinh</th>
                            <th class="p-3 text-center">Sá»‘ bÃ i lÃ m</th>
                            <th class="p-3 text-center">Äiá»ƒm TB</th>
                            <th class="p-3 text-center">Cao nháº¥t</th>
                            <th class="p-3 text-center">Tháº¥p nháº¥t</th>
<th class="p-3 text-center">Thao tÃ¡c</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const stId of studentIds) {
            const stDoc = await getDoc(doc(db, 'students', stId));
            if (!stDoc.exists()) continue;
            
            const student = stDoc.data();
            
            // Láº¥y results cá»§a há»c sinh
            const resultsRef = collection(db, 'results');
            const qResults = query(resultsRef, where('studentId', '==', stId));
            const resultsSnap = await getDocs(qResults);
            
            let totalScore = 0;
            let maxScore = 0;
            let minScore = 100;
            
            resultsSnap.forEach(rDoc => {
                const score = rDoc.data().score;
                totalScore += score;
                if (score > maxScore) maxScore = score;
                if (score < minScore) minScore = score;
            });
            
            const avgScore = resultsSnap.size > 0 ? Math.round(totalScore / resultsSnap.size) : 0;
            const attempts = resultsSnap.size;
            
html += `
    <tr class="border-b hover:bg-gray-50">
        <td class="p-3 font-semibold">${student.name}</td>
        <td class="p-3 text-center">${attempts}</td>
        <td class="p-3 text-center font-bold ${avgScore >= 80 ? 'text-green-600' : avgScore >= 60 ? 'text-yellow-600' : 'text-red-600'}">
            ${avgScore}
        </td>
        <td class="p-3 text-center text-green-600 font-bold">${maxScore}</td>
        <td class="p-3 text-center text-red-600 font-bold">${minScore === 100 ? '-' : minScore}</td>
        <td class="p-3 text-center">
            <button onclick="viewStudentDetail('${stId}', '${student.name}', '${classId}')" 
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                ğŸ“Š Xem chi tiáº¿t
            </button>
        </td>
    </tr>
`;
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.viewStudentDetail = async function(studentId, studentName, classId) {
    showLoading(true);
    try {
        // Láº¥y tÃªn lá»›p
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const className = classDoc.data().name;
        
        // Láº¥y táº¥t cáº£ assignments cá»§a lá»›p
        const assignmentsRef = collection(db, 'assignments');
        const qAssign = query(assignmentsRef, where('classId', '==', classId));
        const assignSnap = await getDocs(qAssign);
        
        let html = `
            <button onclick="viewDetailedClassReport('${classId}', '${className}')" 
                    class="text-blue-600 hover:underline mb-4 flex items-center gap-2">
                <span>â†</span> Quay láº¡i bÃ¡o cÃ¡o lá»›p
            </button>
            
            <h2 class="text-2xl font-bold mb-6">ğŸ“Š Chi tiáº¿t há»c sinh: ${studentName}</h2>
        `;
        
        if (assignSnap.empty) {
            html += '<p class="text-gray-500">ChÆ°a cÃ³ bÃ i táº­p nÃ o.</p>';
        } else {
            for (const assignDoc of assignSnap.docs) {
                const assign = assignDoc.data();
                const wordsData = assign.wordsData || assign.words.map(w => ({word: w}));
                
                html += `
                    <div class="bg-white border-2 border-blue-200 rounded-lg p-6 mb-6 shadow">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">ğŸ“ ${assign.name}</h3>
                        <div class="space-y-3">
                `;
                
                // Duyá»‡t tá»«ng tá»«
                for (const wordData of wordsData) {
                    const word = wordData.word;
                    
                    // Láº¥y káº¿t quáº£ cá»§a tá»« nÃ y
                    const resultsRef = collection(db, 'results');
                    const qResults = query(resultsRef,
                        where('studentId', '==', studentId),
                        where('assignmentId', '==', assignDoc.id),
                        where('word', '==', word)
                    );
                    const resultsSnap = await getDocs(qResults);
                    
                    let scores = [];
                    let bestScore = 0;
                    let attempts = 0;
                    
                    resultsSnap.forEach(rDoc => {
                        const score = rDoc.data().score;
                        scores.push(score);
                        if (score > bestScore) bestScore = score;
                        attempts++;
                    });
                    
                    const avgScore = attempts > 0 ? Math.round(scores.reduce((a,b) => a+b, 0) / attempts) : 0;
                    
                    let bgColor, borderColor, textColor;
                    if (avgScore >= 80) {
                        bgColor = 'bg-green-50';
                        borderColor = 'border-green-300';
                        textColor = 'text-green-700';
                    } else if (avgScore >= 60) {
                        bgColor = 'bg-yellow-50';
                        borderColor = 'border-yellow-300';
                        textColor = 'text-yellow-700';
                    } else {
                        bgColor = 'bg-red-50';
                        borderColor = 'border-red-300';
                        textColor = 'text-red-700';
                    }
                    
                    html += `
                        <div class="${bgColor} border-2 ${borderColor} rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">${word}</span>
                                <div class="text-sm ${textColor}">
                                    <span class="mr-4">ğŸ¯ LÃ m: <strong>${attempts}</strong> láº§n</span>
                                    <span class="mr-4">ğŸ“Š TB: <strong>${avgScore}</strong></span>
                                    <span>â­ Cao nháº¥t: <strong>${bestScore}</strong></span>
                                </div>
                            </div>
                            ${attempts > 0 ? `
                                <div class="mt-3 pt-3 border-t ${borderColor}">
                                    <p class="text-xs text-gray-600 mb-1">Lá»‹ch sá»­ cÃ¡c láº§n lÃ m:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${scores.map((s, idx) => `
                                            <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${
                                                s >= 80 ? 'bg-green-200 text-green-800' :
                                                s >= 60 ? 'bg-yellow-200 text-yellow-800' :
                                                'bg-red-200 text-red-800'
                                            }">
                                                Láº§n ${idx + 1}: ${s}Ä‘
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : '<p class="text-gray-500 text-sm mt-2">ChÆ°a lÃ m tá»« nÃ y</p>'}
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
        }
        
        document.getElementById('adminContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// ==================== SYLLABLE ANALYSIS ====================
const syllableDB = {
    'carbohydrate': ['car', 'bo', 'hy', 'drate'],
    'fibre': ['fi', 'bre'],
    'fiber': ['fi', 'ber'],
    'diet': ['di', 'et'],
    'protein': ['pro', 'tein'],
    'vitamin': ['vi', 'ta', 'min'],
    'ship': ['ship'],
    'cat': ['cat'],
    'dog': ['dog'],
    'apple': ['ap', 'ple'],
    'banana': ['ba', 'na', 'na'],
    'orange': ['or', 'ange'],
    'exercise': ['ex', 'er', 'cise'],
    'healthy': ['heal', 'thy'],
    'water': ['wa', 'ter'],
    'something': ['some', 'thing'],
    'weight': ['weight'],
    'stomach': ['stom', 'ach'],
    'upset': ['up', 'set'],
    'casualty': ['cas', 'u', 'al', 'ty'],
    'department': ['de', 'part', 'ment']
};

function splitIntoSyllables(word) {
    word = word.toLowerCase().trim();
    
    // Kiá»ƒm tra database trÆ°á»›c
    if (syllableDB[word]) {
        return syllableDB[word];
    }
    
    // DÃ¹ng Hyphen.js (náº¿u cÃ³)
    if (typeof Hypher !== 'undefined') {
        try {
            const h = new Hypher(Hypher.languages['en-us']);
            const syllables = h.hyphenate(word);
            if (syllables.length > 0) {
                return syllables;
            }
        } catch (e) {
            console.warn('Hyphen.js error:', e);
        }
    }
    
    // Fallback vá» thuáº­t toÃ¡n cÅ©
    if (word.length <= 3) return [word];
   
    const vowels = 'aeiouy';
    const syllables = [];
    let start = 0;
   
    for (let i = 1; i < word.length; i++) {
        const prevIsVowel = vowels.includes(word[i - 1]);
        const currIsVowel = vowels.includes(word[i]);
       
        if (prevIsVowel && !currIsVowel && i < word.length - 1) {
            syllables.push(word.substring(start, i + 1));
            start = i + 1;
        }
    }
   
    if (start < word.length) {
        if (syllables.length > 0) {
            const remaining = word.substring(start);
            if (remaining.length <= 2) {
                syllables[syllables.length - 1] += remaining;
            } else {
                syllables.push(remaining);
            }
        } else {
            syllables.push(word.substring(start));
        }
    }
   
    return syllables.length > 0 ? syllables : [word];
}

function similarity(s1, s2) {
    if (!s1 || !s2) return 0;
    let longer = s1.length > s2.length ? s1 : s2;
    let shorter = s1.length > s2.length ? s2 : s1;
    if (longer.length === 0) return 1.0;
    return (longer.length - editDistance(longer, shorter)) / longer.length;
}

function editDistance(s1, s2) {
    s1 = s1.toLowerCase();
    s2 = s2.toLowerCase();
    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i === 0) costs[j] = j;
            else if (j > 0) {
                let newValue = costs[j - 1];
                if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                }
                costs[j - 1] = lastValue;
                lastValue = newValue;
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}

// ==================== WHISPER AI GRADING (PHáº¦N Má»šI) ====================
window.recordWord = async function(word) {
    const resultDiv = document.getElementById(`result-${word}`);
    
    // Kiá»ƒm tra API key
    if (HUGGING_FACE_API_KEY === 'YOUR_API_KEY_HERE') {
        resultDiv.innerHTML = `
            <div class="p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                <p class="text-yellow-800 font-bold">âš ï¸ ChÆ°a cáº¥u hÃ¬nh API Key</p>
                <p class="text-sm text-yellow-700 mt-2">Vui lÃ²ng:</p>
                <ol class="text-sm text-yellow-700 mt-2 ml-4 list-decimal">
                    <li>Truy cáº­p: <a href="https://huggingface.co/settings/tokens" target="_blank" class="text-blue-600 underline">huggingface.co/settings/tokens</a></li>
                    <li>Táº¡o token má»›i (New token)</li>
                    <li>Copy token vÃ  thay vÃ o dÃ²ng 137 trong code</li>
                </ol>
            </div>
        `;
        return;
    }
    
    // Kiá»ƒm tra quyá»n microphone
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        resultDiv.innerHTML = `
            <div class="p-6 bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl text-center">
                <div class="animate-bounce inline-block w-16 h-16 bg-gradient-to-br from-green-500 to-blue-500 rounded-full mb-4 flex items-center justify-center">
                    <span class="text-2xl">ğŸ¤</span>
                </div>
                <p class="text-green-700 font-bold text-xl mb-1">ğŸ™ï¸ ÄANG THU Ã‚M...</p>
                <p class="text-sm text-green-600 mt-1">NÃ³i rÃµ tá»«: <strong class="text-lg font-mono">${word}</strong></p>
                <div class="mt-4 flex justify-center space-x-2">
                    <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce"></div>
                    <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-4 h-4 bg-green-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
                <button onclick="stopRecording('${word}')" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold">
                    â¹ï¸ Dá»ªNG & CHáº¤M ÄIá»‚M
                </button>
                <p class="text-xs text-gray-500 mt-2">Hoáº·c tá»± Ä‘á»™ng sau 5 giÃ¢y</p>
            </div>
        `;
        
        // Báº¯t Ä‘áº§u thu Ã¢m
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            stream.getTracks().forEach(track => track.stop());
            
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            
            // Gá»­i lÃªn Whisper AI Ä‘á»ƒ cháº¥m Ä‘iá»ƒm
            await gradeWithWhisper(word, audioBlob, resultDiv);
        };
        
        mediaRecorder.start();
        
        // Tá»± Ä‘á»™ng dá»«ng sau 5 giÃ¢y
        setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording(word);
            }
        }, 5000);
        
    } catch (err) {
        resultDiv.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-600 font-bold">âŒ KhÃ´ng cÃ³ quyá»n truy cáº­p microphone</p>
                <p class="text-sm text-red-500 mt-1">Vui lÃ²ng cho phÃ©p microphone trong trÃ¬nh duyá»‡t</p>
            </div>
        `;
    }
}

window.stopRecording = function(word) {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
}

async function gradeWithWhisper(word, audioBlob, resultDiv) {
    resultDiv.innerHTML = `
        <div class="p-6 bg-purple-50 border-2 border-purple-200 rounded-xl text-center">
            <div class="animate-spin inline-block w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full mb-4"></div>
            <p class="text-purple-700 font-bold text-xl">ğŸ¤– AI Ä‘ang cháº¥m Ä‘iá»ƒm...</p>
        </div>
    `;
    
    try {
        // Convert audio sang base64
        const reader = new FileReader();
        const base64Audio = await new Promise((resolve, reject) => {
            reader.onloadend = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(audioBlob);
        });
        
        // URL Apps Script cá»§a báº¡n
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznNlh8Pu17U_ggJkOqHa_hU87acomNHkazEDw5-1evMBJbNWrDUaXHC0tLUURkyw6G/exec'; // â† THAY Äá»”I
        
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // â† THÃŠM DÃ’NG NÃ€Y
            body: new URLSearchParams({
                audio: base64Audio
            })
        });
        
        // VÃ¬ dÃ¹ng no-cors nÃªn khÃ´ng Ä‘á»c Ä‘Æ°á»£c response
        // Pháº£i dÃ¹ng cÃ¡ch khÃ¡c: redirect mode
        const formData = new FormData();
        formData.append('audio', base64Audio);
        
        const response2 = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: formData,
            redirect: 'follow'
        });
        
        const text = await response2.text();
        console.log('Raw response:', text);
        
        let result;
        try {
            result = JSON.parse(text);
        } catch (e) {
            // Náº¿u response cÃ³ HTML, extract JSON
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                result = JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('KhÃ´ng parse Ä‘Æ°á»£c JSON');
            }
        }
        
        if (!result.success) {
            throw new Error(result.error || 'Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh');
        }
        
        const transcript = result.text.trim();
        
        if (!transcript) {
            throw new Error('KhÃ´ng nháº­n diá»‡n Ä‘Æ°á»£c giá»ng nÃ³i');
        }
        
        console.log('ğŸ¤– Whisper nháº­n diá»‡n:', transcript);
        
        const detailedAnalysis = analyzeDetailedPronunciation(word, transcript);
        
        await addDoc(collection(db, 'results'), {
            studentId: currentUser.id,
            assignmentId: currentAssignment.id,
            word,
            score: detailedAnalysis.score,
            recognizedText: transcript,
            syllableAnalysis: detailedAnalysis,
            method: 'whisper-ai',
            createdAt: new Date()
        });
        
        displayDetailedResults(word, transcript, detailedAnalysis, resultDiv);
        updateProgress();
        
    } catch (error) {
        console.error('Whisper API Error:', error);
        resultDiv.innerHTML = `
            <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-600 font-bold">âŒ Lá»—i káº¿t ná»‘i AI</p>
                <p class="text-sm text-red-500 mt-1">${error.message}</p>
                <p class="text-xs text-gray-500 mt-2">Debug: Xem Console (F12)</p>
                <button onclick="recordWord('${word}')" class="mt-3 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">
                    ğŸ”„ Thá»­ láº¡i
                </button>
            </div>
        `;
    }
}
function analyzeDetailedPronunciation(correctWord, spokenText) {
    correctWord = correctWord.toLowerCase().trim();
    spokenText = spokenText.toLowerCase().trim();
    
    const correctSyllables = splitIntoSyllables(correctWord);
    const spokenWords = spokenText.split(' ');
    
    // TÃ¬m tá»« khá»›p nháº¥t
    let bestMatch = spokenText;
    let bestSimilarity = similarity(correctWord, spokenText);
    
    for (const spokenWord of spokenWords) {
        const sim = similarity(correctWord, spokenWord);
        if (sim > bestSimilarity) {
            bestSimilarity = sim;
            bestMatch = spokenWord;
        }
    }
    
    const spokenSyllables = splitIntoSyllables(bestMatch);
    
    const analysis = {
        syllables: [],
        wrongSyllables: [],
        correctSyllables: [],
        score: 0,
        totalSyllables: correctSyllables.length,
        matchedWord: bestMatch,
        overallSimilarity: bestSimilarity
    };
    
    // So sÃ¡nh tá»«ng Ã¢m tiáº¿t - CHáº¶T HÆ N
    correctSyllables.forEach((syllable, index) => {
        const spokenSyllable = spokenSyllables[index] || '';
        const syllableSimilarity = similarity(syllable, spokenSyllable);
        
        // TÄ‚NG NGÆ¯á» NG tá»« 0.75 â†’ 0.85
        const isCorrect = syllableSimilarity > 0.9;
        
        analysis.syllables.push({
            text: syllable,
            spoken: spokenSyllable,
            correct: isCorrect,
            similarity: Math.round(syllableSimilarity * 100),
            index: index
        });
        
        if (isCorrect) {
            analysis.correctSyllables.push(syllable);
        } else {
            analysis.wrongSyllables.push({
                text: syllable,
                spoken: spokenSyllable,
                similarity: Math.round(syllableSimilarity * 100)
            });
        }
    });
    
    // TÃ­nh Ä‘iá»ƒm CHáº¶T HÆ N
    const syllableScore = (analysis.correctSyllables.length / analysis.totalSyllables) * 100;
    const similarityScore = bestSimilarity * 100;
    
    // Bonus giáº£m tá»« 15 â†’ 10
    let bonus = 0;
    if (bestMatch === correctWord) {
        bonus = 10;
    } else if (bestSimilarity > 0.95) { // TÄƒng tá»« 0.9 â†’ 0.95
        bonus = 5;
    }
    
    // Penalty tÄƒng tá»« 10 â†’ 20
    let penalty = 0;
    if (analysis.wrongSyllables.length > analysis.totalSyllables / 2) {
        penalty = 20;
    }
    
    // Penalty thÃªm náº¿u similarity tháº¥p
    if (bestSimilarity < 0.85) {
        penalty += 20;
    }
    
    // CÃ´ng thá»©c má»›i: Æ¯u tiÃªn syllable hÆ¡n (0.7 thay vÃ¬ 0.6)
    analysis.score = Math.round(
        Math.min(100, Math.max(0, 
            (syllableScore * 0.8 + similarityScore * 0.2) + bonus - penalty
        ))
    );
    
    return analysis;
}

function displayDetailedResults(word, transcript, analysis, resultDiv) {
    const score = analysis.score;
    const emoji = score >= 80 ? 'ğŸ‰' : score >= 60 ? 'ğŸ‘' : 'ğŸ’ª';
    const message = score >= 80 ? 'Xuáº¥t sáº¯c! PhÃ¡t Ã¢m ráº¥t chuáº©n!' : 
                   score >= 60 ? 'Tá»‘t láº¯m! CÃ²n má»™t vÃ i Ã¢m tiáº¿t cáº§n cáº£i thiá»‡n' : 
                   'Cá»‘ lÃªn! HÃ£y nghe ká»¹ vÃ  thá»­ láº¡i nhÃ©!';
    
    let html = `
        <div class="p-6 bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl shadow-2xl">
            <div class="text-center mb-6">
                <div class="inline-block w-24 h-24 bg-gradient-to-br ${
                    score >= 80 ? 'from-green-400 via-green-500 to-green-600' :
                    score >= 60 ? 'from-yellow-400 via-yellow-500 to-yellow-600' : 
                    'from-red-400 via-red-500 to-red-600'
                } rounded-full flex items-center justify-center mb-4 shadow-xl">
                    <span class="text-5xl">${emoji}</span>
                </div>
                
                <h3 class="text-5xl font-bold text-gray-800 mb-2">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600">${score}</span>
                </h3>
                <p class="text-xl font-semibold text-gray-700 mb-3">${message}</p>
                
                <div class="flex justify-center gap-4 text-sm">
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-semibold">
                        âœ… ${analysis.correctSyllables.length}/${analysis.totalSyllables} Ã¢m tiáº¿t Ä‘Ãºng
                    </span>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-semibold">
                        ğŸ¯ ${Math.round(analysis.overallSimilarity * 100)}% Ä‘á»™ chÃ­nh xÃ¡c
                    </span>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-lg p-4 border-2 border-gray-200">
                    <p class="text-sm text-gray-600 mb-2">ğŸ¯ Tá»« Ä‘Ãºng:</p>
                    <p class="text-2xl font-bold text-blue-700">${word}</p>
</div>
<div class="bg-white rounded-lg p-4 border-2 border-purple-200">
<p class="text-sm text-gray-600 mb-2">ğŸ¤ AI nghe Ä‘Æ°á»£c:</p>
<p class="text-2xl font-bold text-purple-700">${transcript}</p>
</div>
</div>
        <div class="bg-white rounded-lg p-5 mb-6 border-2 border-blue-200">
            <h4 class="font-bold text-lg mb-4 text-gray-800">ğŸ“Š PhÃ¢n tÃ­ch tá»«ng Ã¢m tiáº¿t:</h4>
            <div class="space-y-3">
`;

analysis.syllables.forEach((syl, idx) => {
    const bgColor = syl.correct ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300';
    const textColor = syl.correct ? 'text-green-700' : 'text-red-700';
    const icon = syl.correct ? 'âœ…' : 'âŒ';
    
    html += `
        <div class="${bgColor} border-2 rounded-xl p-5 shadow-md">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xl font-bold ${textColor}">${icon} Ã‚m tiáº¿t ${idx + 1}</span>
                <span class="text-sm font-semibold ${textColor}">${syl.similarity}% khá»›p</span>
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                    <p class="text-gray-600 mb-1">ÄÃºng:</p>
                    <p class="font-bold text-blue-700 text-lg">${syl.text}</p>
                </div>
                <div>
                    <p class="text-gray-600 mb-1">Báº¡n nÃ³i:</p>
                    <p class="font-bold ${textColor} text-lg">${syl.spoken || '(khÃ´ng cÃ³)'}</p>
                </div>
            </div>
        </div>
    `;
});

html += `
            </div>
        </div>
`;

// Gá»£i Ã½ luyá»‡n táº­p
if (analysis.wrongSyllables.length > 0) {
    html += `
        <div class="bg-orange-50 border-2 border-orange-300 rounded-lg p-5 mb-6">
            <h4 class="font-bold text-lg mb-3 text-orange-800">ğŸ’¡ Cáº§n luyá»‡n thÃªm:</h4>
            <div class="flex flex-wrap gap-2 mb-4">
    `;
    
    analysis.wrongSyllables.forEach(wrong => {
        html += `
            <span class="bg-orange-200 text-orange-800 px-4 py-2 rounded-full font-bold">
                ${wrong.text} (${wrong.similarity}% khá»›p)
            </span>
        `;
    });
    
    html += `
            </div>
             <button onclick="speakWord('${word}', 0.1)" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-bold w-full">
    ğŸ¢ Nghe Ráº¤T CHáº¬M Ä‘á»ƒ luyá»‡n láº¡i
</button>
        </div>
    `;
} else {
    html += `
        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-5 mb-6 text-center">
            <p class="text-green-700 font-bold text-xl">ğŸŠ HoÃ n háº£o! Táº¥t cáº£ Ã¢m tiáº¿t Ä‘á»u chuáº©n!</p>
        </div>
    `;
}

html += `
        <div class="grid grid-cols-2 gap-3">
         <button onclick="recordWord('${word}')" class="bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-bold">
                ğŸ¤ Thá»­ láº¡i
            </button>
        </div>
    </div>
`;

resultDiv.innerHTML = html;
}
// ==================== SPEECH FUNCTIONS ====================
window.speakWord = function(word, rate) {
const utterance = new SpeechSynthesisUtterance(word);
utterance.rate = rate;
utterance.lang = 'en-US';
utterance.volume = 1;
utterance.pitch = 1;
speechSynthesis.speak(utterance);
}
window.speakSyllables = function(word) {
const syllables = splitIntoSyllables(word);
let index = 0;
const speakNext = () => {
if (index < syllables.length) {
const syllable = syllables[index];
const utterance = new SpeechSynthesisUtterance(syllable);
utterance.rate = 0.5;
utterance.lang = 'en-US';
utterance.onend = () => {
index++;
setTimeout(speakNext, 1200);
};
speechSynthesis.speak(utterance);
}
};
speakNext();
}

// ==================== TEACHER FUNCTIONS ====================
window.showCreateClass = function() {
    document.getElementById('teacherContent').innerHTML = `
        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 text-center">
            <p class="text-yellow-800 font-bold text-lg">âš ï¸ Chá»‰ Admin má»›i Ä‘Æ°á»£c táº¡o lá»›p má»›i</p>
            <p class="text-yellow-700 mt-2">LiÃªn há»‡ Admin Ä‘á»ƒ Ä‘Æ°á»£c phÃ¢n lá»›p giáº£ng dáº¡y</p>
            <button onclick="showMyClasses()" class="mt-4 bg-blue-500 text-white px-6 py-3 rounded-lg">
                â† Quay láº¡i danh sÃ¡ch lá»›p
            </button>
        </div>
    `;
}

window.showMyClasses = async function() {
    showLoading(true);
    try {
        const classesRef = collection(db, 'classes');
        // Sá»¬A: dÃ¹ng teacherIds thay vÃ¬ teacherCode
        const allClassesSnap = await getDocs(classesRef);
        
        let html = '<h2 class="text-2xl font-bold mb-4">Danh sÃ¡ch lá»›p</h2><div class="space-y-4">';
        
        allClassesSnap.forEach(doc => {
            const data = doc.data();
            // Kiá»ƒm tra xem GV cÃ³ trong teacherIds khÃ´ng
            if (data.teacherIds && data.teacherIds.includes(currentUser.id)) {
                html += `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition">
                        <h3 class="text-xl font-bold">${data.name}</h3>
                        <p class="text-gray-600">Sá»‘ há»c sinh: ${data.students?.length || 0}</p>
                        <div class="mt-3 flex gap-2">
                            <button onclick="manageStudents('${doc.id}', '${data.name}')" class="bg-green-500 text-white px-4 py-2 rounded">Quáº£n lÃ½ HS</button>
                            <button onclick="viewStats('${doc.id}', '${data.name}')" class="bg-purple-500 text-white px-4 py-2 rounded">Xem thá»‘ng kÃª</button>
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i táº£i danh sÃ¡ch lá»›p: ' + error.message);
    }
    showLoading(false);
}

window.manageStudents = async function(classId, className) {
showLoading(true);
try {
const classDoc = await getDoc(doc(db, 'classes', classId));
const students = classDoc.data().students || [];
    let html = `
        <h2 class="text-2xl font-bold mb-4">Quáº£n lÃ½ há»c sinh - ${className}</h2>
        <button onclick="showMyClasses()" class="text-blue-600 mb-4">â† Quay láº¡i</button>
       
        <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <h3 class="font-bold mb-2">ThÃªm há»c sinh má»›i</h3>
            <div class="flex gap-2">
                <input type="text" id="newStudentName" placeholder="TÃªn há»c sinh" class="flex-1 p-2 border rounded">
                <input type="text" id="newStudentCode" placeholder="MÃ£ (vd: HS001)" class="w-32 p-2 border rounded">
                <button onclick="addStudent('${classId}')" class="bg-green-500 text-white px-4 py-2 rounded">ThÃªm</button>
            </div>
        </div>
       
        <h3 class="font-bold mb-2">Danh sÃ¡ch há»c sinh (${students.length})</h3>
        <div class="space-y-2">
    `;
   
    for (const stId of students) {
        try {
            const stDoc = await getDoc(doc(db, 'students', stId));
            if (stDoc.exists()) {
                const st = stDoc.data();
                html += `
    <div class="border p-3 rounded flex justify-between items-center hover:bg-gray-50">
        <div>
            <span class="font-bold text-lg">${st.name}</span>
            <span class="text-gray-600 ml-2 font-mono">(${st.code})</span>
        </div>
        <div class="flex gap-2">
            <button onclick="editStudentTeacher('${stId}', '${classId}')" 
                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                âœï¸ Sá»­a tÃªn
            </button>
            <button onclick="deleteStudentTeacher('${stId}', '${st.name}', '${classId}')" 
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                ğŸ—‘ï¸ XÃ³a
            </button>
        </div>
    </div>
`;
            }
        } catch (error) {
            console.error('Lá»—i táº£i há»c sinh:', error);
        }
    }
   
    html += '</div>';
    document.getElementById('teacherContent').innerHTML = html;
} catch (error) {
    alert('Lá»—i táº£i danh sÃ¡ch há»c sinh: ' + error.message);
}
showLoading(false);
}

window.editStudentTeacher = async function(studentId, classId) {
    showLoading(true);
    try {
        const studentDoc = await getDoc(doc(db, 'students', studentId));
        const student = studentDoc.data();
        
        const newName = prompt(`Nháº­p tÃªn má»›i cho há»c sinh:\n(MÃ£: ${student.code})`, student.name);
        
        if (newName && newName.trim() && newName.trim() !== student.name) {
            await updateDoc(doc(db, 'students', studentId), {
                name: newName.trim()
            });
            alert('âœ… ÄÃ£ cáº­p nháº­t tÃªn há»c sinh!');
            
            // Reload danh sÃ¡ch
            const classDoc = await getDoc(doc(db, 'classes', classId));
            manageStudents(classId, classDoc.data().name);
        } else {
            showLoading(false);
        }
    } catch (error) {
        alert('Lá»—i: ' + error.message);
        showLoading(false);
    }
}

window.deleteStudentTeacher = async function(studentId, studentName, classId) {
    if (!confirm(`âš ï¸ XÃ“A Há»ŒC SINH "${studentName}"?\n\n- Táº¥t cáº£ káº¿t quáº£ bÃ i táº­p sáº½ Bá»Š XÃ“A\n- KhÃ´ng thá»ƒ hoÃ n tÃ¡c!\n\nBáº¡n cÃ³ cháº¯c cháº¯n?`)) return;
    
    showLoading(true);
    try {
        // 1. XÃ³a khá»i class
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const students = classDoc.data().students || [];
        await updateDoc(doc(db, 'classes', classId), {
            students: students.filter(id => id !== studentId)
        });
        
        // 2. XÃ³a táº¥t cáº£ results
        const resultsRef = collection(db, 'results');
        const q = query(resultsRef, where('studentId', '==', studentId));
        const resultsSnap = await getDocs(q);
        
        const deletePromises = [];
        resultsSnap.forEach((docSnapshot) => {
            deletePromises.push(deleteDoc(docSnapshot.ref));
        });
        await Promise.all(deletePromises);
        
        // 3. XÃ³a student
        await deleteDoc(doc(db, 'students', studentId));
        
        alert('âœ… ÄÃ£ xÃ³a há»c sinh vÃ  táº¥t cáº£ káº¿t quáº£!');
        manageStudents(classId, classDoc.data().name);
    } catch (error) {
        alert('Lá»—i: ' + error.message);
        showLoading(false);
    }
}

window.teacherViewReports = async function() {
    showLoading(true);
    try {
        // Láº¥y danh sÃ¡ch lá»›p cá»§a giÃ¡o viÃªn
        const classesRef = collection(db, 'classes');
        const allClassesSnap = await getDocs(classesRef);
        
        let html = `
            <h2 class="text-2xl font-bold mb-4">ğŸ“Š BÃ¡o cÃ¡o lá»›p cá»§a tÃ´i</h2>
            <div class="space-y-4">
        `;
        
        let hasClass = false;
        
        for (const classDoc of allClassesSnap.docs) {
            const classData = classDoc.data();
            
            // Chá»‰ hiá»ƒn thá»‹ lá»›p mÃ  giÃ¡o viÃªn nÃ y phá»¥ trÃ¡ch
            if (classData.teacherIds && classData.teacherIds.includes(currentUser.id)) {
                hasClass = true;
                const studentIds = classData.students || [];
                
                // TÃ­nh Ä‘iá»ƒm TB lá»›p
                let totalScore = 0, totalAttempts = 0;
                for (const stId of studentIds) {
                    const resultsRef = collection(db, 'results');
                    const qResults = query(resultsRef, where('studentId', '==', stId));
                    const resultsSnap = await getDocs(qResults);
                    resultsSnap.forEach(r => {
                        totalScore += r.data().score;
                        totalAttempts++;
                    });
                }
                const avgScore = totalAttempts > 0 ? Math.round(totalScore / totalAttempts) : 0;
                
                html += `
                    <div class="bg-white border-2 rounded-lg p-6 shadow hover:shadow-xl transition">
                        <h3 class="text-xl font-bold mb-3">${classData.name}</h3>
                        <div class="grid grid-cols-3 gap-4 text-center mb-4">
                            <div class="bg-blue-50 p-3 rounded">
                                <p class="text-2xl font-bold text-blue-600">${studentIds.length}</p>
                                <p class="text-sm text-gray-600">Há»c sinh</p>
                            </div>
                            <div class="bg-orange-50 p-3 rounded">
                                <p class="text-2xl font-bold text-orange-600">${totalAttempts}</p>
                                <p class="text-sm text-gray-600">LÆ°á»£t lÃ m</p>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <p class="text-2xl font-bold text-green-600">${avgScore}</p>
                                <p class="text-sm text-gray-600">Äiá»ƒm TB</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="viewDetailedClassReportTeacher('${classDoc.id}', '${classData.name}')" 
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                ğŸ“Š Xem chi tiáº¿t há»c sinh
                            </button>
                            <button onclick="viewWordStatsTeacher('${classDoc.id}', '${classData.name}')" 
                                    class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                ğŸ“ˆ Thá»‘ng kÃª tá»«ng tá»«
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        if (!hasClass) {
            html += '<p class="text-gray-600 bg-gray-50 p-6 rounded-lg text-center">Báº¡n chÆ°a Ä‘Æ°á»£c phÃ¢n cÃ´ng lá»›p nÃ o. LiÃªn há»‡ Admin!</p>';
        }
        
        html += '</div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// HÃ€M 1: Xem chi tiáº¿t há»c sinh (giá»‘ng Admin)
window.viewDetailedClassReportTeacher = async function(classId, className) {
    showLoading(true);
    try {
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const studentIds = classDoc.data().students || [];
        
        let html = `
            <button onclick="teacherViewReports()" class="text-blue-600 hover:underline mb-4 flex items-center gap-2">
                <span>â†</span> Quay láº¡i bÃ¡o cÃ¡o tá»•ng quan
            </button>
            
            <h2 class="text-2xl font-bold mb-6">ğŸ“Š BÃ¡o cÃ¡o chi tiáº¿t: ${className}</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full bg-white rounded-lg overflow-hidden shadow">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th class="p-3 text-left">Há»c sinh</th>
                            <th class="p-3 text-center">Sá»‘ bÃ i lÃ m</th>
                            <th class="p-3 text-center">Äiá»ƒm TB</th>
                            <th class="p-3 text-center">Cao nháº¥t</th>
                            <th class="p-3 text-center">Tháº¥p nháº¥t</th>
                            <th class="p-3 text-center">Thao tÃ¡c</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const stId of studentIds) {
            const stDoc = await getDoc(doc(db, 'students', stId));
            if (!stDoc.exists()) continue;
            
            const student = stDoc.data();
            
            const resultsRef = collection(db, 'results');
            const qResults = query(resultsRef, where('studentId', '==', stId));
            const resultsSnap = await getDocs(qResults);
            
            let totalScore = 0, maxScore = 0, minScore = 100;
            
            resultsSnap.forEach(rDoc => {
                const score = rDoc.data().score;
                totalScore += score;
                if (score > maxScore) maxScore = score;
                if (score < minScore) minScore = score;
            });
            
            const avgScore = resultsSnap.size > 0 ? Math.round(totalScore / resultsSnap.size) : 0;
            
            html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-semibold">${student.name}</td>
                    <td class="p-3 text-center">${resultsSnap.size}</td>
                    <td class="p-3 text-center font-bold ${avgScore >= 80 ? 'text-green-600' : avgScore >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                        ${avgScore}
                    </td>
                    <td class="p-3 text-center text-green-600 font-bold">${maxScore}</td>
                    <td class="p-3 text-center text-red-600 font-bold">${minScore === 100 ? '-' : minScore}</td>
                    <td class="p-3 text-center">
                        <button onclick="viewStudentDetailTeacher('${stId}', '${student.name}', '${classId}')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                            ğŸ“Š Xem chi tiáº¿t
                        </button>
                    </td>
                </tr>
            `;
        }
        
        html += '</tbody></table></div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// HÃ€M 2: Xem chi tiáº¿t 1 há»c sinh (giá»‘ng Admin)
window.viewStudentDetailTeacher = async function(studentId, studentName, classId) {
    showLoading(true);
    try {
        const classDoc = await getDoc(doc(db, 'classes', classId));
        const className = classDoc.data().name;
        
        const assignmentsRef = collection(db, 'assignments');
        const qAssign = query(assignmentsRef, where('classId', '==', classId));
        const assignSnap = await getDocs(qAssign);
        
        let html = `
            <button onclick="viewDetailedClassReportTeacher('${classId}', '${className}')" 
                    class="text-blue-600 hover:underline mb-4 flex items-center gap-2">
                <span>â†</span> Quay láº¡i bÃ¡o cÃ¡o lá»›p
            </button>
            
            <h2 class="text-2xl font-bold mb-6">ğŸ“Š Chi tiáº¿t há»c sinh: ${studentName}</h2>
        `;
        
        if (assignSnap.empty) {
            html += '<p class="text-gray-500">ChÆ°a cÃ³ bÃ i táº­p nÃ o.</p>';
        } else {
            for (const assignDoc of assignSnap.docs) {
                const assign = assignDoc.data();
                const wordsData = assign.wordsData || assign.words.map(w => ({word: w}));
                
                html += `
                    <div class="bg-white border-2 border-blue-200 rounded-lg p-6 mb-6 shadow">
                        <h3 class="text-xl font-bold mb-4 text-blue-700">ğŸ“ ${assign.name}</h3>
                        <div class="space-y-3">
                `;
                
                for (const wordData of wordsData) {
                    const word = wordData.word;
                    
                    const resultsRef = collection(db, 'results');
                    const qResults = query(resultsRef,
                        where('studentId', '==', studentId),
                        where('assignmentId', '==', assignDoc.id),
                        where('word', '==', word)
                    );
                    const resultsSnap = await getDocs(qResults);
                    
                    let scores = [];
                    let bestScore = 0;
                    
                    resultsSnap.forEach(rDoc => {
                        const score = rDoc.data().score;
                        scores.push(score);
                        if (score > bestScore) bestScore = score;
                    });
                    
                    const avgScore = scores.length > 0 ? Math.round(scores.reduce((a,b) => a+b, 0) / scores.length) : 0;
                    
                    let bgColor, borderColor, textColor;
                    if (avgScore >= 80) {
                        bgColor = 'bg-green-50'; borderColor = 'border-green-300'; textColor = 'text-green-700';
                    } else if (avgScore >= 60) {
                        bgColor = 'bg-yellow-50'; borderColor = 'border-yellow-300'; textColor = 'text-yellow-700';
                    } else {
                        bgColor = 'bg-red-50'; borderColor = 'border-red-300'; textColor = 'text-red-700';
                    }
                    
                    html += `
                        <div class="${bgColor} border-2 ${borderColor} rounded-lg p-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">${word}</span>
                                <div class="text-sm ${textColor}">
                                    <span class="mr-4">ğŸ¯ LÃ m: <strong>${scores.length}</strong> láº§n</span>
                                    <span class="mr-4">ğŸ“Š TB: <strong>${avgScore}</strong></span>
                                    <span>â­ Cao nháº¥t: <strong>${bestScore}</strong></span>
                                </div>
                            </div>
                            ${scores.length > 0 ? `
                                <div class="mt-3 pt-3 border-t ${borderColor}">
                                    <p class="text-xs text-gray-600 mb-1">Lá»‹ch sá»­ cÃ¡c láº§n lÃ m:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${scores.map((s, idx) => `
                                            <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${
                                                s >= 80 ? 'bg-green-200 text-green-800' :
                                                s >= 60 ? 'bg-yellow-200 text-yellow-800' :
                                                'bg-red-200 text-red-800'
                                            }">
                                                Láº§n ${idx + 1}: ${s}Ä‘
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : '<p class="text-gray-500 text-sm mt-2">ChÆ°a lÃ m tá»« nÃ y</p>'}
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
        }
        
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// HÃ€M 3: Thá»‘ng kÃª tá»«ng tá»« (giá»‘ng Admin)
window.viewWordStatsTeacher = async function(classId, className) {
    showLoading(true);
    try {
        const assignmentsRef = collection(db, 'assignments');
        const qAssign = query(assignmentsRef, where('classId', '==', classId));
        const assignSnap = await getDocs(qAssign);
        
        let html = `
            <button onclick="teacherViewReports()" class="text-blue-600 hover:underline mb-4 flex items-center gap-2">
                <span>â†</span> Quay láº¡i bÃ¡o cÃ¡o tá»•ng quan
            </button>
            
            <h2 class="text-2xl font-bold mb-6">ğŸ“ˆ Thá»‘ng kÃª tá»«ng tá»« - ${className}</h2>
            <p class="text-gray-600 mb-6">Xem tá»« nÃ o há»c sinh hay sai Ä‘á»ƒ dáº¡y láº¡i trÃªn lá»›p</p>
        `;
        
        if (assignSnap.empty) {
            html += '<p class="text-gray-500">ChÆ°a cÃ³ bÃ i táº­p nÃ o.</p>';
        } else {
            for (const assignDoc of assignSnap.docs) {
                const assign = assignDoc.data();
                const wordsData = assign.wordsData || assign.words.map(w => ({word: w}));
                
                html += `
                    <div class="bg-white border rounded-lg p-6 mb-6 shadow">
                        <h3 class="text-xl font-bold mb-4">ğŸ“ ${assign.name}</h3>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-green-600 text-white">
                                    <tr>
                                        <th class="p-3 text-left">Tá»«</th>
                                        <th class="p-3 text-center">LÆ°á»£t lÃ m</th>
                                        <th class="p-3 text-center">Äiá»ƒm TB</th>
                                        <th class="p-3 text-center">Tá»· lá»‡ Ä‘áº¡t (â‰¥60Ä‘)</th>
                                        <th class="p-3 text-center">Äá»™ khÃ³</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                let wordStats = [];
                
                for (const wordData of wordsData) {
                    const word = wordData.word;
                    const resultsRef = collection(db, 'results');
                    const qResults = query(resultsRef,
                        where('assignmentId', '==', assignDoc.id),
                        where('word', '==', word)
                    );
                    const resultsSnap = await getDocs(qResults);
                    
                    let totalScore = 0, passCount = 0;
                    
                    resultsSnap.forEach(rDoc => {
                        const score = rDoc.data().score;
                        totalScore += score;
                        if (score >= 60) passCount++;
                    });
                    
                    const avgScore = resultsSnap.size > 0 ? Math.round(totalScore / resultsSnap.size) : 0;
                    const passRate = resultsSnap.size > 0 ? Math.round((passCount / resultsSnap.size) * 100) : 0;
                    
                    wordStats.push({ word, attempts: resultsSnap.size, avgScore, passRate });
                }
                
                wordStats.sort((a, b) => a.avgScore - b.avgScore);
                
                wordStats.forEach(stat => {
                    let scoreColor, difficultyLabel, difficultyColor;
                    if (stat.avgScore >= 80) {
                        scoreColor = 'text-green-600';
                        difficultyLabel = 'âœ… Dá»…';
                        difficultyColor = 'bg-green-100 text-green-800';
                    } else if (stat.avgScore >= 60) {
                        scoreColor = 'text-yellow-600';
                        difficultyLabel = 'âš ï¸ Trung bÃ¬nh';
                        difficultyColor = 'bg-yellow-100 text-yellow-800';
                    } else {
                        scoreColor = 'text-red-600';
                        difficultyLabel = 'ğŸ”¥ KHÃ“ - Cáº§n dáº¡y láº¡i';
                        difficultyColor = 'bg-red-100 text-red-800';
                    }
                    
                    html += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-bold text-lg">${stat.word}</td>
                            <td class="p-3 text-center">${stat.attempts}</td>
                            <td class="p-3 text-center font-bold text-xl ${scoreColor}">${stat.avgScore}</td>
                            <td class="p-3 text-center">${stat.passRate}%</td>
                            <td class="p-3 text-center">
                                <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${difficultyColor}">
                                    ${difficultyLabel}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }
        }
        
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.addStudent = async function(classId) {
const name = document.getElementById('newStudentName').value.trim();
const code = document.getElementById('newStudentCode').value.trim();
if (!name || !code) return alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin');

showLoading(true);
try {
    const studentRef = await addDoc(collection(db, 'students'), {
        name,
        code,
        classId,
        createdAt: new Date()
    });
   
    const classRef = doc(db, 'classes', classId);
    await updateDoc(classRef, {
        students: arrayUnion(studentRef.id)
    });
   
    alert(`ÄÃ£ thÃªm há»c sinh ${name} (${code})`);
   
    const classDoc = await getDoc(classRef);
    manageStudents(classId, classDoc.data().name);
} catch (error) {
    alert('Lá»—i thÃªm há»c sinh: ' + error.message);
}
showLoading(false);
}
window.showAssignments = async function() {
    showLoading(true);
    try {
        const classesRef = collection(db, 'classes');
        const allClassesSnap = await getDocs(classesRef);
        
        let html = '<h2 class="text-2xl font-bold mb-4">Giao bÃ i táº­p</h2><div class="space-y-4">';
        
        allClassesSnap.forEach(doc => {
            const data = doc.data();
            // âœ… Kiá»ƒm tra teacherIds thay vÃ¬ teacherCode
            if (data.teacherIds && data.teacherIds.includes(currentUser.id)) {
                html += `
                    <div class="border rounded-lg p-4 bg-white shadow hover:shadow-lg transition">
                        <h3 class="text-xl font-bold mb-2">${data.name}</h3>
                        <button onclick="createAssignment('${doc.id}', '${data.name}')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                            â• Táº¡o bÃ i táº­p má»›i
                        </button>
                        <button onclick="viewClassAssignments('${doc.id}', '${data.name}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded ml-2">
                            ğŸ“‹ Xem bÃ i táº­p Ä‘Ã£ giao
                        </button>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i táº£i danh sÃ¡ch lá»›p: ' + error.message);
    }
    showLoading(false);
}

window.createAssignment = async function(classId, className) {
    // Táº£i danh sÃ¡ch bá»™ tháº» cÃ³ sáºµn
    showLoading(true);
    const decksRef = collection(db, 'decks');
    const decksSnap = await getDocs(decksRef);
    showLoading(false);
    
    let deckOptions = '<option value="">-- Chá»n bá»™ tháº» cÃ³ sáºµn --</option>';
    decksSnap.forEach(doc => {
        const deck = doc.data();
        const wordCount = deck.wordsData ? deck.wordsData.length : 0;
        deckOptions += `<option value="${doc.id}">${deck.name} (${wordCount} tá»« - by ${deck.createdByName})</option>`;
    });
    
    document.getElementById('teacherContent').innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Táº¡o bÃ i táº­p cho ${className}</h2>
        <button onclick="showAssignments()" class="text-blue-600 mb-4">â† Quay láº¡i</button>
        
        <!-- PHáº¦N CHá»ŒN Bá»˜ THáºº CÃ“ Sáº´N -->
        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 mb-6">
            <h3 class="font-bold text-lg mb-4">ğŸ“š Chá»n tá»« thÆ° viá»‡n cÃ³ sáºµn</h3>
            <select id="selectDeck" onchange="loadDeckWords()" class="w-full p-3 border rounded-lg mb-3">
                ${deckOptions}
            </select>
            <p class="text-sm text-gray-600">ğŸ’¡ Chá»n bá»™ tháº» cÃ³ sáºµn Ä‘á»ƒ tiáº¿t kiá»‡m thá»i gian</p>
        </div>
        
        <div class="text-center my-6">
            <span class="text-gray-500 font-semibold">--- HOáº¶C Táº O Má»šI ---</span>
        </div>
        
        <!-- PHáº¦N Táº O Má»šI -->
        <div class="bg-white border-2 border-gray-200 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">âœï¸ Táº¡o bá»™ tháº» má»›i</h3>
            
            <input type="text" id="assignmentName" placeholder="TÃªn bÃ i (vd: Week 1 - Unit 1)" class="w-full p-3 border rounded-lg mb-4">
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <h4 class="font-bold mb-2">ğŸ“ HÆ°á»›ng dáº«n nháº­p tá»« vá»±ng:</h4>
                <p class="text-sm text-gray-700 mb-2">Má»—i dÃ²ng 1 tá»« (tá»‘i Ä‘a 20 tá»«):</p>
                <div class="bg-white p-3 rounded font-mono text-sm space-y-1">
                    <div>fibre</div>
                    <div>carbohydrate</div>
                    <div>protein</div>
                    <div>vitamin</div>
                </div>
            </div>
            
            <textarea id="assignmentWords" placeholder="Nháº­p tá»« vá»±ng (tá»‘i Ä‘a 20 tá»«)
VÃ­ dá»¥:
fibre
protein
carbohydrate
vitamin
healthy
exercise" rows="12" class="w-full p-3 border rounded-lg mb-4 font-mono"></textarea>
            
            <div class="flex items-center gap-3 mb-4">
                <input type="checkbox" id="saveToLibrary" class="w-5 h-5">
                <label for="saveToLibrary" class="font-semibold text-gray-700">
                    ğŸ’¾ LÆ°u vÃ o thÆ° viá»‡n chung Ä‘á»ƒ giÃ¡o viÃªn khÃ¡c dÃ¹ng
                </label>
            </div>
            
            <button onclick="saveAssignment('${classId}')" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold w-full">
                ğŸ’¾ LÆ°u vÃ  giao bÃ i
            </button>
        </div>
    `;
}

// HÃ m load tá»« bá»™ tháº» cÃ³ sáºµn vÃ o textarea
window.loadDeckWords = async function() {
    const deckId = document.getElementById('selectDeck').value;
    if (!deckId) return;
    
    showLoading(true);
    try {
        const deckDoc = await getDoc(doc(db, 'decks', deckId));
        const deck = deckDoc.data();
        
        // Äiá»n tÃªn bÃ i
        document.getElementById('assignmentName').value = deck.name;
        
        // Äiá»n tá»« vá»±ng
        const words = deck.wordsData.map(w => w.word).join('\n');
        document.getElementById('assignmentWords').value = words;
        
        // Tá»± Ä‘á»™ng uncheck "lÆ°u vÃ o thÆ° viá»‡n" vÃ¬ Ä‘Ã£ cÃ³ sáºµn
        document.getElementById('saveToLibrary').checked = false;
        
        alert(`âœ… ÄÃ£ táº£i ${deck.wordsData.length} tá»« tá»« bá»™ "${deck.name}"`);
    } catch (error) {
        alert('Lá»—i táº£i bá»™ tháº»: ' + error.message);
    }
    showLoading(false);
}

window.saveAssignment = async function(classId) {
    const name = document.getElementById('assignmentName').value.trim();
    const wordsText = document.getElementById('assignmentWords').value.trim();
    const saveToLibrary = document.getElementById('saveToLibrary').checked;
    
    if (!name || !wordsText) return alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin');

    const lines = wordsText.split('\n')
        .map(w => w.trim())
        .filter(Boolean)
        .slice(0, 20);

    if (lines.length === 0) return alert('Vui lÃ²ng nháº­p Ã­t nháº¥t 1 tá»«');

    const wordsData = lines.map(word => ({
        word: word,
        syllables: null
    }));

    showLoading(true);
    try {
        // 1. LÆ¯U VÃ€O THÆ¯ VIá»†N (náº¿u check)
        if (saveToLibrary) {
            await addDoc(collection(db, 'decks'), {
                name,
                wordsData,
                createdBy: currentUser.id,
                createdByName: currentUser.name || currentUser.username,
                createdAt: new Date()
            });
        }
        
        // 2. GIAO BÃ€I CHO Lá»šP
        await addDoc(collection(db, 'assignments'), {
            name,
            wordsData,
            classId,
            teacherId: currentUser.id,
            createdAt: new Date()
        });
        
        const msg = saveToLibrary 
            ? `âœ… ÄÃ£ giao bÃ i "${name}" (${wordsData.length} tá»«) vÃ  lÆ°u vÃ o thÆ° viá»‡n chung!`
            : `âœ… ÄÃ£ giao bÃ i "${name}" (${wordsData.length} tá»«)!`;
        
        alert(msg);
        showAssignments();
    } catch (error) {
        alert('Lá»—i lÆ°u bÃ i táº­p: ' + error.message);
    }
    showLoading(false);
}

window.viewStats = async function(classId, className) {
showLoading(true);
try {
    const assignmentsRef = collection(db, 'assignments');
    const qAssign = query(assignmentsRef, where('classId', '==', classId));
    const assignSnap = await getDocs(qAssign);
   
    const classDoc = await getDoc(doc(db, 'classes', classId));
    const studentIds = classDoc.data().students || [];
   
    let html = `
        <h2 class="text-2xl font-bold mb-4">Thá»‘ng kÃª lá»›p ${className}</h2>
        <button onclick="showMyClasses()" class="text-blue-600 mb-4">â† Quay láº¡i</button>
    `;
   
    if (assignSnap.empty) {
        html += '<p class="text-gray-600">ChÆ°a cÃ³ bÃ i táº­p nÃ o Ä‘Æ°á»£c giao.</p>';
    } else {
        for (const assignDoc of assignSnap.docs) {
            const assign = assignDoc.data();
           
            const wordCount = assign.wordsData ? assign.wordsData.length : (assign.words || []).length;
           
            html += `<div class="border rounded-lg p-4 mb-4">
                <h3 class="text-xl font-bold mb-2">${assign.name}</h3>
                <p class="text-gray-600 mb-3">Sá»‘ tá»«: ${wordCount}</p>
                <div class="space-y-2">
            `;
           
            for (const stId of studentIds) {
                try {
                    const stDoc = await getDoc(doc(db, 'students', stId));
                    if (!stDoc.exists()) continue;
                   
                    const student = stDoc.data();
                   
                    const resultsRef = collection(db, 'results');
                    const qResults = query(resultsRef,
                        where('studentId', '==', stId),
                        where('assignmentId', '==', assignDoc.id)
                    );
                    const resultsSnap = await getDocs(qResults);
                   
                    let completed = 0;
                    let totalScore = 0;
                    let attempts = 0;
                   
                    resultsSnap.forEach(rDoc => {
                        const r = rDoc.data();
                        if (r.score >= 60) completed++;
                        totalScore += r.score;
                        attempts++;
                    });
                   
                    const avgScore = attempts > 0 ? Math.round(totalScore / attempts) : 0;
                    const progress = wordCount > 0 ? Math.round((completed / wordCount) * 100) : 0;
                   
                    html += `
                        <div class="bg-gray-50 p-3 rounded flex justify-between items-center">
                            <span class="font-semibold">${student.name}</span>
                            <div class="text-sm text-gray-600">
                                <span class="mr-3">Tiáº¿n Ä‘á»™: ${progress}%</span>
                                <span class="mr-3">Äiá»ƒm TB: ${avgScore}</span>
                                <span>ÄÃ£ luyá»‡n: ${attempts} láº§n</span>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Lá»—i táº£i thá»‘ng kÃª:', error);
                }
            }
           
            html += '</div></div>';
        }
    }
   
    document.getElementById('teacherContent').innerHTML = html;
} catch (error) {
    alert('Lá»—i táº£i thá»‘ng kÃª: ' + error.message);
}
showLoading(false);
}

window.viewClassAssignments = async function(classId, className) {
    showLoading(true);
    try {
        const assignmentsRef = collection(db, 'assignments');
        const q = query(assignmentsRef, where('classId', '==', classId));
        const assignSnap = await getDocs(q);
        
        let html = `
            <h2 class="text-2xl font-bold mb-4">ğŸ“‹ BÃ i táº­p Ä‘Ã£ giao - ${className}</h2>
            <button onclick="showAssignments()" class="text-blue-600 mb-4 hover:underline">â† Quay láº¡i</button>
        `;
        
        if (assignSnap.empty) {
            html += '<p class="text-gray-600 bg-gray-50 p-6 rounded-lg text-center">ChÆ°a cÃ³ bÃ i táº­p nÃ o Ä‘Æ°á»£c giao cho lá»›p nÃ y.</p>';
        } else {
            html += '<div class="space-y-4">';
            
            assignSnap.forEach(doc => {
                const assign = doc.data();
                const wordCount = assign.wordsData ? assign.wordsData.length : (assign.words || []).length;
                
                // âœ… Láº¤Y DANH SÃCH Tá»ª
                let wordsList = '';
                if (assign.wordsData) {
                    wordsList = assign.wordsData.map((w, idx) => 
                        `<span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold m-1">${idx + 1}. ${w.word}</span>`
                    ).join('');
                } else if (assign.words) {
                    wordsList = assign.words.map((w, idx) => 
                        `<span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold m-1">${idx + 1}. ${w}</span>`
                    ).join('');
                }
                
                html += `
                    <div class="bg-white border-2 border-blue-200 rounded-lg p-6 shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold mb-2">${assign.name}</h3>
                                <p class="text-sm text-gray-600 mb-1">ğŸ“ Sá»‘ tá»«: ${wordCount}</p>
                                <p class="text-xs text-gray-500">ğŸ•’ NgÃ y táº¡o: ${assign.createdAt?.toDate().toLocaleDateString('vi-VN') || 'N/A'}</p>
                            </div>
                            <button onclick="deleteAssignment('${doc.id}', '${assign.name}', '${classId}', '${className}')" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm">
                                ğŸ—‘ï¸ XÃ³a
                            </button>
                        </div>
                        
                        <!-- âœ… HIá»‚N THá»Š DANH SÃCH Tá»ª -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="font-semibold mb-3 text-gray-700">ğŸ“š Danh sÃ¡ch tá»« vá»±ng:</p>
                            <div class="flex flex-wrap gap-2">
                                ${wordsList || '<p class="text-gray-500">KhÃ´ng cÃ³ tá»« vá»±ng</p>'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}
// ThÃªm hÃ m xÃ³a bÃ i táº­p
window.deleteAssignment = async function(assignmentId, assignmentName, classId, className) {
    if (!confirm(`XÃ³a bÃ i táº­p "${assignmentName}"? Táº¥t cáº£ káº¿t quáº£ há»c sinh sáº½ bá»‹ xÃ³a!`)) return;
    
    showLoading(true);
    try {
        // XÃ³a táº¥t cáº£ results liÃªn quan
        const resultsRef = collection(db, 'results');
        const qResults = query(resultsRef, where('assignmentId', '==', assignmentId));
        const resultsSnap = await getDocs(qResults);
        
        resultsSnap.forEach(async (doc) => {
            await deleteDoc(doc.ref);
        });
        
        // XÃ³a assignment
        await deleteDoc(doc(db, 'assignments', assignmentId));
        
        alert('ÄÃ£ xÃ³a bÃ i táº­p!');
        viewClassAssignments(classId, className);
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// ThÃªm SAU hÃ m deleteAssignment (sau dÃ²ng 1609)

window.manageLibrary = async function() {
    showLoading(true);
    try {
        const decksRef = collection(db, 'decks');
        const decksSnap = await getDocs(decksRef);
        
        let html = `
            <h2 class="text-2xl font-bold mb-4">ğŸ“– ThÆ° viá»‡n bá»™ tháº» chung</h2>
            <button onclick="showMyClasses()" class="text-blue-600 mb-4 hover:underline">â† Quay láº¡i</button>
            
            <p class="text-gray-600 mb-6">ÄÃ¢y lÃ  thÆ° viá»‡n bá»™ tháº» do cÃ¡c giÃ¡o viÃªn chia sáº». Báº¡n cÃ³ thá»ƒ dÃ¹ng láº¡i khi táº¡o bÃ i táº­p.</p>
        `;
        
        if (decksSnap.empty) {
            html += '<p class="text-gray-500 text-center py-12">ChÆ°a cÃ³ bá»™ tháº» nÃ o trong thÆ° viá»‡n</p>';
        } else {
            html += '<div class="grid md:grid-cols-2 gap-4">';
            
            decksSnap.forEach(doc => {
                const deck = doc.data();
                const wordCount = deck.wordsData ? deck.wordsData.length : 0;
                const isOwner = deck.createdBy === currentUser.id;
                
                html += `
                    <div class="bg-white border-2 border-blue-200 rounded-lg p-5 shadow hover:shadow-lg transition">
                        <h3 class="text-xl font-bold mb-2">${deck.name}</h3>
                        <p class="text-sm text-gray-600 mb-1">ğŸ“ Sá»‘ tá»«: ${wordCount}</p>
                        <p class="text-sm text-gray-600 mb-1">ğŸ‘¤ Táº¡o bá»Ÿi: ${deck.createdByName}</p>
                        <p class="text-xs text-gray-500">ğŸ•’ ${deck.createdAt?.toDate().toLocaleDateString('vi-VN') || 'N/A'}</p>
                        
                        <div class="flex gap-2 mt-4">
                            <button onclick="viewDeckWords('${doc.id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                                ğŸ‘ï¸ Xem tá»«
                            </button>
                            ${isOwner ? `
                                <button onclick="deleteDeck('${doc.id}', '${deck.name}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm">
                                    ğŸ—‘ï¸ XÃ³a
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        document.getElementById('teacherContent').innerHTML = html;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.viewDeckWords = async function(deckId) {
    showLoading(true);
    try {
        const deckDoc = await getDoc(doc(db, 'decks', deckId));
        const deck = deckDoc.data();
        
        let wordsList = deck.wordsData.map((w, idx) => `
            <div class="bg-gray-50 p-3 rounded flex items-center gap-3">
                <span class="font-bold text-gray-500">${idx + 1}.</span>
                <span class="font-mono text-lg">${w.word}</span>
                <button onclick="speakWord('${w.word}', 1)" class="ml-auto bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                    ğŸ”Š Nghe
                </button>
            </div>
        `).join('');
        
        document.getElementById('teacherContent').innerHTML = `
            <h2 class="text-2xl font-bold mb-4">ğŸ‘ï¸ ${deck.name}</h2>
            <button onclick="manageLibrary()" class="text-blue-600 mb-4 hover:underline">â† Quay láº¡i thÆ° viá»‡n</button>
            
            <div class="bg-white border rounded-lg p-6">
                <p class="text-gray-600 mb-4">ğŸ“ ${deck.wordsData.length} tá»« vá»±ng:</p>
                <div class="space-y-2">
                    ${wordsList}
                </div>
            </div>
        `;
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

window.deleteDeck = async function(deckId, deckName) {
    if (!confirm(`XÃ³a bá»™ tháº» "${deckName}" khá»i thÆ° viá»‡n?`)) return;
    
    showLoading(true);
    try {
        await deleteDoc(doc(db, 'decks', deckId));
        alert('ÄÃ£ xÃ³a bá»™ tháº»!');
        manageLibrary();
    } catch (error) {
        alert('Lá»—i: ' + error.message);
    }
    showLoading(false);
}

// ==================== STUDENT FUNCTIONS ====================
// (Pháº§n code student tiáº¿p tá»¥c á»Ÿ Ä‘Ã¢y...)
// ==================== STUDENT FUNCTIONS ====================
window.loadStudentAssignments = async function() {
showLoading(true);
try {
    const student = currentUser;
    const classId = student.classId;
   
    const assignmentsRef = collection(db, 'assignments');
    const q = query(assignmentsRef, where('classId', '==', classId));
    const snap = await getDocs(q);
   
    let html = '';
   
    if (snap.empty) {
        html = '<p class="text-gray-600 text-center py-12 text-lg">ChÆ°a cÃ³ bÃ i táº­p nÃ o Ä‘Æ°á»£c giao.</p>';
    } else {
        for (const doc of snap.docs) {
            const assign = doc.data();
            const wordCount = assign.wordsData ? assign.wordsData.length : (assign.words || []).length;
           
            const resultsRef = collection(db, 'results');
            const qResults = query(resultsRef,
                where('studentId', '==', student.id),
                where('assignmentId', '==', doc.id)
            );
            const resultsSnap = await getDocs(qResults);
           
            let completed = 0;
            let totalScore = 0;
           
            resultsSnap.forEach(rDoc => {
                const r = rDoc.data();
                if (r.score >= 60) completed++;
                totalScore += r.score;
            });
           
            const progress = wordCount > 0 ? Math.round((completed / wordCount) * 100) : 0;
            const avgScore = resultsSnap.size > 0 ? Math.round(totalScore / resultsSnap.size) : 0;
           
            html += `
                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-2xl transition cursor-pointer" onclick="startPractice('${doc.id}')">
                    <h3 class="text-2xl font-bold mb-3">${assign.name}</h3>
                    <div class="space-y-2 text-gray-600">
                        <p>ğŸ“ Sá»‘ tá»«: ${wordCount}</p>
                        <p>âœ… HoÃ n thÃ nh: ${progress}%</p>
                        <p>â­ Äiá»ƒm TB: ${avgScore}</p>
                    </div>
                    <button class="mt-4 w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition">
                        ğŸš€ Báº¯t Ä‘áº§u luyá»‡n táº­p
                    </button>
                </div>
            `;
        }
    }
   
    document.getElementById('studentAssignments').innerHTML = html;
} catch (error) {
    alert('Lá»—i táº£i bÃ i táº­p: ' + error.message);
    document.getElementById('studentAssignments').innerHTML = '<p class="text-red-600 text-center py-12">Lá»—i táº£i bÃ i táº­p</p>';
}
showLoading(false);
}
window.startPractice = async function(assignmentId) {
showLoading(true);
try {
    const assignDoc = await getDoc(doc(db, 'assignments', assignmentId));
    const assign = assignDoc.data();
   
    currentAssignment = { id: assignmentId, ...assign };
   
    document.getElementById('assignmentTitle').textContent = assign.name;
   
    let wordsData = [];
    if (assign.wordsData) {
        wordsData = assign.wordsData;
    } else if (assign.words) {
        wordsData = assign.words.map(w => ({
            word: w,
            syllables: null
        }));
    }
   
    let html = `
    <div class="flex items-center gap-3 mb-6">
        <button onclick="backToStudent()" class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl transition-all shadow-lg font-bold">
            <span class="text-2xl">â†</span>
            <span>Quay láº¡i danh sÃ¡ch bÃ i</span>
        </button>
        <div class="text-gray-600">
            <span class="font-semibold">BÃ i:</span> ${currentAssignment.name}
        </div>
    </div>
`;

    for (const data of wordsData) {
        const word = data.word;
        const syllables = data.syllables || splitIntoSyllables(word);
       
        const syllableDisplay = syllables.map((s, idx) => {
    return `<span class="inline-block bg-green-100 text-green-800 px-3 py-2 rounded-full mx-1 font-bold text-lg">
        ${s}
    </span>`;
}).join('');
       
    html += `
    <div class="bg-white rounded-2xl shadow-xl p-8 text-center border-2 border-green-200 hover:border-green-400 transition hover:shadow-2xl max-w-2xl mx-auto mb-6">
               <h3 class="text-5xl font-bold mb-4 text-gray-800" style="font-family: 'Quicksand', 'Comic Sans MS', 'Rounded', sans-serif;">${word}</h3>
               
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <p class="text-sm text-gray-600 mb-3">ğŸ” Ã‚m tiáº¿t:</p>
                    <div class="flex flex-wrap justify-center gap-2">
                        ${syllableDisplay}
                    </div>
                </div>
               
                <div class="flex gap-2 mb-6 justify-center">
                    <button onclick="speakWord('${word}', 0.1)" class="bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-white px-4 py-3 rounded-xl font-semibold shadow-lg transition">
    ğŸ¢ Ráº¥t cháº­m
</button>
<button onclick="speakWord('${word}', 0.3)" class="bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white px-4 py-3 rounded-xl font-semibold shadow-lg transition">
    ğŸŒ™ Cháº­m
</button>
<button onclick="speakWord('${word}', 1)" class="bg-gradient-to-r from-green-500 to-lime-500 hover:from-green-600 hover:to-lime-600 text-white px-4 py-3 rounded-xl font-semibold shadow-lg transition">
    â–¶ï¸ BÃ¬nh thÆ°á»ng
</button>
                </div>
               
                <button onclick="recordWord('${word}')" class="bg-gradient-to-r from-green-600 via-lime-500 to-green-700 hover:from-green-700 hover:via-lime-600 hover:to-green-800 text-white px-8 py-4 rounded-2xl font-bold text-xl w-full shadow-2xl transform hover:scale-105 transition-all duration-200">
                    ğŸ¤ Báº®T Äáº¦U THU Ã‚M
                </button>
               
               <div id="result-${word}" class="mt-6 max-h-96 overflow-y-auto"></div>
            </div>
        `;
    }
   
    document.getElementById('wordsList').innerHTML = html;
    updateProgress();
    showScreen('practiceScreen');
} catch (error) {
    alert('Lá»—i táº£i bÃ i táº­p: ' + error.message);
}
showLoading(false);
}
window.updateProgress = async function() {
if (!currentAssignment) return;
try {
    const resultsRef = collection(db, 'results');
    const q = query(resultsRef,
        where('studentId', '==', currentUser.id),
        where('assignmentId', '==', currentAssignment.id)
    );
    const snap = await getDocs(q);
    
    let completed = 0;
    let totalScore = 0;
    
    snap.forEach(doc => {
        const r = doc.data();
        if (r.score >= 60) completed++;
        totalScore += r.score;
    });
    
    const avgScore = snap.size > 0 ? Math.round(totalScore / snap.size) : 0;
    const totalWords = currentAssignment.wordsData ? currentAssignment.wordsData.length : (currentAssignment.words || []).length;
    
    document.getElementById('progressText').textContent = `${completed}/${totalWords}`;
    document.getElementById('avgScoreText').textContent = avgScore;
} catch (error) {
    console.error('Lá»—i cáº­p nháº­t tiáº¿n Ä‘á»™:', error);
}
}
window.backToStudent = function() {
currentAssignment = null;
showScreen('studentDashboard');
loadStudentAssignments();
}
</script>
</body>
</html>







