<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lime Phát Âm - Hệ Thống Luyện Phát Âm</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"> <!-- Bootstrap cho UI đẹp -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.0.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.0.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.0.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.0.0/firebase-storage-compat.min.js"></script>
    <style>
        body { background: #f0f8ff; }
        .container { max-width: 800px; margin: auto; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background: white; }
        .word { font-size: 24px; font-weight: bold; }
        .feedback { color: #2196F3; font-style: italic; }
        .error { color: red; }
        .success { color: green; }
        .motivation { background: #FFEB3B; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-presets="env,react">
        const firebaseConfig = {
            apiKey: "AIzaSyB2VOZ0A5im13MC6FNLa4bEupKedm5iiBo",
            authDomain: "lime-phat-am.firebaseapp.com",
            projectId: "lime-phat-am",
            storageBucket: "lime-phat-am.firebasestorage.app",
            messagingSenderId: "434295865710",
            appId: "1:434295865710:web:5f373900f5e8c1d679417f",
            measurementId: "G-K1PHBV3HMY"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        const auth = firebase.auth(app);
        const storage = firebase.storage(app);

        const HF_TOKEN = "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";
        const HF_MODEL = "openai/whisper-large-v3";

        function getSyllables(word) {
            return word.split(/[^aeiouy]+/i).filter(s => s);
        }

        async function analyzePronunciation(audioBlob, targetText) {
            const formData = new FormData();
            formData.append("file", audioBlob, "audio.wav");
            const response = await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${HF_TOKEN}` },
                body: formData
            });
            const result = await response.json();
            const transcript = result.text || "";
            const distance = levenshteinDistance(transcript.toLowerCase(), targetText.toLowerCase());
            const score = Math.max(0, 100 - (distance / targetText.length) * 100);
            const targetSyls = getSyllables(targetText);
            const transSyls = getSyllables(transcript);
            const wrongSyls = targetSyls.map((syl, i) => transSyls[i] !== syl ? syl : null).filter(Boolean);
            return { transcript, score, wrongSyls };
        }

        function levenshteinDistance(s, t) {
            if (!s.length) return t.length;
            if (!t.length) return s.length;
            const arr = [];
            for (let i = 0; i <= t.length; i++) {
                arr[i] = [i];
                for (let j = 1; j <= s.length; j++) {
                    arr[i][j] = i === 0 ? j : Math.min(
                        arr[i - 1][j] + 1,
                        arr[i][j - 1] + 1,
                        arr[i - 1][j - 1] + (s[j - 1] === t[i - 1] ? 0 : 1)
                    );
                }
            }
            return arr[t.length][s.length];
        }

        const motivations = [
            "Cố lên! Bạn đã cải thiện rồi đấy!",
            "Gần đúng lắm! Thử lại xem sao.",
            "Tuyệt vời! Điểm số đang tăng lên.",
            "Bạn thật kiên trì! Tiếp tục nhé.",
            "Đã tốt hơn lần trước 10% rồi!"
        ];

        class App extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    userType: null,
                    userId: '',
                    password: '',
                    classId: '',
                    classes: [],
                    students: [],
                    assignments: [],
                    currentAssignment: [],
                    stats: {},
                    progress: [],
                    recording: false,
                    audio: null,
                    score: null,
                    feedback: '',
                    motivation: '',
                    attempts: 0,
                    bestScore: 0,
                    slowMode: false,
                    voice: 'en-US',
                    error: '',
                    loading: false // Thêm loading state
                };
                this.recorder = null;
            }

            componentDidMount() {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.setState({ userType: 'teacher', userId: user.uid });
                        this.loadClasses(user.uid);
                    }
                });
            }

            login = async (type) => {
                this.setState({ loading: true, error: '' });
                const { userId, password } = this.state;
                try {
                    if (type === 'teacher') {
                        if (!userId || !password) {
                            throw new Error('Vui lòng nhập email và mật khẩu');
                        }
                        await auth.signInWithEmailAndPassword(userId, password);
                    } else {
                        const studentRef = db.collection('students').where('code', '==', userId);
                        const snapshot = await studentRef.get();
                        const student = snapshot.docs[0]?.data();
                        if (student) {
                            this.setState({ userType: 'student', userId: student.code, classId: student.classId });
                            await this.loadAssignments(student.classId);
                            await this.loadProgress(student.code);
                        } else {
                            throw new Error('Mã học sinh không tồn tại');
                        }
                    }
                } catch (err) {
                    this.setState({ error: 'Đăng nhập thất bại: ' + err.message });
                } finally {
                    this.setState({ loading: false });
                }
            }

            logout = () => {
                auth.signOut();
                this.setState({ userType: null, userId: '', password: '', classId: '', classes: [], students: [], assignments: [], currentAssignment: [], stats: {}, progress: [], loading: false });
            }

            loadClasses = async (teacherId) => {
                this.setState({ loading: true });
                const classesRef = db.collection('classes').where('teacherId', '==', teacherId);
                const snapshot = await classesRef.get();
                const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.setState({ classes, loading: false });
            }

            createClass = async (name) => {
                this.setState({ loading: true });
                await db.collection('classes').add({ name, teacherId: this.state.userId, students: [] });
                this.loadClasses(this.state.userId);
                this.setState({ loading: false });
            }

            addStudent = async (classId, name, code) => {
                this.setState({ loading: true });
                await db.collection('students').add({ name, code, classId });
                await db.collection('classes').doc(classId).update({
                    students: firebase.firestore.FieldValue.arrayUnion({ name, code })
                });
                this.loadStudents(classId);
                this.setState({ loading: false });
            }

            loadStudents = async (classId) => {
                this.setState({ loading: true });
                const classDoc = await db.collection('classes').doc(classId).get();
                this.setState({ students: classDoc.data().students || [], loading: false });
            }

            assignWords = async (classId, words) => {
                this.setState({ loading: true });
                await db.collection('assignments').add({ classId, words: words.split(','), week: new Date().toISOString().slice(0,10) });
                this.loadAssignments(classId);
                this.setState({ loading: false });
            }

            loadAssignments = async (classId) => {
                this.setState({ loading: true });
                const assignsRef = db.collection('assignments').where('classId', '==', classId);
                const snapshot = await assignsRef.get();
                const assignments = snapshot.docs.map(doc => doc.data().words);
                this.setState({ assignments, currentAssignment: assignments[assignments.length - 1] || [], loading: false });
            }

            loadProgress = async (studentId) => {
                this.setState({ loading: true });
                const progressRef = db.collection('progress').where('studentId', '==', studentId);
                const snapshot = await progressRef.get();
                const progress = snapshot.docs.map(doc => doc.data());
                this.setState({ progress });
                this.calculateStats();
                this.setState({ loading: false });
            }

            startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.recorder = new MediaRecorder(stream);
                    this.recorder.start();
                    this.setState({ recording: true });
                    this.recorder.ondataavailable = e => this.setState({ audio: e.data });
                } catch (err) {
                    this.setState({ error: 'Không thể ghi âm: ' + err.message });
                }
            }

            stopRecording = (word) => {
                this.recorder.stop();
                this.setState({ recording: false });
                setTimeout(() => this.processAudio(word), 500);
            }

            processAudio = async (word) => {
                const { audio, attempts, bestScore } = this.state;
                if (audio) {
                    const analysis = await analyzePronunciation(audio, word);
                    const newScore = analysis.score;
                    const newBest = Math.max(bestScore, newScore);
                    const motivation = motivations[Math.floor(Math.random() * motivations.length)] + 
                        (newScore > bestScore ? ` Điểm tăng ${newScore - bestScore}%!` : '');
                    const wrongSyls = analysis.wrongSyls.join(', ');
                    const feedback = wrongSyls ? `Sai ở syllables: ${wrongSyls}. Thử luyện lại!` : 'Hoàn hảo!';

                    await db.collection('progress').add({
                        studentId: this.state.userId,
                        word,
                        score: newBest,
                        attempts: attempts + 1,
                        timestamp: new Date()
                    });

                    this.setState({
                        score: newScore,
                        bestScore: newBest,
                        feedback,
                        motivation,
                        attempts: attempts + 1
                    });
                    this.loadProgress(this.state.userId);
                }
            }

            playAudio = (text, slow = false) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = this.state.voice;
                utterance.rate = slow ? 0.6 : 1.0;
                speechSynthesis.speak(utterance);
            }

            calculateStats = () => {
                const { progress, currentAssignment } = this.state;
                const progressLength = progress.length;
                const assignmentLength = currentAssignment.length;
                const completed = assignmentLength > 0 ? (progressLength / assignmentLength * 100).toFixed(2) + '%' : '0%';

                const avgScore = progressLength > 0 ? (progress.reduce((sum, p) => sum + p.score, 0) / progressLength).toFixed(2) : 0;

                const attemptsPerWord = {};
                progress.forEach(p => attemptsPerWord[p.word] = (attemptsPerWord[p.word] || 0) + 1);
                const attemptsKeysLength = Object.keys(attemptsPerWord).length;
                const attempts = attemptsKeysLength > 0 ? (Object.values(attemptsPerWord).reduce((a, b) => a + b, 0) / attemptsKeysLength).toFixed(1) : 0;

                const worstWord = progress.filter(p => p.score < 60).map(p => p.word)[0] || 'Không có';

                const thisWeek = progress.filter(p => new Date(p.timestamp).getWeek() === new Date().getWeek());
                const lastWeek = progress.filter(p => new Date(p.timestamp).getWeek() === new Date().getWeek() - 1);
                const thisAvg = thisWeek.length > 0 ? thisWeek.reduce((sum, p) => sum + p.score, 0) / thisWeek.length : 0;
                const lastAvg = lastWeek.length > 0 ? lastWeek.reduce((sum, p) => sum + p.score, 0) / lastWeek.length : 0;
                const progressDiff = (thisAvg - lastAvg).toFixed(2);

                this.setState({
                    stats: {
                        completed,
                        avgScore,
                        attempts,
                        worstWord,
                        progressDiff: isNaN(progressDiff) ? 0 : progressDiff
                    }
                });
            }

            loadClassStats = async (classId) => {
                this.setState({ loading: true });
                const students = this.state.students;
                const progresses = await Promise.all(students.map(async s => {
                    const progressRef = db.collection('progress').where('studentId', '==', s.code);
                    const snapshot = await progressRef.get();
                    return snapshot.docs.map(doc => doc.data());
                }));
                const completedPercent = students.length > 0 ? (progresses.filter(p => p.length >= 20).length / students.length * 100).toFixed(2) + '%' : '0%';
                const classAvg = progresses.length > 0 ? (progresses.reduce((sum, ps) => sum + (ps.length > 0 ? ps.reduce((s, p) => s + p.score, 0) / ps.length : 0), 0) / progresses.length).toFixed(2) : 0;
                const top5 = students.map(s => {
                    const ps = progresses.find((p, i) => students[i].code === s.code) || [];
                    const avg = ps.length > 0 ? ps.reduce((sum, p) => sum + p.score, 0) / ps.length : 0;
                    return { ...s, avg };
                }).sort((a, b) => b.avg - a.avg).slice(0,5).map(s => s.name);
                const commonWorst = {};
                progresses.forEach(ps => ps.filter(p => p.score < 60).forEach(p => commonWorst[p.word] = (commonWorst[p.word] || 0) + 1));
                const worstWords = Object.keys(commonWorst).sort((a,b) => commonWorst[b] - commonWorst[a]).slice(0,5);

                this.setState({
                    stats: {
                        classCompleted: completedPercent,
                        classAvg,
                        top5,
                        worstWords
                    },
                    loading: false
                });
            }

            renderLogin() {
                const { userType, userId, password, error, loading } = this.state;
                if (loading) return <div className="container text-center"><p>Đang đăng nhập...</p></div>;
                return (
                    <div className="container">
                        <h1 className="text-center">Đăng Nhập Lime Phát Âm</h1>
                        {error && <p className="error text-center">{error}</p>}
                        <select className="form-select" onChange={e => this.setState({ userType: e.target.value })}>
                            <option>Chọn vai trò</option>
                            <option value="teacher">Giáo viên</option>
                            <option value="student">Học sinh</option>
                        </select>
                        <input className="form-control" placeholder={userType === 'teacher' ? "Email GV (ví dụ: teacher1@example.com)" : "Mã HS"} onChange={e => this.setState({ userId: e.target.value })} />
                        {userType === 'teacher' && (
                            <input className="form-control" type="password" placeholder="Mật khẩu" onChange={e => this.setState({ password: e.target.value })} />
                        )}
                        <button className="btn btn-primary w-100" onClick={() => this.login(userType)}>Đăng nhập</button>
                    </div>
                );
            }

            renderTeacher() {
                const { classes, students, classId, assignments, stats, loading } = this.state;
                if (loading) return <div className="container text-center"><p>Đang tải dữ liệu...</p></div>;
                return (
                    <div className="container">
                        <h1 className="text-center">Trang Giáo Viên</h1>
                        <button className="btn btn-danger" onClick={this.logout}>Đăng xuất</button>
                        <h2>Tạo Lớp</h2>
                        <input className="form-control" id="className" placeholder="Tên lớp (ví dụ: Lớp 6A)" />
                        <button className="btn btn-success" onClick={() => this.createClass(document.getElementById('className').value)}>Tạo</button>
                        
                        <h2>Lớp Học</h2>
                        <select className="form-select" onChange={e => { this.setState({ classId: e.target.value }); this.loadStudents(e.target.value); this.loadAssignments(e.target.value); this.loadClassStats(e.target.value); }}>
                            <option>Chọn lớp</option>
                            {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                        </select>
                        
                        {classId && (
                            <>
                                <h2>Thêm Học Sinh</h2>
                                <input className="form-control" id="studentName" placeholder="Tên HS" />
                                <input className="form-control" id="studentCode" placeholder="Mã HS (ví dụ: HS001)" />
                                <button className="btn btn-success" onClick={() => this.addStudent(classId, document.getElementById('studentName').value, document.getElementById('studentCode').value)}>Thêm</button>
                                
                                <h2>Danh Sách HS</h2>
                                <ul className="list-group">
                                    {students.map(s => <li key={s.code} className="list-group-item">{s.name} ({s.code})</li>)}
                                </ul>
                                
                                <h2>Giao Bài Tập (20 từ, cách nhau dấu phẩy)</h2>
                                <input className="form-control" id="words" placeholder="apple,banana,invitation,..." />
                                <button className="btn btn-success" onClick={() => this.assignWords(classId, document.getElementById('words').value)}>Giao</button>
                                
                                <h2>Bài Tập Đã Giao</h2>
                                <ul className="list-group">
                                    {assignments.map((a, i) => <li key={i} className="list-group-item">{a.join(', ')}</li>)}
                                </ul>
                                
                                <h2>Thống Kê Lớp</h2>
                                <table className="table table-striped">
                                    <tbody>
                                        <tr><th>% Hoàn Thành</th><td>{stats.classCompleted || '0%'}</td></tr>
                                        <tr><th>Điểm TB Lớp</th><td>{stats.classAvg || 0}</td></tr>
                                        <tr><th>Top 5 HS</th><td>{stats.top5?.join(', ') || 'Chưa có'}</td></tr>
                                        <tr><th>Từ Kém Chung</th><td>{stats.worstWords?.join(', ') || 'Chưa có'}</td></tr>
                                    </tbody>
                                </table>
                            </>
                        )}
                    </div>
                );
            }

            renderStudent() {
                const { currentAssignment, recording, score, feedback, motivation, attempts, bestScore, stats, voice, loading } = this.state;
                if (loading) return <div className="container text-center"><p>Đang tải tiến độ...</p></div>;
                return (
                    <div className="container">
                        <h1 className="text-center">Trang Học Sinh</h1>
                        <button className="btn btn-danger" onClick={this.logout}>Đăng xuất</button>
                        <h2>Bài Tập Tuần Này (20 từ)</h2>
                        {currentAssignment.map(word => (
                            <div key={word} className="card mb-3">
                                <div className="card-body">
                                    <p className="word">{word}</p>
                                    <select className="form-select d-inline-block w-auto" onChange={e => this.setState({ voice: e.target.value })}>
                                        <option value="en-US">Giọng Mỹ</option>
                                        <option value="en-GB">Giọng Anh</option>
                                    </select>
                                    <button className="btn btn-info ms-2" onClick={() => this.playAudio(word, false)}>Nghe Bình Thường</button>
                                    <button className="btn btn-info ms-2" onClick={() => this.playAudio(word, true)}>Nghe Chậm</button>
                                    {!recording ? (
                                        <button className="btn btn-primary ms-2" onClick={this.startRecording}>Ghi Âm</button>
                                    ) : (
                                        <button className="btn btn-warning ms-2" onClick={() => this.stopRecording(word)}>Dừng & Chấm</button>
                                    )}
                                    {score !== null && (
                                        <div className="mt-3">
                                            <p className="feedback">Điểm: {score} (Tốt nhất: {bestScore})</p>
                                            <p>{feedback}</p>
                                            <p className="motivation">{motivation}</p>
                                            <p>Số lần luyện: {attempts}</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        
                        <h2>Tiến Độ Cá Nhân</h2>
                        <table className="table table-striped">
                            <tbody>
                                <tr><th>% Hoàn Thành</th><td>{stats.completed || '0%'}</td></tr>
                                <tr><th>Điểm TB</th><td>{stats.avgScore || 0}</td></tr>
                                <tr><th>Số Lần Luyện/Từ</th><td>{stats.attempts || 0}</td></tr>
                                <tr><th>Từ Kém Nhất</th><td>{stats.worstWord || 'Chưa có'}</td></tr>
                                <tr><th>Tiến Độ (vs tuần trước)</th><td>{stats.progressDiff > 0 ? '+' : ''}{stats.progressDiff || 0}%</td></tr>
                            </tbody>
                        </table>
                        
                        <p className="motivation text-center">Kích thích luyện ở nhà: Luyện >5 lần/tuần để nhận badge "Siêu Chăm Chỉ"! Coin: {attempts * 10}</p>
                    </div>
                );
            }

            render() {
                const { userType } = this.state;
                if (!userType) return this.renderLogin();
                if (userType === 'teacher') return this.renderTeacher();
                return this.renderStudent();
            }
        }

        Date.prototype.getWeek = function() {
            const date = new Date(this.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return 1 + Math.round(((date - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
